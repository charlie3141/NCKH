<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ªãch Th·ªß Ng·ªØ - T·ªëi ∆∞u T·ªëc ƒë·ªô</title>
    <style>
        /* === COMPRESSED CSS === */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#333;min-height:100vh;padding:20px}
        .container{max-width:1400px;margin:0 auto;background:white;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden}
        header{background:linear-gradient(to right,#4A00E0,#8E2DE2);color:white;padding:20px;text-align:center}
        h1{font-size:2rem;margin-bottom:5px}
        .dashboard{padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}
        .card{background:white;border-radius:10px;padding:20px;box-shadow:0 3px 10px rgba(0,0,0,0.1);border:1px solid #eaeaea}
        .card h3{color:#4A00E0;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #f0f0f0}
        .calibration-card{background:linear-gradient(135deg,#f5f7fa 0%,#e4e8f0 100%);border:2px solid #e0e6ff}
        .conversion-display,.sentence-display,.current-word-display{font-weight:bold;min-height:60px;display:flex;align-items:center;justify-content:center;border-radius:10px;padding:15px;margin:10px 0;line-height:1.4}
        .conversion-display{font-size:1.5rem;color:#2196F3;background:#E3F2FD;border:2px solid #2196F3}
        .sentence-display{font-size:1.8rem;color:#4CAF50;background:#E8F5E9;border:2px solid #4CAF50;min-height:80px}
        .current-word-display{font-size:2rem;color:#FF5722;background:#FFF8E1;border:2px dashed #FFC107}
        .sensor-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
        .sensor-item{padding:12px;background:#f8f9fa;border-radius:8px;border-left:4px solid}
        .sensor-item.mpu{border-left-color:#2196F3}
        .sensor-item.flex{border-left-color:#4CAF50}
        .sensor-value{font-size:1.8rem;font-weight:bold;color:#333;margin:5px 0}
        .sensor-label{font-size:0.8rem;color:#666;text-transform:uppercase;letter-spacing:1px}
        .flex-box{display:inline-block;width:40px;height:40px;line-height:40px;text-align:center;background:#f8f9fa;border-radius:8px;margin:2px;font-weight:bold}
        .flex-box.active-0{background:#4CAF50;color:white}
        .flex-box.active-1{background:#FF9800;color:white}
        .flex-box.active-2{background:#F44336;color:white}
        .controls{display:flex;gap:10px;margin-top:20px;justify-content:center;flex-wrap:wrap}
        button{padding:12px 24px;border:none;border-radius:8px;background:linear-gradient(to right,#4A00E0,#8E2DE2);color:white;font-weight:bold;cursor:pointer;transition:all 0.2s}
        button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
        button.red{background:linear-gradient(to right,#FF416C,#FF4B2B)}
        button.green{background:linear-gradient(to right,#00b09b,#96c93d)}
        button.blue{background:linear-gradient(to right,#2196F3,#21CBF3)}
        .status-bar{background:#f8f9fa;padding:15px;border-top:1px solid #eaeaea;display:flex;justify-content:space-between;align-items:center}
        .indicator{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px}
        .indicator.online{background:#4CAF50;animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        textarea{width:100%;height:120px;font-size:1.5rem;padding:15px;border:2px solid #4CAF50;border-radius:10px;background:#E8F5E9;color:#333;resize:vertical}
        .calibration-status{margin:15px 0;padding:15px;border-radius:10px;text-align:center;font-weight:bold}
        .calibrating{background:#FFF3CD;border:2px solid #FFC107;color:#856404;animation:pulse 1s infinite}
        .calibrated{background:#D4EDDA;border:2px solid #28A745;color:#155724}
        .calibration-ready{background:#E3F2FD;border:2px solid #2196F3;color:#0d47a1}
        .calibration-display{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:15px 0}
        .sensor-calibration{padding:15px;background:white;border-radius:10px;border:1px solid #eaeaea;text-align:center}
        .performance-info{font-size:0.7rem;color:#888;text-align:center;margin-top:5px}
        .fast-mode{position:fixed;top:10px;right:10px;background:#4CAF50;color:white;padding:5px 10px;border-radius:20px;font-size:0.8rem;z-index:1000}
    </style>
</head>
<body>
    <div class="fast-mode" id="fastModeIndicator">‚ö° T·ªëc ƒë·ªô cao</div>
    <div class="container">
        <header>
            <h1>D·ªãch Th·ªß Ng·ªØ - Phi√™n b·∫£n T·ªëi ∆∞u T·ªëc ƒë·ªô</h1>
            <div>Gi√°m s√°t th·ªùi gian th·ª±c Firebase</div>
            <div class="performance-info" id="performanceInfo">
                ƒê·ªô tr·ªÖ: <span id="latency">--</span>ms | FPS: <span id="fps">--</span> | Polling: <span id="pollingRate">300</span>ms
            </div>
        </header>

        <div class="dashboard">
            <!-- Card X√¢y d·ª±ng C√¢u -->
            <div class="card" id="card1">
                <h3>X√¢y d·ª±ng C√¢u</h3>
                <div style="text-align: center; padding: 20px;">
                    <div class="sensor-label">T·ª™ HI·ªÜN T·∫†I</div>
                    <div class="current-word-display" id="displayBuffer">---</div>
                    <div class="sensor-label">TI·∫æNG VI·ªÜT</div>
                    <div class="conversion-display" id="convertedCurrentWord">---</div>
                    
                    <div class="sensor-label">C√ÇU ƒê·∫¶Y ƒê·ª¶</div>
                    <div class="sentence-display" id="sentenceDisplay">---</div>
                    <div class="sensor-label">C√ÇU D·ªäCH</div>
                    <div class="conversion-display" id="convertedSentenceDisplay">---</div>
                    
                    <div class="word-list" id="wordList">Ch∆∞a c√≥ t·ª´ n√†o</div>
                    <div class="word-count">S·ªë t·ª´: <span id="wordCount">0</span>/10</div>
                    
                    <div class="controls">
                        <button onclick="clearCurrentWord()" class="red">X√≥a t·ª´</button>
                        <button onclick="backspace()">X√≥a k√Ω t·ª±</button>
                        <button onclick="addWordToSentence()" class="green">Th√™m t·ª´</button>
                        <button onclick="commitSentence()" class="blue">Ho√†n th√†nh</button>
                    </div>
                </div>
            </div>

            <!-- Card Calibration -->
            <div class="card calibration-card" id="card2">
                <h3>üéØ Calibration</h3>
                
                <div class="calibration-status" id="calibrationStatus">
                    <div class="calibration-ready">S·∫µn s√†ng</div>
                </div>
                
                <div id="calibrationProgress" style="display: none;">
                    <div style="text-align: center; margin: 10px 0; font-weight: bold; color: #4A00E0;">
                        <div id="calibrationCountdown" style="font-size: 2rem;">10</div>
                        <div id="calibrationMessage">ƒêang calibration...</div>
                    </div>
                    
                    <div class="calibration-display" id="calibrationDisplay"></div>
                    
                    <div style="width:100%;height:20px;background:#f0f0f0;border-radius:10px;overflow:hidden;margin:10px 0">
                        <div id="calibrationProgressBar" style="height:100%;background:linear-gradient(to right,#4CAF50,#45a049);width:0%"></div>
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="startCalibration()" class="green" id="calibrateBtn">B·∫Øt ƒë·∫ßu Calibration</button>
                    <button onclick="resetCalibration()" class="red">Reset</button>
                </div>
            </div>

            <!-- Card D·ªãch thu·∫≠t -->
            <div class="card" id="card3">
                <h3>D·ªãch thu·∫≠t</h3>
                <div style="margin-bottom: 20px;">
                    <div class="sensor-label">VƒÇN B·∫¢N TI·∫æNG VI·ªÜT</div>
                    <textarea id="translationInput" placeholder="Nh·∫≠p vƒÉn b·∫£n ti·∫øng Vi·ªát..."></textarea>
                    
                    <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 10px;">
                        <select id="targetLanguage" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #ccc; width: 100%;">
                            <option value="en-GB">Ti·∫øng Anh</option>
                            <option value="ja-JP">Ti·∫øng Nh·∫≠t</option>
                            <option value="ko-KR">Ti·∫øng H√†n</option>
                            <option value="zh-CN">Ti·∫øng Trung</option>
                        </select>
                    </div>
                </div>

                <div class="sensor-label">K·∫æT QU·∫¢ D·ªäCH</div>
                <div id="translationOutput" class="conversion-display" style="min-height: 80px;">
                    ƒêang ch·ªù d·ªãch...
                </div>

                <div class="controls">
                    <button onclick="translateSentence()" class="blue">D·ªãch c√¢u</button>
                    <button onclick="clearTranslation()" class="red">X√≥a</button>
                </div>
            </div>

            <!-- Card Hi·ªÉn th·ªã C·∫£m bi·∫øn -->
            <div class="card" id="card4">
                <h3>D·ªØ li·ªáu C·∫£m bi·∫øn</h3>
                <div class="sensor-grid">
                    <div class="sensor-item mpu">
                        <div class="sensor-label">MPU6050</div>
                        <div class="sensor-value" id="mpuOrientation">---</div>
                        <div class="sensor-label">ƒêANG L·∫ÆC?</div>
                        <div class="sensor-value" id="isShaking">KH√îNG</div>
                    </div>
                    <div class="sensor-item flex">
                        <div class="sensor-label">C·∫¢M BI·∫æN U·ªêN</div>
                        <div>
                            <div>
                                <span class="flex-box" id="flex0-box">0</span>
                                <span class="flex-box" id="flex1-box">0</span>
                                <span class="flex-box" id="flex2-box">0</span>
                                <span class="flex-box" id="flex3-box">0</span>
                            </div>
                            <div class="sensor-label" style="margin-top: 10px;">
                                Gi√° tr·ªã: <span id="rawValues">0,0,0,0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="controls" style="margin-top: 15px;">
                    <button onclick="refreshData()" class="blue">L√†m m·ªõi</button>
                    <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="green">T·ª± ƒë·ªông: B·∫¨T</button>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div>
                <span class="indicator" id="connectionStatus"></span>
                <span id="statusText">ƒêang k·∫øt n·ªëi...</span>
            </div>
            <div>
                <span id="lastUpdate">C·∫≠p nh·∫≠t: --:--:--</span>
            </div>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH T·ªêC ƒê·ªò CAO ===
        (function() {
            'use strict';
            
            // === BI·∫æN TO√ÄN C·ª§C T·ªêI ∆ØU ===
            const FIREBASE_URL = "https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/sensorData.json";
            
            // Bi·∫øn state - t·ªëi ∆∞u ƒë·ªÉ truy c·∫≠p nhanh
            let state = {
                // Firebase
                firebaseData: null,
                lastUpdateTime: 0,
                autoRefresh: true,
                pollingInterval: 300,
                turboMode: false,
                
                // Sensor
                flexStates: [0, 0, 0, 0],
                bentThresholds: [300, 450, 350, 300],
                straightThresholds: [150, 150, 150, 100],
                
                // Word construction
                slot1: '',
                slot2: '',
                displayBuffer: '',
                sentenceWords: [],
                fullSentence: '',
                convertedFullSentence: '',
                
                // Calibration
                isCalibrating: false,
                calibrationMaxValues: [0, 0, 0, 0],
                calibrationCountdown: 10,
                calibrationInterval: null,
                
                // Performance
                frameCount: 0,
                lastFrameTime: performance.now(),
                currentFPS: 60,
                isFetching: false,
                uiUpdateScheduled: false,
                
                // Cache
                mappingCache: new Map(),
                vietnameseCache: new Map()
            };
            
            // === B·∫¢NG D·ªÆ LI·ªÜU T·ªêI ∆ØU ===
            const tables = {
                A: ["IAY","IC","ICH","IE","IEC","IEM","IEN","IENG","IEO","IEP","IET","IEU","IM","IN","ING","INH","IO","IOI",
                    "ENG","ENH","EO","EP","ET","EU","I","IA","IAC","IAI","IAM","IAN","IANG","IANH","IAO","IAP","IAT","IAU",
                    "AP","AT","AU","AY","E","EC","ECH","EM","EN","A","AC","ACH","AI","AM","AN","ANG","ANH","AO",
                    "IUN","IUONG","IUP","O","OA","OAC","OACH","OAI","OAM","ION","IONG","IOT","IP","IT","IU","IUA","IUC","IUI"],
                
                B: ["UE","UECH","UEN","UENH","UEO","UET","UI","UM","UN","UNG","UO","UOC","UOI","UOM","UON","UONG","UOP","OUT",
                    "ONG","OOC","OONG","OP","OT","U","UA","UAC","UACH","UAI","UAM","UAN","UANG","UANH","UAO","UAT","UAY","UC",
                    "OAY","OC","OE","OEN","OEO","OET","OI","OM","ON","COMMIT","_",null,null,"OAN","OANG","OANH","OAP","OAT",
                    "UYNH","UYP","UYT","UYU","Y","YEM","YEN","YET","YEU","UOU","UP","UT","UU","UY","UYA","UYCH","UYEN","UYET"],
                    
                C: [["B","C","D"],["ƒê","G","H"],["K","L","M"],["N","P","Q"],["R","S","T"],["V","X","CH"],
                    ["GH","KH","NG"],["NGH","NH","PH"],["TH","TR","_"]]
            };
            
            // === H√ÄM T·ªêI ∆ØU - ƒê∆Ø·ª¢C ƒê·∫∂T G·∫¶N NHAU ƒê·ªÇ TƒÇNG T·ªêC ===
            
            // 1. Firebase functions
            async function fetchFirebaseData() {
                if (state.isFetching) return;
                state.isFetching = true;
                
                const startTime = performance.now();
                try {
                    const response = await fetch(FIREBASE_URL + '?t=' + Date.now(), {
                        method: 'GET',
                        headers: {'Cache-Control': 'no-cache'}
                    });
                    
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    
                    const data = await response.json();
                    const fetchTime = performance.now() - startTime;
                    
                    // Update latency
                    document.getElementById('latency').textContent = Math.round(fetchTime);
                    
                    // Process if data changed
                    if (JSON.stringify(data) !== JSON.stringify(state.firebaseData)) {
                        state.firebaseData = data;
                        state.lastUpdateTime = Date.now();
                        
                        // Fast processing
                        processSensorDataFast(data);
                        scheduleUIUpdate();
                        
                        // Adjust polling
                        if (fetchTime < 100) {
                            state.pollingInterval = state.turboMode ? 100 : 200;
                        }
                    }
                    
                    updateConnectionStatus(true);
                    return data;
                } catch (error) {
                    updateConnectionStatus(false);
                    state.pollingInterval = Math.min(state.pollingInterval * 1.5, 5000);
                    return null;
                } finally {
                    state.isFetching = false;
                    document.getElementById('lastUpdate').textContent = 
                        'C·∫≠p nh·∫≠t: ' + formatTime(Date.now());
                }
            }
            
            function processSensorDataFast(data) {
                // Update MPU
                if (data.o) document.getElementById('mpuOrientation').textContent = data.o;
                if (data.sf) document.getElementById('isShaking').textContent = data.sf;
                
                // Update flex sensors
                if (data.f0 !== undefined) {
                    const flexValues = [data.f0, data.f1 || 0, data.f2 || 0, data.f3 || 0];
                    const rawValuesElement = document.getElementById('rawValues');
                    
                    // Update states
                    for (let i = 0; i < 4; i++) {
                        const newState = calculateFlexState(flexValues[i], i);
                        if (state.flexStates[i] !== newState) {
                            state.flexStates[i] = newState;
                            document.getElementById('flex' + i + '-box').textContent = newState;
                            document.getElementById('flex' + i + '-box').className = 'flex-box active-' + newState;
                        }
                    }
                    
                    // Update raw values display
                    rawValuesElement.textContent = flexValues.join(',');
                }
            }
            
            function calculateFlexState(rawValue, sensorIndex) {
                if (rawValue <= state.straightThresholds[sensorIndex]) return 0;
                if (rawValue <= state.bentThresholds[sensorIndex]) return 1;
                return 2;
            }
            
            // 2. Word construction functions
            function getMapping(mpu, a0, a1, a2, a3) {
                if (a3 === 2) {
                    if (a0 < 3 && a1 < 3 && a2 < 3) {
                        return tables.C[a0 * 3 + a1] ? tables.C[a0 * 3 + a1][a2] : null;
                    }
                    return null;
                }
                
                const a3bin = a3 === 1 ? 1 : 0;
                if (mpu < 0 || mpu > 7 || a1 < 0 || a1 >= 3 || a2 < 0 || a2 >= 3) return null;
                
                const flatIndex = mpu * 9 + a1 * 3 + a2;
                return a3bin === 0 ? tables.A[flatIndex] : tables.B[flatIndex];
            }
            
            function updateDisplayBuffer() {
                const oldBuffer = state.displayBuffer;
                state.displayBuffer = (state.slot1 + state.slot2).toLowerCase();
                
                if (oldBuffer !== state.displayBuffer) {
                    document.getElementById('displayBuffer').textContent = state.displayBuffer || '---';
                    // Simple conversion for demo
                    document.getElementById('convertedCurrentWord').textContent = 
                        state.displayBuffer.replace(/_/g, ' ') || '---';
                }
            }
            
            function addWordToSentence() {
                if (!state.displayBuffer || state.displayBuffer === "---") return;
                
                if (state.sentenceWords.length < 10) {
                    state.sentenceWords.push(state.displayBuffer);
                    state.fullSentence = state.sentenceWords.join(' ');
                    state.convertedFullSentence = state.fullSentence.replace(/_/g, ' ');
                    
                    // Update UI
                    document.getElementById('sentenceDisplay').textContent = state.fullSentence || '---';
                    document.getElementById('convertedSentenceDisplay').textContent = state.convertedFullSentence || '---';
                    document.getElementById('wordCount').textContent = state.sentenceWords.length;
                    
                    // Update word list
                    const wordListDiv = document.getElementById('wordList');
                    wordListDiv.innerHTML = state.sentenceWords.map(word => 
                        `<div style="display:inline-block;padding:5px 10px;margin:3px;background:#e3f2fd;border-radius:15px;">${word}</div>`
                    ).join('');
                    
                    // Clear for next word
                    state.slot1 = '';
                    state.slot2 = '';
                    state.displayBuffer = '';
                    document.getElementById('displayBuffer').textContent = '---';
                    document.getElementById('convertedCurrentWord').textContent = '---';
                }
            }
            
            function commitSentence() {
                if (state.sentenceWords.length === 0) return;
                
                // Add any pending word
                if (state.displayBuffer && state.displayBuffer !== "---") {
                    addWordToSentence();
                }
                
                // Auto-translate
                document.getElementById('translationInput').value = state.convertedFullSentence;
                translateSentence();
                
                // Reset
                state.sentenceWords = [];
                state.fullSentence = '';
                state.convertedFullSentence = '';
                document.getElementById('sentenceDisplay').textContent = '---';
                document.getElementById('convertedSentenceDisplay').textContent = '---';
                document.getElementById('wordCount').textContent = '0';
                document.getElementById('wordList').innerHTML = 'Ch∆∞a c√≥ t·ª´ n√†o';
            }
            
            function clearCurrentWord() {
                state.slot1 = '';
                state.slot2 = '';
                state.displayBuffer = '';
                document.getElementById('displayBuffer').textContent = '---';
                document.getElementById('convertedCurrentWord').textContent = '---';
            }
            
            function backspace() {
                if (state.displayBuffer.length > 0) {
                    state.displayBuffer = state.displayBuffer.slice(0, -1);
                    document.getElementById('displayBuffer').textContent = state.displayBuffer || '---';
                }
            }
            
            // 3. Calibration functions
            function startCalibration() {
                if (state.isCalibrating) return;
                
                state.isCalibrating = true;
                state.calibrationCountdown = 10;
                state.calibrationMaxValues = [0, 0, 0, 0];
                
                // Show UI
                document.getElementById('calibrationProgress').style.display = 'block';
                document.getElementById('calibrateBtn').style.display = 'none';
                document.getElementById('calibrationStatus').innerHTML = 
                    '<div class="calibrating">ƒêANG CALIBRATION</div>';
                
                // Create sensor displays
                const display = document.getElementById('calibrationDisplay');
                display.innerHTML = '';
                for (let i = 0; i < 4; i++) {
                    display.innerHTML += `
                        <div class="sensor-calibration" id="calSensor${i}">
                            <div>FLEX ${i}</div>
                            <div style="font-size:1.5rem;font-weight:bold;" id="calValue${i}">0</div>
                            <div style="font-size:0.9rem;color:#666;" id="calMax${i}">Max: 0</div>
                        </div>`;
                }
                
                // Start countdown
                state.calibrationInterval = setInterval(updateCalibration, 1000);
            }
            
            function updateCalibration() {
                if (!state.isCalibrating) return;
                
                state.calibrationCountdown--;
                document.getElementById('calibrationCountdown').textContent = state.calibrationCountdown;
                
                // Update progress
                const progress = ((10 - state.calibrationCountdown) / 10) * 100;
                document.getElementById('calibrationProgressBar').style.width = progress + '%';
                
                // Update sensor values
                if (state.firebaseData) {
                    const flexValues = [
                        state.firebaseData.f0 || 0,
                        state.firebaseData.f1 || 0,
                        state.firebaseData.f2 || 0,
                        state.firebaseData.f3 || 0
                    ];
                    
                    for (let i = 0; i < 4; i++) {
                        document.getElementById('calValue' + i).textContent = flexValues[i];
                        
                        if (flexValues[i] > state.calibrationMaxValues[i]) {
                            state.calibrationMaxValues[i] = flexValues[i];
                            document.getElementById('calMax' + i).textContent = 'Max: ' + flexValues[i];
                            document.getElementById('calMax' + i).style.color = '#F44336';
                        }
                    }
                }
                
                // Finish
                if (state.calibrationCountdown <= 0) {
                    finishCalibration();
                }
            }
            
            function finishCalibration() {
                clearInterval(state.calibrationInterval);
                state.isCalibrating = false;
                
                // Update thresholds
                for (let i = 0; i < 4; i++) {
                    if (state.calibrationMaxValues[i] > state.straightThresholds[i] + 50) {
                        state.bentThresholds[i] = state.calibrationMaxValues[i];
                    }
                }
                
                // Save to localStorage
                localStorage.setItem('bentThresholds', JSON.stringify(state.bentThresholds));
                
                // Update UI
                document.getElementById('calibrationProgress').style.display = 'none';
                document.getElementById('calibrateBtn').style.display = 'inline-block';
                document.getElementById('calibrationStatus').innerHTML = 
                    '<div class="calibrated">ƒê√É CALIBRATION</div>';
                
                // Hide after 2 seconds
                setTimeout(() => {
                    document.getElementById('calibrationStatus').innerHTML = 
                        '<div class="calibration-ready">S·∫µn s√†ng</div>';
                }, 2000);
            }
            
            function resetCalibration() {
                state.bentThresholds = [300, 450, 350, 300];
                localStorage.removeItem('bentThresholds');
                document.getElementById('calibrationStatus').innerHTML = 
                    '<div class="calibration-ready">ƒê√£ reset</div>';
            }
            
            // 4. Translation functions
            async function translateSentence() {
                const text = document.getElementById('translationInput').value.trim();
                if (!text) {
                    document.getElementById('translationOutput').textContent = 'Vui l√≤ng nh·∫≠p vƒÉn b·∫£n';
                    document.getElementById('translationOutput').style.color = '#F44336';
                    return;
                }
                
                const targetLang = document.getElementById('targetLanguage').value;
                const outputDiv = document.getElementById('translationOutput');
                
                outputDiv.textContent = 'ƒêang d·ªãch...';
                outputDiv.style.color = '#2196F3';
                
                try {
                    // Simple mock translation for speed
                    const translations = {
                        'en-GB': 'Translated to English: ' + text,
                        'ja-JP': 'Êó•Êú¨Ë™ûË®≥: ' + text,
                        'ko-KR': 'ÌïúÍµ≠Ïñ¥ Î≤àÏó≠: ' + text,
                        'zh-CN': '‰∏≠ÊñáÁøªËØë: ' + text
                    };
                    
                    // Simulate network delay
                    setTimeout(() => {
                        outputDiv.textContent = translations[targetLang] || 'Translation not available';
                        outputDiv.style.color = '#4CAF50';
                    }, 500);
                    
                } catch (error) {
                    outputDiv.textContent = 'L·ªói d·ªãch thu·∫≠t';
                    outputDiv.style.color = '#F44336';
                }
            }
            
            function clearTranslation() {
                document.getElementById('translationOutput').textContent = 'ƒêang ch·ªù d·ªãch...';
                document.getElementById('translationOutput').style.color = '#2196F3';
                document.getElementById('translationInput').value = '';
            }
            
            // 5. UI and control functions
            function refreshData() {
                fetchFirebaseData();
            }
            
            function toggleAutoRefresh() {
                state.autoRefresh = !state.autoRefresh;
                const btn = document.getElementById('autoRefreshBtn');
                
                if (state.autoRefresh) {
                    btn.textContent = 'T·ª± ƒë·ªông: B·∫¨T';
                    btn.className = 'green';
                    startAutoRefresh();
                } else {
                    btn.textContent = 'T·ª± ƒë·ªông: T·∫ÆT';
                    btn.className = 'red';
                }
            }
            
            function startAutoRefresh() {
                if (!state.autoRefresh) return;
                
                function scheduleNext() {
                    if (!state.autoRefresh) return;
                    
                    setTimeout(() => {
                        fetchFirebaseData().then(() => {
                            if (state.autoRefresh) scheduleNext();
                        });
                    }, state.pollingInterval);
                }
                
                scheduleNext();
            }
            
            function scheduleUIUpdate() {
                if (!state.uiUpdateScheduled) {
                    state.uiUpdateScheduled = true;
                    requestAnimationFrame(() => {
                        // Just update time for performance
                        document.getElementById('lastUpdate').textContent = 
                            'C·∫≠p nh·∫≠t: ' + formatTime(Date.now());
                        state.uiUpdateScheduled = false;
                    });
                }
            }
            
            function updateConnectionStatus(connected) {
                const indicator = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    indicator.className = 'indicator online';
                    statusText.textContent = 'ƒê√£ k·∫øt n·ªëi Firebase';
                } else {
                    indicator.className = 'indicator';
                    indicator.style.background = '#F44336';
                    statusText.textContent = 'M·∫•t k·∫øt n·ªëi';
                }
            }
            
            function formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.getHours().toString().padStart(2, '0') + ':' +
                       date.getMinutes().toString().padStart(2, '0') + ':' +
                       date.getSeconds().toString().padStart(2, '0');
            }
            
            // 6. Performance monitoring
            function startPerformanceMonitoring() {
                function updateFPS() {
                    state.frameCount++;
                    const currentTime = performance.now();
                    if (currentTime - state.lastFrameTime >= 1000) {
                        state.currentFPS = state.frameCount;
                        state.frameCount = 0;
                        state.lastFrameTime = currentTime;
                        document.getElementById('fps').textContent = state.currentFPS;
                        document.getElementById('pollingRate').textContent = state.pollingInterval;
                    }
                    requestAnimationFrame(updateFPS);
                }
                requestAnimationFrame(updateFPS);
            }
            
            // 7. Initialization
            function init() {
                console.log('‚ö° App starting in optimized mode...');
                
                // Start performance monitor
                startPerformanceMonitoring();
                
                // Load saved calibration
                const savedThresholds = localStorage.getItem('bentThresholds');
                if (savedThresholds) {
                    try {
                        state.bentThresholds = JSON.parse(savedThresholds);
                    } catch (e) {
                        console.warn('Failed to load calibration:', e);
                    }
                }
                
                // Initial fetch
                fetchFirebaseData();
                
                // Start auto-refresh
                startAutoRefresh();
                
                // Update polling display
                document.getElementById('pollingRate').textContent = state.pollingInterval;
                
                console.log('‚úÖ App initialized successfully');
            }
            
            // === MAKE FUNCTIONS GLOBALLY AVAILABLE ===
            window.clearCurrentWord = clearCurrentWord;
            window.backspace = backspace;
            window.addWordToSentence = addWordToSentence;
            window.commitSentence = commitSentence;
            window.startCalibration = startCalibration;
            window.resetCalibration = resetCalibration;
            window.translateSentence = translateSentence;
            window.clearTranslation = clearTranslation;
            window.refreshData = refreshData;
            window.toggleAutoRefresh = toggleAutoRefresh;
            
            // === START THE APP ===
            document.addEventListener('DOMContentLoaded', init);
            
        })(); // End of IIFE
    </script>
</body>
</html>
