<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gangtay — Simple Poll & Play (faster)</title>
<style>
  body{font-family:system-ui,Arial;padding:16px;max-width:900px;margin:auto}
  input,button{padding:8px;margin:6px 0;box-sizing:border-box}
  .row{display:flex;gap:8px}
  #log{white-space:pre-wrap;background:#f6f6f6;padding:10px;border-radius:6px;min-height:200px}
</style>
</head>
<body>
  <h2>Gangtay — Simple Poll & Play (faster)</h2>

  <label>Firebase message.json URL</label>
  <input id="firebaseUrl" value="https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/message.json">

  <label>Audio base URL (folder)</label>
  <input id="audioBase" value="/audio/">

  <div class="row" style="margin-top:8px">
    <button id="unlock">Unlock audio (tap once)</button>
    <input id="pollMs" type="number" value="800" min="100" style="width:120px">
    <button id="start">Start</button>
    <button id="stop">Stop</button>
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <div id="status">Status: idle</div>
    <label style="margin-left:auto"><input id="useSse" type="checkbox"> Try SSE first</label>
  </div>

  <pre id="log">log...</pre>


<script>
/* ----------------------------------------------------------
   Global vars
---------------------------------------------------------- */
const firebaseUrlEl = document.getElementById('firebaseUrl');
const audioBaseEl = document.getElementById('audioBase');
const pollMsEl = document.getElementById('pollMs');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const useSseEl = document.getElementById('useSse');

let pollId = null;
let lastPayload = null; // now stores fingerprint (stable parts only)
let audioUnlocked = false;
let lastEtag = null;

let audioMap = new Map();   // index => reused audio element
let playingIndex = null;

let sse = null;


/* ----------------------------------------------------------
   Utilities
---------------------------------------------------------- */
function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  console.log(msg);
}

function pad4(n){
  return String(n).padStart(4,"0");
}

function fileUrlForIndex(i){
  let base = audioBaseEl.value.trim();
  if (!base.endsWith("/")) base += "/";
  if (/^https?:\/\//.test(base)) return base + pad4(i) + ".mp3";
  if (base.startsWith("/")) return location.origin + base + pad4(i) + ".mp3";
  return location.origin + "/" + base + pad4(i) + ".mp3";
}

async function tryUnlock(){
  if (audioUnlocked) return true;
  try{
    const a = new Audio();
    a.muted = true;
    await a.play().catch(()=>{});
    audioUnlocked = true;
    log("Audio unlocked");
    return true;
  }catch(e){
    log("Unlock failed: "+e);
    return false;
  }
}


/* ----------------------------------------------------------
   Audio system (cached players)
---------------------------------------------------------- */
function getAudio(i){
  if (audioMap.has(i)) return audioMap.get(i);
  
  const a = document.createElement("audio");
  a.preload = "auto";
  a.playsInline = true;
  a.crossOrigin = "anonymous";

  audioMap.set(i, a);
  return a;
}

async function playIndex(i){
  if (!await tryUnlock()){
    log("Tap Unlock audio first.");
    return;
  }

  if (playingIndex === i){
    log("Already playing index "+i);
    return;
  }

  const a = getAudio(i);
  const url = fileUrlForIndex(i) + "?ts=" + Date.now();
  a.src = url;

  a.onended = () => {
    playingIndex = null;
    log("Play ended: "+pad4(i));
  };

  try{
    await a.play();
    playingIndex = i;
    log("Play started: "+pad4(i));
  }catch(e){
    log("Play rejected: "+e);
    const ctrl = document.createElement("audio");
    ctrl.controls = true;
    ctrl.src = url;
    ctrl.style.width = "100%";
    document.body.appendChild(ctrl);
    log("Manual control created.");
  }
}


/* ----------------------------------------------------------
   Small helper: fingerprint stable parts of payload
   Removes common volatile fields (ts, timestamp, etc.)
---------------------------------------------------------- */
function fingerprint(obj){
  if (obj === null || obj === undefined) return String(obj);
  if (typeof obj !== 'object') return String(obj);
  // deep clone (simple)
  let clone;
  try{
    clone = JSON.parse(JSON.stringify(obj));
  }catch(e){
    // fallback
    clone = obj;
  }
  if (clone && typeof clone === 'object'){
    delete clone.ts;
    delete clone.time;
    delete clone.timestamp;
    delete clone._ts;
    delete clone.etag;
  }
  try{
    return JSON.stringify(clone);
  }catch(e){
    return String(clone);
  }
}


/* ----------------------------------------------------------
   Polling system (ETag optimized)
---------------------------------------------------------- */
async function pollOnce(){
  const url = firebaseUrlEl.value.trim();
  if (!url) return;

  try{
    const hdr = {};
    if (lastEtag) hdr["If-None-Match"] = lastEtag;

    const r = await fetch(url, { method:"GET", headers:hdr, cache:"no-store" });

    if (r.status === 304) return; // unchanged

    if (!r.ok){
      log("Fetch failed: "+r.status);
      return;
    }

    const et = r.headers.get("ETag");
    if (et) lastEtag = et;

    const j = await r.json();
    const fp = fingerprint(j);
    if (fp === lastPayload) return;

    lastPayload = fp;
    log("New payload: "+JSON.stringify(j));

    if (typeof j.index === "number") return playIndex(j.index);
    if (typeof j.text === "string" && /^\d+$/.test(j.text.trim()))
      return playIndex(parseInt(j.text.trim(),10));

    log("Payload ignored");
  }catch(e){
    log("Poll error: "+e);
  }
}

function startPolling(){
  if (pollId) return;
  const ms = Math.max(100, Number(pollMsEl.value)||800);
  pollId = setInterval(pollOnce, ms);
  statusEl.textContent = "Status: polling";
  log("Polling started at "+ms+" ms");
  pollOnce();
}

function stopPolling(){
  if (pollId){
    clearInterval(pollId);
    pollId = null;
  }
  statusEl.textContent = "Status: idle";
  log("Polling stopped");
}


/* ----------------------------------------------------------
   SSE — FULLY FIXED for Firebase RTDB (more tolerant parser)
---------------------------------------------------------- */
function handleStreamData(raw){
  // ignore empty or keep-alive ':' messages
  if (!raw || !String(raw).trim() || String(raw).trim() === ":") return;

  try{
    // raw is typically a JSON string like {"path":"/","data":{...}}
    const pkt = JSON.parse(raw);
    // pkt.data is where Firebase puts the payload; sometimes the stream may directly send the object
    const j = pkt && pkt.data !== undefined ? pkt.data : pkt;

    if (!j) return;

    const fp = fingerprint(j);
    if (fp === lastPayload) return;
    lastPayload = fp;

    // log a concise representation (avoid super long logs)
    let short = String(JSON.stringify(j));
    if (short.length > 200) short = short.slice(0,200) + "...";
    log("SSE payload: "+short);

    if (typeof j.index === "number") return playIndex(j.index);
    if (typeof j.text === "string" && /^\d+$/.test(j.text.trim()))
      return playIndex(parseInt(j.text.trim(),10));
    // otherwise ignore
  }catch(e){
    // sometimes raw isn't JSON - ignore silently or log once
    log("SSE parse error: "+e);
  }
}

function startSse(url){
  stopSse();
  try{
    sse = new EventSource(url);

    sse.onopen = () => {
      log("SSE opened to "+url);
      statusEl.textContent = "Status: SSE connected";
    };

    // Firebase: event: put
    sse.addEventListener("put", ev => {
      if (ev.data) handleStreamData(ev.data);
    });

    // Firebase: event: patch
    sse.addEventListener("patch", ev => {
      if (ev.data) handleStreamData(ev.data);
    });

    // fallback events
    sse.onmessage = (ev) => {
      if (ev.data) handleStreamData(ev.data);
    };

    sse.onerror = () => {
      log("SSE error; falling back to polling");
      stopSse();
      startPolling();
    };

  }catch(e){
    log("SSE failed: "+e+" → fallback to polling");
    stopSse();
    startPolling();
  }
}

function stopSse(){
  if (sse){
    try{sse.close();}catch(_){}
    sse = null;
  }
}


/* ----------------------------------------------------------
   UI
---------------------------------------------------------- */
document.getElementById("unlock").addEventListener("click", tryUnlock);

document.getElementById("start").addEventListener("click", ()=>{
  const url = firebaseUrlEl.value.trim();
  if (!url){ log("No Firebase URL"); return; }

  // reset stable payload so starting fresh
  lastPayload = null;
  lastEtag = null;

  if (useSseEl.checked){
    log("Attempting SSE (will fallback automatically)");
    startSse(url);
  } else {
    startPolling();
  }
});

document.getElementById("stop").addEventListener("click", ()=>{
  stopSse();
  stopPolling();
  lastPayload = null;
  lastEtag = null;
  log("Stopped all");
});
</script>

</body>
</html>
