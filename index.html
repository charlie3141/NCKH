<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gangtay — Simple Poll & Play (revert)</title>
<style>
  body{font-family:system-ui,Arial;padding:16px;max-width:900px;margin:auto}
  input,button{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
  .row{display:flex;gap:8px}
  .half{flex:1}
  #log{white-space:pre-wrap;background:#f6f6f6;padding:10px;border-radius:6px;min-height:200px}
</style>
</head>
<body>
  <h2>Gangtay — Simple Poll & Play (simple revert)</h2>
  <label>Firebase message.json URL</label>
  <input id="firebaseUrl" value="https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/message.json">
  <label>Audio base URL (folder)</label>
  <input id="audioBase" value="/audio/">
  <div class="row" style="margin-top:8px">
    <button id="unlock">Unlock audio (tap once)</button>
    <input id="pollMs" type="number" value="800" min="100" style="width:120px">
    <button id="start">Start</button>
    <button id="stop">Stop</button>
  </div>
  <div id="status">Status: idle</div>
  <pre id="log">log...</pre>

<script>
const firebaseUrlEl = document.getElementById('firebaseUrl');
const audioBaseEl = document.getElementById('audioBase');
const pollMsEl = document.getElementById('pollMs');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
let pollId = null;
let lastPayload = null;
let audioUnlocked = false;

function log(msg){ logEl.textContent = '['+new Date().toLocaleTimeString()+'] '+msg + '\n' + logEl.textContent; console.log(msg); }
function pad4(n){ return String(n).padStart(4,'0'); }
function fileUrlForIndex(i){
  let base = (audioBaseEl.value || '/audio/').trim();
  if (!base.endsWith('/')) base += '/';
  if (/^https?:\/\//i.test(base)) return base + pad4(i) + '.mp3';
  if (base.startsWith('/')) return location.origin + base + pad4(i) + '.mp3';
  return location.origin + '/' + base + pad4(i) + '.mp3';
}

async function tryUnlock(){
  if (audioUnlocked) return true;
  try {
    const a = new Audio();
    a.muted = true;
    await a.play().catch(()=>{});
    audioUnlocked = true;
    log('Attempted unlock (user gesture).');
    return true;
  } catch(e) { log('Unlock failed: ' + e); return false; }
}

async function playIndex(i){
  const url = fileUrlForIndex(i) + '?ts=' + Date.now();
  log('Attempt play: ' + url);
  const a = new Audio(url);
  a.playsInline = true;
  a.crossOrigin = 'anonymous';
  a.onended = ()=> log('Play ended');
  a.onerror = (e)=> log('Play error: ' + (e && e.message ? e.message : e));
  try {
    await a.play();
    log('Play started');
  } catch(e) {
    log('Play rejected: ' + e);
    // fallback: create manual controls
    const ctrl = document.createElement('audio');
    ctrl.controls = true;
    ctrl.src = url;
    ctrl.style.width = '100%';
    document.body.appendChild(ctrl);
    log('Manual control created; tap Play.');
  }
}

async function pollOnce(){
  const url = (firebaseUrlEl.value || '').trim();
  if (!url) { log('No Firebase URL'); return; }
  try {
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) { log('Fetch failed ' + r.status); return; }
    const j = await r.json();
    const s = JSON.stringify(j);
    if (s === lastPayload) return;
    lastPayload = s;
    log('New payload: ' + s);
    // interpret index or numeric text
    if (typeof j.index === 'number') { await playIndex(j.index); }
    else if (typeof j.text === 'string' && /^\d+$/.test(j.text.trim())) { await playIndex(parseInt(j.text.trim(),10)); }
    else log('Payload not numeric/index; ignoring');
  } catch(e) {
    log('Poll error: ' + e);
  }
}

document.getElementById('start').addEventListener('click', ()=>{
  if (pollId) { log('Already polling'); return; }
  const ms = Math.max(100, Number(pollMsEl.value) || 800);
  pollId = setInterval(pollOnce, ms);
  log('Polling started every ' + ms + ' ms'); statusEl.textContent = 'Status: polling';
  // immediate fetch
  pollOnce();
});
document.getElementById('stop').addEventListener('click', ()=>{ if (pollId) clearInterval(pollId); pollId=null; log('Polling stopped'); statusEl.textContent='Status: idle';});
document.getElementById('unlock').addEventListener('click', ()=>{ tryUnlock(); });
</script>
</body>
</html>
