<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Sensor Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .dashboard {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 1px solid #eaeaea;
        }
        
        .card h3 {
            color: #4A00E0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .sensor-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .sensor-item.mpu {
            border-left-color: #2196F3;
        }
        
        .sensor-item.flex {
            border-left-color: #4CAF50;
        }
        
        .sensor-item.shake {
            border-left-color: #FF9800;
        }
        
        .sensor-item.direction {
            border-left-color: #9C27B0;
        }
        
        .sensor-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
            margin: 5px 0;
        }
        
        .sensor-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .flex-box {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 2px;
            font-weight: bold;
            border: 2px solid transparent;
        }
        
        .flex-box.active-0 {
            background: #4CAF50;
            color: white;
        }
        
        .flex-box.active-1 {
            background: #FF9800;
            color: white;
        }
        
        .flex-box.active-2 {
            background: #F44336;
            color: white;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .indicator.online {
            background: #4CAF50;
            animation: blink 1s infinite;
        }
        
        .indicator.offline {
            background: #F44336;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .shake-active {
            color: #FF5722 !important;
            font-weight: bold !important;
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        
        .connection-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .connected {
            background: #E8F5E9;
            color: #2E7D32;
            border: 1px solid #C8E6C9;
        }
        
        .disconnected {
            background: #FFEBEE;
            color: #C62828;
            border: 1px solid #FFCDD2;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .raw-data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .bonus-row {
            margin-top: 15px;
            padding: 15px;
            background: #E3F2FD;
            border-radius: 8px;
            border: 1px solid #bbdefb;
        }
        
        .bonus-row h4 {
            color: #1976D2;
            margin-bottom: 10px;
        }
        
        .data-history {
            margin-top: 15px;
            padding: 15px;
            background: #FFF3E0;
            border-radius: 8px;
            border: 1px solid #FFCC80;
        }
        
        .data-history h4 {
            color: #F57C00;
            margin-bottom: 10px;
        }
        
        .history-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        .history-time {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .history-data {
            font-family: monospace;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ESP32 Sensor Monitor</h1>
            <div>Real-time data from Firebase</div>
        </header>
        
        <div class="dashboard">
            <!-- Main Sensors Card -->
            <div class="card">
                <h3>Main Sensors</h3>
                <div class="sensor-grid">
                    <div class="sensor-item mpu">
                        <div class="sensor-label">MPU6050 ORIENTATION</div>
                        <div class="sensor-value" id="mpuOrientation">---</div>
                        <div class="sensor-label">State Code (m)</div>
                        <div class="sensor-value" id="mpuState">-1</div>
                    </div>
                    
                    <div class="sensor-item shake">
                        <div class="sensor-label">SHAKE STATUS (S/sf)</div>
                        <div class="sensor-value" id="shakeStatus">---</div>
                        <div class="sensor-label">Is Shaking</div>
                        <div class="sensor-value" id="isShaking">NO</div>
                    </div>
                    
                    <div class="sensor-item flex">
                        <div class="sensor-label">FLEX SENSORS (f0-f3)</div>
                        <div>
                            <div>
                                <span class="flex-box" id="flex0-box">0</span>
                                <span class="flex-box" id="flex1-box">0</span>
                                <span class="flex-box" id="flex2-box">0</span>
                                <span class="flex-box" id="flex3-box">0</span>
                            </div>
                            <div class="sensor-label">Raw Values</div>
                            <div id="rawFlexValues">---</div>
                        </div>
                    </div>
                    
                    <div class="sensor-item direction">
                        <div class="sensor-label">SHAKE DIRECTION (D/d)</div>
                        <div class="sensor-value" id="shakeDirection">---</div>
                        <div class="sensor-label">Direction Code</div>
                        <div id="directionCode">---</div>
                    </div>
                </div>
                
                <div class="connection-status" id="connectionStatus">
                    <span class="indicator offline"></span>
                    Disconnected from Firebase
                </div>
            </div>
            
            <!-- Bonus Rows Card (Based on Direction) -->
            <div class="card">
                <h3>Bonus Rows</h3>
                <div class="bonus-row" id="bonusRow1">
                    <h4>Bonus Row 1 (Direction-based)</h4>
                    <div>Direction: <span id="bonusDir1">---</span></div>
                    <div>Function: <span id="bonusFunc1">---</span></div>
                    <div>Status: <span id="bonusStatus1">---</span></div>
                </div>
                
                <div class="bonus-row" id="bonusRow2">
                    <h4>Bonus Row 2 (Action-based)</h4>
                    <div>Action: <span id="bonusDir2">---</span></div>
                    <div>Function: <span id="bonusFunc2">---</span></div>
                    <div>Status: <span id="bonusStatus2">---</span></div>
                </div>
                
                <div class="controls">
                    <button onclick="simulateData()">Simulate Data</button>
                    <button onclick="toggleAutoRefresh()" id="autoRefreshBtn">Auto Refresh: ON</button>
                </div>
            </div>
            
            <!-- Raw Data Card -->
            <div class="card">
                <h3>Current Raw Data</h3>
                <div class="raw-data" id="rawData">
                    Waiting for data...
                </div>
                <div class="controls">
                    <button onclick="clearLog()">Clear Log</button>
                    <button onclick="copyData()">Copy JSON</button>
                </div>
            </div>
            
            <!-- Data History Card -->
            <div class="card">
                <h3>Data History</h3>
                <div class="data-history">
                    <div id="dataHistory">
                        <div class="history-item">
                            <div class="history-time">No data yet</div>
                            <div class="history-data">Waiting for Firebase updates...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Word Construction Card -->
            <div class="card">
                <h3>Word Construction Simulation</h3>
                <div style="margin-bottom: 15px;">
                    <div class="sensor-label">RAW FLEX VALUES (f0-f3)</div>
                    <div class="sensor-value" id="currentFlexValues">---</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div class="sensor-label">CALCULATED FLEX STATES</div>
                    <div id="flexStates" style="font-size: 1.2rem;">---</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div class="sensor-label">TABLE LOOKUP RESULT</div>
                    <div id="tableLookup" style="font-size: 1.2rem;">---</div>
                </div>
                
                <div class="controls">
                    <button onclick="resetSimulation()">Reset Simulation</button>
                    <button onclick="simulateWordConstruction()">Run Word Construction</button>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div>
                <span id="statusText">Fetching data...</span>
            </div>
            <div>
                <span id="lastUpdate">Last update: --:--:--</span>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const FIREBASE_URL = 'https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/sensorData.json';
        
        // State variables
        let autoRefresh = true;
        let lastData = null;
        let logEntries = [];
        let lastUpdateTime = null;
        let dataHistory = [];
        let historyLimit = 10;
        
        // Tables from ESP32 code (simplified for display)
        const tableA = [
            ["IAY","IC","ICH","IE","IEC","IEM","IEN","IENG","IEO"],
            ["IEP","IET","IEU","IM","IN","ING","INH","IO","IOI"],
            ["ENG","ENH","EO","EP","ET","EU","I","IA","IAC"],
            ["IAI","IAM","IAN","IANG","IANH","IAO","IAP","IAT","IAU"],
            ["AP","AT","AU","AY","E","EC","ECH","EM","EN"],
            ["A","AC","ACH","AI","AM","AN","ANG","ANH","AO"],
            ["IUN","IUONG","IUP","O","OA","OAC","OACH","OAI","OAM"],
            ["ION","IONG","IOT","IP","IT","IU","IUA","IUC","IUI"]
        ];
        
        const tableB = [
            ["UE","UECH","UEN","UENH","UEO","UET","UI","UM","UN"],
            ["UNG","UO","UOC","UOI","UOM","UON","UONG","UOP","OUT"],
            ["ONG","OOC","OONG","OP","OT","U","UA","UAC","UACH"],
            ["UAI","UAM","UAN","UANG","UANH","UAO","UAT","UAY","UC"],
            ["OAY","OC","OE","OEN","OEO","OET","OI","OM","ON"],
            ["COMMIT","_","nullptr","nullptr","OAN","OANG","OANH","OAP","OAT"],
            ["UYNH","UYP","UYT","UYU","Y","YEM","YEN","YET","YEU"],
            ["UOU","UP","UT","UU","UY","UYA","UYCH","UYEN","UYET"]
        ];
        
        // Format time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }
        
        // Calculate flex states from raw values (simplified version)
        function calculateFlexStates(rawFlexValues) {
            // Simplified thresholds for demonstration
            const STRAIGHT_THRESHOLD = 150;
            const BENT_THRESHOLDS = [300, 450, 350, 300]; // Default values for A0, A1, A2, A3
            
            return rawFlexValues.map((value, index) => {
                if (value <= STRAIGHT_THRESHOLD) return 0; // Straight
                else if (value <= BENT_THRESHOLDS[index]) return 1; // Partially bent
                else return 2; // Fully bent
            });
        }
        
        // Get mapping from tables based on flex states
        function getTableMapping(mpuState, flexStates) {
            if (mpuState < 0 || mpuState > 7) return "Invalid MPU State";
            
            const a0 = flexStates[0];
            const a1 = flexStates[1];
            const a2 = flexStates[2];
            const a3 = flexStates[3];
            
            // Use tableC if a3 == 2
            if (a3 === 2) {
                if (a0 < 3 && a1 < 3 && a2 < 3) {
                    return `TableC[${a0}][${a1}][${a2}]`;
                }
                return "Invalid indices for TableC";
            }
            
            // Use tableA (a3=0) or tableB (a3=1)
            const useTableB = a3 === 1;
            const table = useTableB ? tableB : tableA;
            
            if (a1 < 0 || a1 >= 3 || a2 < 0 || a2 >= 3) {
                return "Invalid a1 or a2 for table";
            }
            
            const flatIndex = a1 * 3 + a2;
            
            if (flatIndex >= 0 && flatIndex < 9) {
                const result = table[mpuState][flatIndex];
                return `${useTableB ? 'TableB' : 'TableA'}[${mpuState}][${flatIndex}] = "${result}"`;
            }
            
            return "Flat index out of range";
        }
        
        // Fetch data from Firebase
        async function fetchData() {
            try {
                const response = await fetch(FIREBASE_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                lastUpdateTime = Date.now();
                
                // Update UI with new data
                updateDisplay(data);
                
                // Update connection status
                updateConnectionStatus(true);
                
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                updateConnectionStatus(false);
                return null;
            }
        }
        
        // Update display with sensor data
        function updateDisplay(data) {
            if (!data) return;
            
            // Store in history
            const historyEntry = {
                time: new Date().toLocaleTimeString(),
                data: { ...data }
            };
            dataHistory.unshift(historyEntry);
            if (dataHistory.length > historyLimit) {
                dataHistory.pop();
            }
            
            // Update data history display
            updateDataHistory();
            
            // Update MPU data - check both 'o' and 'mpuOrientation'
            const mpuOrientation = data.o || data.mpuOrientation || '---';
            document.getElementById('mpuOrientation').textContent = mpuOrientation;
            
            // Update MPU state - check both 'm' and 'mpuState'
            const mpuState = data.m !== undefined ? data.m : (data.mpuState !== undefined ? data.mpuState : -1);
            document.getElementById('mpuState').textContent = mpuState;
            
            // Update shake data - check both 'sf', 'shakeState', and 'S'
            const shakeStatus = data.sf || data.shakeState || (data.S || '---');
            document.getElementById('shakeStatus').textContent = shakeStatus;
            
            // Update isShaking - check both 'isShaking' and 'sh'
            const isShaking = data.isShaking !== undefined ? data.isShaking : (data.sh || false);
            document.getElementById('isShaking').textContent = isShaking ? 'YES' : 'NO';
            
            // CORRECTED: Get flex values from f0, f1, f2, f3
            const flexValues = [
                data.f0 !== undefined ? data.f0 : 0,
                data.f1 !== undefined ? data.f1 : 0,
                data.f2 !== undefined ? data.f2 : 0,
                data.f3 !== undefined ? data.f3 : 0
            ];
            
            // Also check for rawFlex array for states (0,1,2)
            const rawFlexStates = data.rawFlex || [0, 0, 0, 0];
            
            // Update flex boxes with states (0,1,2)
            for (let i = 0; i < 4; i++) {
                const box = document.getElementById(`flex${i}-box`);
                if (box) {
                    const state = rawFlexStates[i] || 0;
                    box.textContent = state;
                    
                    // Remove all classes
                    box.className = 'flex-box';
                    
                    // Add appropriate class based on state
                    if (state === 0) box.classList.add('active-0');
                    else if (state === 1) box.classList.add('active-1');
                    else if (state === 2) box.classList.add('active-2');
                }
            }
            
            // Update raw flex values display
            document.getElementById('rawFlexValues').textContent = 
                `f0: ${flexValues[0]}, f1: ${flexValues[1]}, f2: ${flexValues[2]}, f3: ${flexValues[3]}`;
            
            // Update current flex values
            document.getElementById('currentFlexValues').textContent = 
                `${flexValues[0]}, ${flexValues[1]}, ${flexValues[2]}, ${flexValues[3]}`;
            
            // Calculate and display flex states
            const calculatedStates = calculateFlexStates(flexValues);
            document.getElementById('flexStates').textContent = 
                `${calculatedStates[0]}, ${calculatedStates[1]}, ${calculatedStates[2]}, ${calculatedStates[3]}`;
            
            // Update table lookup
            const tableLookup = getTableMapping(mpuState, calculatedStates);
            document.getElementById('tableLookup').textContent = tableLookup;
            
            // Update shake direction - check both 'd' and 'shakeState'
            const direction = data.d || data.shakeState || 'None';
            document.getElementById('shakeDirection').textContent = direction;
            
            // Determine direction code based on orientation
            let directionCode = -1;
            switch(mpuOrientation) {
                case 'Up': directionCode = 0; break;
                case 'Down': directionCode = 1; break;
                case 'Left': directionCode = 2; break;
                case 'Right': directionCode = 3; break;
                case 'Forward': directionCode = 4; break;
                case 'Backward': directionCode = 5; break;
                default: directionCode = -1;
            }
            
            // Override for shake directions
            if (direction.includes('Shake Left')) directionCode = 6;
            if (direction.includes('Shake Right')) directionCode = 7;
            
            document.getElementById('directionCode').textContent = directionCode;
            
            // Apply shake animation if shaking
            const shakeElement = document.getElementById('shakeStatus');
            if (isShaking || direction.includes('Shake')) {
                shakeElement.classList.add('shake-active');
            } else {
                shakeElement.classList.remove('shake-active');
            }
            
            // Update bonus rows based on direction
            updateBonusRows(direction, data, isShaking);
            
            // Update raw data display
            updateRawData(data);
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = 
                `Last update: ${formatTime(lastUpdateTime)}`;
            
            // Store last data
            lastData = data;
        }
        
        // Update data history
        function updateDataHistory() {
            const historyContainer = document.getElementById('dataHistory');
            if (dataHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="history-item">
                        <div class="history-time">No data yet</div>
                        <div class="history-data">Waiting for Firebase updates...</div>
                    </div>`;
                return;
            }
            
            let historyHTML = '';
            dataHistory.forEach((entry, index) => {
                const flexValues = [
                    entry.data.f0 || 0,
                    entry.data.f1 || 0,
                    entry.data.f2 || 0,
                    entry.data.f3 || 0
                ];
                
                historyHTML += `
                    <div class="history-item">
                        <div class="history-time">${entry.time}</div>
                        <div class="history-data">
                            MPU: ${entry.data.o || '---'} (${entry.data.m || -1})<br>
                            Flex: ${flexValues.join(', ')}<br>
                            Shake: ${entry.data.sf || 'NO'} | Dir: ${entry.data.d || 'None'}
                        </div>
                    </div>`;
            });
            
            historyContainer.innerHTML = historyHTML;
        }
        
        // Update bonus rows based on direction
        function updateBonusRows(direction, data, isShaking) {
            const bonusRow1 = document.getElementById('bonusRow1');
            const bonusRow2 = document.getElementById('bonusRow2');
            
            // Map directions to functions
            const directionMap = {
                'Left': { 
                    func: 'Navigate Back', 
                    status: 'Previous Page',
                    color: '#E3F2FD',
                    border: '#2196F3'
                },
                'Right': { 
                    func: 'Navigate Forward', 
                    status: 'Next Page',
                    color: '#E8F5E9',
                    border: '#4CAF50'
                },
                'Up': { 
                    func: 'Scroll Up', 
                    status: 'Content Up',
                    color: '#FFF3E0',
                    border: '#FF9800'
                },
                'Down': { 
                    func: 'Scroll Down', 
                    status: 'Content Down',
                    color: '#F3E5F5',
                    border: '#9C27B0'
                },
                'Forward': { 
                    func: 'Confirm', 
                    status: 'Action OK',
                    color: '#E8F5E9',
                    border: '#4CAF50'
                },
                'Backward': { 
                    func: 'Cancel', 
                    status: 'Action Cancel',
                    color: '#FFEBEE',
                    border: '#F44336'
                },
                'Shake Left': { 
                    func: 'Undo', 
                    status: 'Last Action',
                    color: '#FFF3CD',
                    border: '#FFC107'
                },
                'Shake Right': { 
                    func: 'Redo', 
                    status: 'Next Action',
                    color: '#FFF3CD',
                    border: '#FFC107'
                },
                'None': { 
                    func: 'Idle', 
                    status: 'Waiting for input',
                    color: '#F5F5F5',
                    border: '#9E9E9E'
                }
            };
            
            const dirInfo = directionMap[direction] || directionMap['None'];
            
            // Update bonus row 1
            document.getElementById('bonusDir1').textContent = direction;
            document.getElementById('bonusFunc1').textContent = dirInfo.func;
            document.getElementById('bonusStatus1').textContent = dirInfo.status;
            bonusRow1.style.background = dirInfo.color;
            bonusRow1.style.borderColor = dirInfo.border;
            
            // Bonus row 2 - System status
            const btStatus = data.btConnected ? 'Connected' : 'Disconnected';
            const heapMemory = data.freeHeap ? `${Math.round(data.freeHeap/1024)}KB` : 'Unknown';
            const messageCount = data.messageId || 0;
            
            document.getElementById('bonusDir2').textContent = isShaking ? 'SHAKING ACTIVE' : 'SYSTEM STABLE';
            document.getElementById('bonusFunc2').textContent = `BT: ${btStatus} | Msg: ${messageCount}`;
            document.getElementById('bonusStatus2').textContent = `Heap: ${heapMemory} | RSSI: ${data.wifiRSSI || 0}dBm`;
            
            // Color code based on connection
            if (data.btConnected) {
                bonusRow2.style.background = '#E8F5E9';
                bonusRow2.style.borderColor = '#4CAF50';
            } else {
                bonusRow2.style.background = '#FFEBEE';
                bonusRow2.style.borderColor = '#F44336';
            }
        }
        
        // Update raw data display
        function updateRawData(data) {
            const rawDataElement = document.getElementById('rawData');
            
            // Create a formatted display of the data
            const formattedData = JSON.stringify(data, null, 2);
            
            // Update display
            rawDataElement.textContent = formattedData;
            
            // Add to log
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] Flex: ${data.f0},${data.f1},${data.f2},${data.f3} | MPU: ${data.o} | Shake: ${data.sf} | Dir: ${data.d}`;
            
            logEntries.unshift(logEntry);
            if (logEntries.length > 10) {
                logEntries.pop();
            }
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const indicator = statusElement.querySelector('.indicator');
            const text = connected ? 'Connected to Firebase' : 'Disconnected from Firebase';
            
            statusElement.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            indicator.className = `indicator ${connected ? 'online' : 'offline'}`;
            statusElement.innerHTML = `<span class="indicator ${connected ? 'online' : 'offline'}"></span>${text}`;
            
            document.getElementById('statusText').textContent = 
                connected ? 'Connected - Receiving data' : 'Disconnected - Check connection';
        }
        
        // Toggle auto-refresh
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            document.getElementById('autoRefreshBtn').textContent = 
                `Auto Refresh: ${autoRefresh ? 'ON' : 'OFF'}`;
            
            if (autoRefresh) {
                document.getElementById('statusText').textContent = 'Auto-refresh enabled';
            } else {
                document.getElementById('statusText').textContent = 'Auto-refresh disabled';
            }
        }
        
        // Clear log
        function clearLog() {
            logEntries = [];
            document.getElementById('rawData').textContent = 'Log cleared...';
            document.getElementById('statusText').textContent = 'Log cleared';
        }
        
        // Copy data to clipboard
        function copyData() {
            if (lastData) {
                const jsonStr = JSON.stringify(lastData, null, 2);
                navigator.clipboard.writeText(jsonStr)
                    .then(() => {
                        document.getElementById('statusText').textContent = 'Data copied to clipboard!';
                        setTimeout(() => {
                            if (autoRefresh) {
                                document.getElementById('statusText').textContent = 'Connected - Receiving data';
                            }
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                        document.getElementById('statusText').textContent = 'Failed to copy data';
                    });
            }
        }
        
        // Reset simulation
        function resetSimulation() {
            document.getElementById('currentFlexValues').textContent = '---';
            document.getElementById('flexStates').textContent = '---';
            document.getElementById('tableLookup').textContent = '---';
            
            document.getElementById('statusText').textContent = 'Word construction simulation reset';
        }
        
        // Simulate word construction
        function simulateWordConstruction() {
            if (!lastData) {
                document.getElementById('statusText').textContent = 'No data available for simulation';
                return;
            }
            
            const flexValues = [
                lastData.f0 || 0,
                lastData.f1 || 0,
                lastData.f2 || 0,
                lastData.f3 || 0
            ];
            
            const mpuState = lastData.m !== undefined ? lastData.m : (lastData.mpuState !== undefined ? lastData.mpuState : -1);
            const calculatedStates = calculateFlexStates(flexValues);
            const tableLookup = getTableMapping(mpuState, calculatedStates);
            
            document.getElementById('currentFlexValues').textContent = flexValues.join(', ');
            document.getElementById('flexStates').textContent = calculatedStates.join(', ');
            document.getElementById('tableLookup').textContent = tableLookup;
            
            document.getElementById('statusText').textContent = 'Word construction simulated';
        }
        
        // Simulate data for testing
        function simulateData() {
            const simulatedData = {
                btConnected: true,
                btLastSeen: 5011,
                c: 112,
                d: "None",
                f: [11, 0, 0, 8],
                f0: 0,
                f1: 0,
                f2: 493,
                f3: 0,
                f4: 9,
                freeHeap: 227852,
                interval: 50,
                isShaking: false,
                isoTime: new Date().toISOString(),
                m: 1,
                messageId: 18,
                mo: "Down",
                mpuOrientation: "Down",
                mpuState: 1,
                ms: 1,
                o: "Down",
                rawFlex: [2, 0, 0, 1],
                s: 0,
                sb: 0,
                sf: "NO",
                sh: false,
                shakeState: "None",
                ss: "None",
                t: 98141,
                timestamp: Date.now(),
                w: -31,
                wifiRSSI: -21
            };
            
            updateDisplay(simulatedData);
            document.getElementById('statusText').textContent = 'Using simulated data';
        }
        
        // Main update loop
        async function updateLoop() {
            if (autoRefresh) {
                await fetchData();
            }
            
            setTimeout(updateLoop, 1000); // Update every second
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Start the update loop
            updateLoop();
            
            // Initial fetch
            fetchData();
            
            // Set up auto-refresh button
            document.getElementById('autoRefreshBtn').addEventListener('click', toggleAutoRefresh);
        });
    </script>
</body>
</html>
