<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gangtay ‚Äî Firebase Display + Audio Play</title>
<style>
  body{font-family:system-ui,Arial;padding:16px;max-width:1200px;margin:auto;background:#f9f9f9}
  input,button{padding:8px;margin:6px 0;box-sizing:border-box;border-radius:4px;border:1px solid #ccc}
  button{background:#007bff;color:white;cursor:pointer;border:none}
  button:hover{background:#0056b3}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .section{background:white;padding:16px;margin:12px 0;border-radius:8px;border:1px solid #e0e0e0}
  
  #dataDisplay{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin:12px 0}
  .data-card{background:#f0f7ff;padding:12px;border-radius:6px;border-left:4px solid #007bff;text-align:center}
  .data-card label{display:block;font-size:12px;color:#666;margin-bottom:4px}
  .data-card .value{font-size:20px;font-weight:bold;color:#007bff}
  
  #log{white-space:pre-wrap;background:#f6f6f6;padding:10px;border-radius:6px;min-height:200px;max-height:300px;overflow-y:auto;font-size:12px}
  
  .status-ok{color:#28a745}
  .status-err{color:#dc3545}
  
  #audioButtons{display:flex;gap:8px;flex-wrap:wrap}
  .audio-btn{padding:10px 16px;background:#17a2b8;color:white;border:none;border-radius:4px;cursor:pointer}
  .audio-btn:hover{background:#138496}
  .audio-btn.playing{background:#ffc107;color:black}
</style>
</head>
<body>
  <h1>Gangtay ‚Äî Firebase Display + Audio Play</h1>

  <div class="section">
    <h3>Configuration</h3>
    <div class="row">
      <div>
        <label>Firebase message.json URL</label>
        <input id="firebaseUrl" value="https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/message.json" style="width:100%;max-width:400px">
      </div>
      <div>
        <label>T1.TXT URL (text‚Üíindex mapping)</label>
        <input id="t1Url" value="https://raw.githubusercontent.com/charlie3141/NCKH/main/T1.TXT" style="width:100%;max-width:300px">
      </div>
      <div>
        <label>Audio base URL</label>
        <input id="audioBase" value="/audio/" style="width:100%;max-width:200px">
      </div>
      <div>
        <label>Poll interval (ms)</label>
        <input id="pollMs" type="number" value="800" min="100" style="width:100px">
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="unlock">üîì Unlock Audio</button>
      <button id="start">‚ñ∂Ô∏è Start</button>
      <button id="stop">‚èπÔ∏è Stop</button>
      <div id="status">Status: idle</div>
      <label style="margin-left:auto"><input id="useSse" type="checkbox"> Try SSE first</label>
    </div>
  </div>

  <!-- Real-time data display section -->
  <div class="section">
    <h3>Live Data from Firebase</h3>
    
    <!-- Add current word display -->
    <div style="margin-bottom:16px;padding:12px;background:#e8f5e9;border-radius:6px;border-left:4px solid #4caf50">
      <strong>üìù Current Word (>2s):</strong>
      <div style="font-size:28px;font-weight:bold;color:#2e7d32;margin-top:8px" id="currentWord">-</div>
    </div>

    <div id="dataDisplay">
      <div class="data-card">
        <label>Flex 0</label>
        <div class="value" id="flex0">-</div>
      </div>
      <div class="data-card">
        <label>Flex 1</label>
        <div class="value" id="flex1">-</div>
      </div>
      <div class="data-card">
        <label>Flex 2</label>
        <div class="value" id="flex2">-</div>
      </div>
      <div class="data-card">
        <label>Flex 3</label>
        <div class="value" id="flex3">-</div>
      </div>
      <div class="data-card">
        <label>MPU State</label>
        <div class="value" id="mpuState">-</div>
      </div>
      <div class="data-card">
        <label>Last Word</label>
        <div class="value" id="lastWord">-</div>
      </div>
    </div>
    <div style="margin-top:12px;padding:8px;background:#fff3cd;border-radius:4px">
      <strong>Raw payload:</strong> <code id="rawPayload" style="word-break:break-all">-</code>
    </div>
  </div>

  <!-- Audio playback section -->
  <div class="section">
    <h3>Audio Playback</h3>
    
    <!-- Add manual word input for testing -->
    <div style="margin-bottom:12px;padding:12px;background:#ffe0e0;border-radius:6px;border-left:4px solid #dc3545">
      <strong>üß™ Manual Word Test:</strong>
      <div class="row" style="margin-top:8px">
        <input id="manualWordInput" placeholder="Type word (e.g., 'an', 'em', 'at')" style="flex:1;min-width:200px">
        <button id="testWordBtn" style="background:#dc3545">Test Word</button>
        <button id="testIndexBtn" style="background:#6f42c1">Test Index</button>
        <input id="testIndexInput" type="number" placeholder="Index" min="0" max="10000" style="width:100px">
      </div>
    </div>

    <div id="audioButtons"></div>
    <div style="margin-top:12px;padding:8px;background:#f8f9fa;border-radius:4px">
      <strong>Playing:</strong> <span id="playingStatus">None</span>
    </div>
  </div>

  <div class="section">
    <h3>Log</h3>
    <pre id="log">Waiting to start...</pre>
  </div>

<script>
/* ============================================================
   Global State
============================================================ */
const firebaseUrlEl = document.getElementById('firebaseUrl');
const t1UrlEl = document.getElementById('t1Url');
const audioBaseEl = document.getElementById('audioBase');
const pollMsEl = document.getElementById('pollMs');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const useSseEl = document.getElementById('useSse');

let pollId = null;
let lastPayload = null;
let audioUnlocked = false;
let lastEtag = null;
let sse = null;

let audioMap = new Map();
let playingIndex = null;

let textToIndexMap = new Map();

const displayEls = {
  flex0: document.getElementById('flex0'),
  flex1: document.getElementById('flex1'),
  flex2: document.getElementById('flex2'),
  flex3: document.getElementById('flex3'),
  mpuState: document.getElementById('mpuState'),
  lastWord: document.getElementById('lastWord'),
  currentWord: document.getElementById('currentWord'),
  rawPayload: document.getElementById('rawPayload'),
  playingStatus: document.getElementById('playingStatus'),
  audioButtons: document.getElementById('audioButtons'),
  manualWordInput: document.getElementById('manualWordInput'),
  testWordBtn: document.getElementById('testWordBtn'),
  testIndexBtn: document.getElementById('testIndexBtn'),
  testIndexInput: document.getElementById('testIndexInput')
};

/* ============================================================
   Utilities
============================================================ */
function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
  if (logEl.textContent.split('\n').length > 50) {
    logEl.textContent = logEl.textContent.split('\n').slice(0, 50).join('\n');
  }
  console.log(msg);
}

function pad4(n){
  return String(n).padStart(4,"0");
}

function fileUrlForIndex(i){
  let base = audioBaseEl.value.trim();
  if (!base.endsWith("/")) base += "/";
  if (/^https?:\/\//.test(base)) return base + pad4(i) + ".mp3";
  if (base.startsWith("/")) return location.origin + base + pad4(i) + ".mp3";
  return location.origin + "/" + base + pad4(i) + ".mp3";
}

async function tryUnlock(){
  if (audioUnlocked) return true;
  try{
    const a = new Audio();
    a.muted = true;
    await a.play().catch(()=>{});
    audioUnlocked = true;
    log("‚úì Audio unlocked");
    return true;
  }catch(e){
    log("‚úó Unlock failed: "+e);
    return false;
  }
}

/* ============================================================
   Load T1.TXT and build text‚Üíindex mapping
============================================================ */
async function loadT1Mapping(){
  try {
    const url = t1UrlEl.value.trim();
    if (!url) {
      log("‚ö† No T1.TXT URL provided");
      return;
    }
    
    let attempts = [url];
    if (url.includes('github.com')) {
      attempts = [url, 'https://cors-anywhere.herokuapp.com/' + url];
    }
    
    let resp = null;
    for (const tryUrl of attempts) {
      try {
        resp = await fetch(tryUrl, { cache: "no-store" });
        if (resp.ok) break;
      } catch (e) {
        continue;
      }
    }
    
    if (!resp || !resp.ok) {
      log("‚ö† T1.TXT load failed (checked " + attempts.length + " URLs)");
      return;
    }
    
    const text = await resp.text();
    textToIndexMap.clear();
    
    // Parse T1.TXT: each line should be "index,text" or similar
    const lines = text.split('\n');
    for (const line of lines) {
      const trim = line.trim();
      if (!trim || trim.startsWith('#')) continue;
      
      // Support: "0001,AN" or "0001 AN" or "AN,0001"
      const parts = trim.split(/[,\s]+/).filter(p => p);
      if (parts.length >= 2) {
        let idx = -1, word = '';
        
        if (/^\d+$/.test(parts[0])) {
          idx = parseInt(parts[0], 10);
          word = parts[1].toLowerCase();
        } else if (/^\d+$/.test(parts[1])) {
          word = parts[0].toLowerCase();
          idx = parseInt(parts[1], 10);
        }
        
        if (idx >= 0 && word) {
          textToIndexMap.set(word, idx);
        }
      }
    }
    
    log(`‚úì T1.TXT loaded: ${textToIndexMap.size} entries from ${url}`);
  } catch (e) {
    log(`‚úó T1.TXT error: ${e}`);
  }
}

/* ============================================================
   Audio System
============================================================ */
function getAudio(i){
  if (audioMap.has(i)) return audioMap.get(i);
  
  const a = document.createElement("audio");
  a.preload = "auto";
  a.playsInline = true;
  a.crossOrigin = "anonymous";
  audioMap.set(i, a);
  return a;
}

async function playIndex(i){
  if (!await tryUnlock()){
    log("‚úó Tap Unlock audio first.");
    return;
  }

  if (playingIndex === i){
    log("‚Ñπ Already playing index "+pad4(i));
    return;
  }

  const a = getAudio(i);
  const url = fileUrlForIndex(i) + "?ts=" + Date.now();
  a.src = url;

  a.onended = () => {
    playingIndex = null;
    displayEls.playingStatus.textContent = 'None';
    log("‚úì Play ended: "+pad4(i));
  };

  try{
    await a.play();
    playingIndex = i;
    displayEls.playingStatus.textContent = pad4(i);
    log("‚ñ∂ Play started: "+pad4(i));
  }catch(e){
    log("‚úó Play rejected: "+e);
  }
}

function showAudioButtons(){
  const recent = Array.from(audioMap.keys()).slice(-10);
  displayEls.audioButtons.innerHTML = '';
  
  for (const idx of recent) {
    const btn = document.createElement('button');
    btn.className = 'audio-btn' + (playingIndex === idx ? ' playing' : '');
    btn.textContent = pad4(idx);
    btn.onclick = () => playIndex(idx);
    displayEls.audioButtons.appendChild(btn);
  }
}

/* ============================================================
   Display live data from Firebase
============================================================ */
function displayData(payload){
  if (!payload) return;
  
  // Display raw payload
  try {
    displayEls.rawPayload.textContent = JSON.stringify(payload);
  } catch (e) {
    displayEls.rawPayload.textContent = String(payload);
  }

  if (typeof payload === 'string') {
    let dataText = payload;
    
    // If framed format, extract data
    if (isValidPacket(payload)) {
      dataText = parseFramedPacket(payload) || payload;
    }

    // Numeric data: flex0,flex1,flex2,flex3,mpu
    if (/^\d+,\d+,\d+,\d+,\d/.test(dataText)) {
      const parts = dataText.split(',');
      if (parts.length >= 5) {
        displayEls.flex0.textContent = parts[0];
        displayEls.flex1.textContent = parts[1];
        displayEls.flex2.textContent = parts[2];
        displayEls.flex3.textContent = parts[3];
        displayEls.mpuState.textContent = parts[4];
      }
    }
    // Word data: just text without numbers/commas
    else if (!/[0-9,]/.test(dataText) && dataText.length > 0) {
      displayEls.currentWord.textContent = dataText.toUpperCase();
      displayEls.lastWord.textContent = dataText;
    }
  }

  if (typeof payload === 'object' && payload !== null) {
    if (payload.flex0 !== undefined) displayEls.flex0.textContent = payload.flex0;
    if (payload.flex1 !== undefined) displayEls.flex1.textContent = payload.flex1;
    if (payload.flex2 !== undefined) displayEls.flex2.textContent = payload.flex2;
    if (payload.flex3 !== undefined) displayEls.flex3.textContent = payload.flex3;
    if (payload.mpu !== undefined) displayEls.mpuState.textContent = payload.mpu;
    if (payload.word !== undefined) {
      displayEls.currentWord.textContent = payload.word.toUpperCase();
      displayEls.lastWord.textContent = payload.word;
    }
  }
}

/* ============================================================
   Fingerprinting & Detection
============================================================ */
function fingerprint(obj){
  if (obj === null || obj === undefined) return String(obj);
  if (typeof obj !== 'object') return String(obj);
  let clone;
  try{
    clone = JSON.parse(JSON.stringify(obj));
  }catch(e){
    clone = obj;
  }
  if (clone && typeof clone === 'object'){
    delete clone.ts;
    delete clone.time;
    delete clone.timestamp;
    delete clone._ts;
    delete clone.etag;
  }
  try{
    return JSON.stringify(clone);
  }catch(e){
    return String(clone);
  }
}

/* ============================================================
   Process payload: detect audio or word
============================================================ */
function processPayload(j){
  if (!j) return;

  // Filter out malformed packets
  if (typeof j.text === 'string') {
    if (!isValidPacket(j.text) && /^\d+,\d+,\d+,\d+,\d/.test(j.text) === false && j.text.length > 20) {
      log("‚ö† Corrupted packet: " + j.text.slice(0, 30));
      return;
    }
  }

  // Display the data
  displayData(j);
  log("‚úì Payload: " + JSON.stringify(j).slice(0, 100));

  // Try numeric index
  if (typeof j.index === "number") {
    return playIndex(j.index);
  }

  if (typeof j.word === "string") {
    let word = j.word.trim().toLowerCase();
    if (word && textToIndexMap.has(word)) {
      const idx = textToIndexMap.get(word);
      log(`üìñ Word: "${word}" ‚Üí index ${pad4(idx)}`);
      return playIndex(idx);
    }
  }

  // Try text-based word matching
  if (typeof j.text === "string") {
    let textData = j.text;
    
    // Extract from framed format if needed
    if (isValidPacket(textData)) {
      textData = parseFramedPacket(textData) || textData;
    }

    textData = textData.trim().toLowerCase();

    // Numeric index
    if (/^\d+$/.test(textData)) {
      return playIndex(parseInt(textData, 10));
    }

    if (/^\d+,\d+,\d+,\d+,\d/.test(textData)) {
      // This is sensor data, skip
      return;
    }

    // Word lookup in T1.TXT
    if (textToIndexMap.has(textData)) {
      const idx = textToIndexMap.get(textData);
      log(`üìñ T1.TXT: "${textData}" ‚Üí index ${pad4(idx)}`);
      return playIndex(idx);
    }
  }
}

/* ============================================================
   Validate framed packet format
============================================================ */
function isValidPacket(text) {
  const trim = String(text || '').trim();
  // Must start with $ and contain *HEX
  return /^\$.*\*[0-9A-Fa-f]+$/.test(trim);
}

function parseFramedPacket(text) {
  const trim = String(text || '').trim();
  if (!isValidPacket(trim)) return null;
  
  // Remove $ prefix and *CHECKSUM suffix
  const start = trim.indexOf('$') + 1;
  const end = trim.lastIndexOf('*');
  if (start < 1 || end < 0 || end <= start) return null;
  
  return trim.substring(start, end);
}

/* ============================================================
   Polling
============================================================ */
async function pollOnce(){
  const url = firebaseUrlEl.value.trim();
  if (!url) return;

  try{
    const hdr = {};
    if (lastEtag) hdr["If-None-Match"] = lastEtag;

    const r = await fetch(url, { method:"GET", headers:hdr, cache:"no-store" });

    if (r.status === 304) return;
    if (!r.ok){
      log("‚úó Fetch failed: "+r.status);
      return;
    }

    const et = r.headers.get("ETag");
    if (et) lastEtag = et;

    const j = await r.json();
    const fp = fingerprint(j);
    if (fp === lastPayload) return;

    lastPayload = fp;
    processPayload(j);
    showAudioButtons();
  }catch(e){
    log("‚úó Poll error: "+e);
  }
}

function startPolling(){
  if (pollId) return;
  const ms = Math.max(100, Number(pollMsEl.value)||800);
  pollId = setInterval(pollOnce, ms);
  statusEl.textContent = "Status: polling ‚úì";
  statusEl.className = "status-ok";
  log("‚ñ∂ Polling started at "+ms+" ms");
  pollOnce();
}

function stopPolling(){
  if (pollId){
    clearInterval(pollId);
    pollId = null;
  }
  statusEl.textContent = "Status: idle";
  statusEl.className = "";
  log("‚èπ Polling stopped");
}

/* ============================================================
   SSE
============================================================ */
function handleStreamData(raw){
  if (!raw || !String(raw).trim() || String(raw).trim() === ":") return;

  try{
    const pkt = JSON.parse(raw);
    const j = pkt && pkt.data !== undefined ? pkt.data : pkt;

    if (!j) return;

    const fp = fingerprint(j);
    if (fp === lastPayload) return;
    lastPayload = fp;

    processPayload(j);
    showAudioButtons();
  }catch(e){
    log("‚ö† SSE parse: "+e);
  }
}

function startSse(url){
  stopSse();
  try{
    sse = new EventSource(url);

    sse.onopen = () => {
      log("üîå SSE connected");
      statusEl.textContent = "Status: SSE ‚úì";
      statusEl.className = "status-ok";
    };

    sse.addEventListener("put", ev => {
      if (ev.data) handleStreamData(ev.data);
    });

    sse.addEventListener("patch", ev => {
      if (ev.data) handleStreamData(ev.data);
    });

    sse.onmessage = (ev) => {
      if (ev.data) handleStreamData(ev.data);
    };

    sse.onerror = () => {
      log("‚ö† SSE error ‚Üí fallback to polling");
      stopSse();
      startPolling();
    };

  }catch(e){
    log("‚úó SSE failed: "+e+" ‚Üí polling");
    stopSse();
    startPolling();
  }
}

function stopSse(){
  if (sse){
    try{sse.close();}catch(_){}
    sse = null;
  }
}

/* ============================================================
   UI Events
============================================================ */
document.getElementById("unlock").addEventListener("click", tryUnlock);

document.getElementById("start").addEventListener("click", async ()=>{
  const url = firebaseUrlEl.value.trim();
  if (!url){ log("‚úó No Firebase URL"); return; }
  
  await loadT1Mapping();

  lastPayload = null;
  lastEtag = null;

  if (useSseEl.checked){
    log("‚Ñπ Attempting SSE (will fallback)");
    startSse(url);
  } else {
    startPolling();
  }
});

document.getElementById("stop").addEventListener("click", ()=>{
  stopSse();
  stopPolling();
  lastPayload = null;
  lastEtag = null;
  log("‚èπ All stopped");
});

document.getElementById("testWordBtn").addEventListener("click", () => {
  const word = displayEls.manualWordInput.value.trim().toLowerCase();
  if (!word) {
    log("‚ö† Enter a word first");
    return;
  }
  
  if (textToIndexMap.has(word)) {
    const idx = textToIndexMap.get(word);
    log(`üß™ Testing word: "${word}" ‚Üí index ${pad4(idx)}`);
    playIndex(idx);
  } else {
    log(`‚úó Word not in T1.TXT: "${word}"`);
  }
});

document.getElementById("testIndexBtn").addEventListener("click", () => {
  const idx = parseInt(displayEls.testIndexInput.value || "0", 10);
  log(`üß™ Testing index: ${pad4(idx)}`);
  playIndex(idx);
});

// Initial log
log("Ready! Set Firebase URL and click Start.");
</script>

</body>
</html>
