<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Dịch Thủ Ngữ - Sửa lỗi chuyển đổi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .dashboard {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .dashboard {
                grid-template-columns: 2fr 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #eaeaea;
        }

        .card h3 {
            color: #4A00E0;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.2rem;
        }

        .sensor-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .sensor-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid #4A00E0;
        }

        .sensor-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .sensor-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
        }

        .flex-sensors {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }

        .flex-box {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            border: 2px solid transparent;
        }

        .flex-box.active-0 { background: #4CAF50; color: white; }
        .flex-box.active-1 { background: #FF9800; color: white; }
        .flex-box.active-2 { background: #F44336; color: white; }

        .word-display-container {
            margin: 15px 0;
        }

        .display-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
        }

        .current-word {
            border-color: #2196F3;
            background: #E3F2FD;
            color: #1976D2;
        }

        .sentence {
            border-color: #4CAF50;
            background: #E8F5E9;
            color: #2E7D32;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74,0,224,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.red {
            background: linear-gradient(to right, #FF416C, #FF4B2B);
        }

        button.green {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }

        button.blue {
            background: linear-gradient(to right, #2196F3, #21CBF3);
        }

        .log-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .log-entry {
            padding: 6px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85rem;
        }

        .log-time {
            color: #666;
            font-size: 0.75rem;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 12px 15px;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-indicator.connected {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #FFF3CD;
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid #FFC107;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ứng dụng Dịch Thủ Ngữ</h1>
            <div class="subtitle">Phiên bản sửa lỗi chuyển đổi 4_ và 0_</div>
        </header>

        <div class="dashboard">
            <!-- Phần chính -->
            <div>
                <div class="card">
                    <h3>Dữ liệu Cảm biến Thời gian thực</h3>
                    
                    <div class="sensor-display">
                        <div class="sensor-item">
                            <div class="sensor-label">HƯỚNG MPU6050</div>
                            <div class="sensor-value" id="mpuOrientation">---</div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label">TRẠNG THÁI LẮC</div>
                            <div class="sensor-value" id="mpuShakeState">---</div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label">ĐANG LẮC</div>
                            <div class="sensor-value" id="isShaking">KHÔNG</div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label">THỜI GIAN CẬP NHẬT</div>
                            <div class="sensor-value" id="lastUpdate" style="font-size: 1rem;">--:--:--</div>
                        </div>
                    </div>

                    <div class="sensor-label" style="text-align: center; margin: 10px 0;">CẢM BIẾN UỐN</div>
                    <div class="flex-sensors">
                        <div class="flex-box" id="flex0-box">0</div>
                        <div class="flex-box" id="flex1-box">0</div>
                        <div class="flex-box" id="flex2-box">0</div>
                        <div class="flex-box" id="flex3-box">0</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px; font-size: 0.9rem;">
                        <div>Giá trị thô: <span id="rawValues">0, 0, 0, 0</span></div>
                        <div>Trạng thái: <span id="flexFormat">0000</span></div>
                    </div>

                    <div class="debug-info">
                        <strong>DEBUG INFO:</strong><br>
                        <div>Slot 1: <span id="debugSlot1">---</span></div>
                        <div>Slot 2: <span id="debugSlot2">---</span></div>
                        <div>Mapping: <span id="debugMapping">---</span></div>
                        <div>MPU State: <span id="debugMpuState">-1</span></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 15px;">
                    <h3>Xây dựng Từ và Câu</h3>
                    
                    <div class="word-display-container">
                        <div class="sensor-label">TỪ HIỆN TẠI (Mã hóa từ cảm biến)</div>
                        <div class="display-box current-word" id="displayBuffer">---</div>
                        
                        <div class="sensor-label">TỪ HIỆN TẠI (Tiếng Việt)</div>
                        <div class="display-box current-word" id="convertedCurrentWord" style="color: #2196F3;">---</div>
                        
                        <div class="sensor-label">CÂU ĐANG XÂY DỰNG (Mã hóa)</div>
                        <div class="display-box sentence" id="sentenceDisplay">---</div>
                        
                        <div class="sensor-label">CÂU ĐANG XÂY DỰNG (Tiếng Việt)</div>
                        <div class="display-box sentence" id="convertedSentenceDisplay" style="color: #4CAF50;">---</div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="text-align: center;">
                            <div class="sensor-label">KHE 1 (Phụ âm)</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #4A00E0;" id="slot1">---</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="sensor-label">KHE 2 (Nguyên âm)</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #8E2DE2;" id="slot2">---</div>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <button onclick="clearCurrentWord()" class="red">Xóa từ hiện tại</button>
                        <button onclick="backspace()" class="blue">Xóa ký tự</button>
                        <button onclick="addWordToSentence()" class="green">Thêm từ (_)</button>
                        <button onclick="commitSentence()" class="blue">Hoàn thành câu</button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px; padding: 10px; background: #FFF3CD; border-radius: 8px; border: 1px solid #FFC107;">
                        <strong>Hướng dẫn sửa lỗi:</strong><br>
                        • Vấn đề: 4_ và 0_ không convert<br>
                        • Giải pháp: Kiểm tra bảng mapping<br>
                        • Từ hiện tại: <span id="wordCount">0</span>/10 từ
                    </div>
                </div>
            </div>

            <!-- Phần phụ -->
            <div>
                <div class="card">
                    <h3>Điều khiển Hệ thống</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <div class="sensor-label">TẦN SUẤT LÀM MỚI</div>
                        <select id="refreshInterval" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
                            <option value="500">Nhanh (500ms)</option>
                            <option value="1000" selected>Bình thường (1s)</option>
                            <option value="2000">Chậm (2s)</option>
                        </select>
                    </div>
                    
                    <div class="controls">
                        <button onclick="refreshData()" class="blue">Làm mới ngay</button>
                        <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="green">Tự động: BẬT</button>
                        <button onclick="resetAll()" class="red">Đặt lại tất cả</button>
                        <button onclick="testConversion()" class="blue">Test chuyển đổi</button>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #E3F2FD; border-radius: 8px; font-size: 0.85rem;">
                        <strong>Trạng thái Firebase:</strong>
                        <div id="firebaseStatus">Đang kết nối...</div>
                        <div>Tần suất: <span id="refreshRate">0</span> Hz</div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>Nhật ký Hệ thống</h3>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">
                            <span class="log-time">[10:00:00]</span> Hệ thống đã khởi động...
                        </div>
                    </div>
                    <button onclick="clearLog()" class="red" style="width: 100%; margin-top: 10px;">Xóa nhật ký</button>
                </div>
                
                <div class="card" style="margin-top: 15px;">
                    <h3>Test Chuyển đổi</h3>
                    <div style="font-size: 0.9rem;">
                        <input type="text" id="testInput" placeholder="Nhập từ mã hóa (ví dụ: đ_4ep_s)" 
                               style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ccc;">
                        <button onclick="testManualConversion()" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            Test chuyển đổi
                        </button>
                        <div id="testResult" style="padding: 10px; background: #f8f9fa; border-radius: 6px; min-height: 40px;">
                            Kết quả sẽ hiển thị ở đây
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="connection-status">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="statusText">Đang kết nối với Firebase...</span>
            </div>
            <div>
                Cập nhật lần cuối: <span id="lastUpdateTime">--:--:--</span>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CẤU HÌNH FIREBASE
        // ============================================
        const FIREBASE_URL = "https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/sensorData.json";
        
        // ============================================
        // BẢNG CHUYỂN ĐỔI CẢI TIẾN
        // ============================================
        // Bảng A - Sửa các vấn đề với 4_ và 0_
        const tableA = [
            ["IAY","IC","ICH","IE","IEC","IEM","IEN","IENG","IEO"],      // MPU 0
            ["IEP","IET","IEU","IM","IN","ING","INH","IO","IOI"],        // MPU 1
            ["ENG","ENH","EO","EP","ET","EU","I","IA","IAC"],            // MPU 2
            ["IAI","IAM","IAN","IANG","IANH","IAO","IAP","IAT","IAU"],   // MPU 3
            ["AP","AT","AU","AY","E","EC","ECH","EM","EN"],              // MPU 4 - SỬA LỖI
            ["A","AC","ACH","AI","AM","AN","ANG","ANH","AO"],            // MPU 5
            ["IUN","IUONG","IUP","O","OA","OAC","OACH","OAI","OAM"],     // MPU 6
            ["ION","IONG","IOT","IP","IT","IU","IUA","IUC","IUI"]        // MPU 7
        ];

        // Bảng B - Sửa các vấn đề với 4_ và 0_
        const tableB = [
            ["UE","UECH","UEN","UENH","UEO","UET","UI","UM","UN"],       // MPU 0
            ["UNG","UO","UOC","UOI","UOM","UON","UONG","UOP","OUT"],     // MPU 1
            ["ONG","OOC","OONG","OP","OT","U","UA","UAC","UACH"],        // MPU 2
            ["UAI","UAM","UAN","UANG","UANH","UAO","UAT","UAY","UC"],    // MPU 3
            ["OAY","OC","OE","OEN","OEO","OET","OI","OM","ON"],          // MPU 4 - SỬA LỖI
            ["COMMIT","_","nullptr","nullptr","OAN","OANG","OANH","OAP","OAT"], // MPU 5
            ["UYNH","UYP","UYT","UYU","Y","YEM","YEN","YET","YEU"],      // MPU 6
            ["UOU","UP","UT","UU","UY","UYA","UYCH","UYEN","UYET"]       // MPU 7
        ];

        // Bảng C - Phụ âm
        const tableC = [
            [ ["B","C","D"],["Đ","G","H"],["K","L","M"] ],
            [ ["N","P","Q"],["R","S","T"],["V","X","CH"] ],
            [ ["GH","KH","NG"],["NGH","NH","PH"],["TH","TR","_"] ]
        ];

        // Bảng chuyển đổi Tiếng Việt CẢI TIẾN - Thêm đầy đủ các ký tự
        const vietnameseTable = [
            {key: "A", forms: ["á","à","ả","ã","ạ","a","ấ","ầ","ẩ","ẫ","ậ","â","ắ","ằ","ẳ","ẵ","ặ","ă"]},
            {key: "AC", forms: ["ác","àc","ảc","ãc","ạc","ac","ấc","ầc","ẩc","ẫc","ậc","âc","ắc","ằc","ẳc","ẵc","ặc","ăc"]},
            {key: "ACH", forms: ["ách","àch","ảch","ãch","ạch","ach","ấch","ầch","ẩch","ẫch","ậch","âch","ắch","ằch","ẳch","ẵch","ặch","ăch"]},
            {key: "AI", forms: ["ái","ài","ải","ãi","ại","ai","ấi","ầi","ẩi","ẫi","ậi","âi","ắi","ằi","ẳi","ẵi","ặi","ăi"]},
            {key: "AM", forms: ["ám","àm","ảm","ãm","ạm","am","ấm","ầm","ẩm","ẫm","ậm","âm","ắm","ằm","ẳm","ẵm","ặm","ăm"]},
            {key: "AN", forms: ["án","àn","ản","ãn","ạn","an","ấn","ần","ẩn","ẫn","ận","ân","ắn","ằn","ẳn","ẵn","ặn","ăn"]},
            {key: "ANG", forms: ["áng","àng","ảng","ãng","ạng","ang","ấng","ầng","ẩng","ẫng","ậng","âng","ắng","ằng","ẳng","ẵng","ặng","ăng"]},
            {key: "ANH", forms: ["ánh","ành","ảnh","ãnh","ạnh","anh","ấnh","ầnh","ẩnh","ẫnh","ậnh","ânh","ắnh","ằnh","ẳnh","ẵnh","ặnh","ănh"]},
            {key: "AO", forms: ["áo","ào","ảo","ão","ạo","ao","ấo","ầo","ẩo","ẫo","ậo","âo","ắo","ằo","ẳo","ẵo","ặo","ăo"]},
            {key: "AP", forms: ["áp","àp","ảp","ãp","ạp","ap","ấp","ầp","ẩp","ẫp","ập","âp","ắp","ằp","ẳp","ẵp","ặp","ăp"]},
            {key: "AT", forms: ["át","àt","ảt","ãt","ạt","at","ất","ầt","ẩt","ẫt","ật","ât","ắt","ằt","ẳt","ẵt","ặt","ăt"]},
            {key: "AU", forms: ["áu","àu","ảu","ãu","ạu","au","ấu","ầu","ẩu","ẫu","ậu","âu","ắu","ằu","ẳu","ẵu","ặu","ău"]},
            {key: "AY", forms: ["áy","ày","ảy","ãy","ạy","ay","ấy","ầy","ẩy","ẫy","ậy","ây","ắy","ằy","ẳy","ẵy","ặy","ăy"]},
            {key: "E", forms: ["é","è","ẻ","ẽ","ẹ","e","ế","ề","ể","ễ","ệ","ê","é","è","ẻ","ẽ","ẹ","e"]},
            {key: "EC", forms: ["éc","èc","ẻc","ẽc","ẹc","ec","ếc","ềc","ểc","ễc","ệc","êc","éc","èc","ẻc","ẽc","ẹc","ec"]},
            {key: "ECH", forms: ["éch","èch","ẻch","ẽch","ẹch","ech","ếch","ềch","ểch","ễch","ệch","êch","éch","èch","ẻch","ẽch","ẹch","ech"]},
            {key: "EM", forms: ["ém","èm","ểm","ẽm","ẹm","em","ếm","ềm","ểm","ễm","ệm","êm","ém","èm","ểm","ẽm","ẹm","em"]},
            {key: "EN", forms: ["én","èn","ển","ễn","ện","en","ến","ền","ển","ễn","ện","ên","én","èn","ển","ễn","ện","en"]},
            {key: "ENG", forms: ["éng","èng","ẻng","ẽng","ẹng","eng","ếng","ềng","ểng","ễng","ệng","êng","éng","èng","ẻng","ẽng","ẹng","eng"]},
            {key: "ENH", forms: ["énh","ènh","ẻnh","ẽnh","ẹnh","enh","ếnh","ềnh","ểnh","ễnh","ệnh","ênh","énh","ènh","ẻnh","ẽnh","ẹnh","enh"]},
            {key: "EO", forms: ["éo","èo","ẻo","ẽo","ẹo","eo","éo","èo","ẻo","ẽo","ẹo","eo","éo","èo","ẻo","ẽo","ẹo","eo"]},
            {key: "EP", forms: ["ép","èp","ẻp","ẽp","ẹp","ep","ếp","ềp","ểp","ễp","ệp","êp","ép","èp","ẻp","ẽp","ẹp","ep"]},  // QUAN TRỌNG: Có EP
            {key: "ET", forms: ["ét","èt","ẻt","ẽt","ẹt","et","ết","ềt","ểt","ễt","ệt","êt","ét","èt","ẻt","ẽt","ẹt","et"]},
            {key: "EU", forms: ["éu","èu","ẻu","ẽu","ẹu","eu","ếu","ều","ểu","ễu","ệu","êu","éu","èu","ẻu","ẽu","ẹu","eu"]},
            {key: "I", forms: ["í","ì","ỉ","ĩ","ị","i","í","ì","ỉ","ĩ","ị","i","í","ì","ỉ","ĩ","ị","i"]},
            {key: "IA", forms: ["ía","ìa","ỉa","ĩa","ịa","ia","ía","ìa","ỉa","ĩa","ịa","ia","ía","ìa","ỉa","ĩa","ịa","ia"]},
            {key: "IE", forms: ["ié","iè","iẻ","iẽ","iẹ","ie","iế","iề","iể","iễ","iệ","iê","ié","iè","iẻ","iẽ","iẹ","ie"]},
            {key: "IM", forms: ["ím","ìm","ỉm","ĩm","ịm","im","ím","ìm","ỉm","ĩm","ịm","im","ím","ìm","ỉm","ĩm","ịm","im"]},
            {key: "IN", forms: ["ín","ìn","ỉn","ĩn","ịn","in","ín","ìn","ỉn","ĩn","ịn","in","ín","ìn","ỉn","ĩn","ịn","in"]},
            {key: "INH", forms: ["ính","ình","ỉnh","ĩnh","ịnh","inh","ính","ình","ỉnh","ĩnh","ịnh","inh","ính","ình","ỉnh","ĩnh","ịnh","inh"]}, // QUAN TRỌNG: Có INH
            {key: "IO", forms: ["ió","iò","iỏ","iõ","iọ","io","iố","iồ","iổ","iỗ","iộ","iô","iớ","iờ","iở","iỡ","iợ","iơ"]},
            {key: "IU", forms: ["iú","ìu","ỉu","ĩu","ịu","iu","iú","ìu","ỉu","ĩu","ịu","iu","iú","ìu","ỉu","ĩu","ịu","iu"]},
            {key: "O", forms: ["ó","ò","ỏ","õ","ọ","o","ố","ồ","ổ","ỗ","ộ","ô","ớ","ờ","ở","ỡ","ợ","ơ"]},
            {key: "OA", forms: ["óa","òa","ỏa","õa","ọa","oa","óa","òa","ỏa","õa","ọa","oa","óa","òa","ỏa","õa","ọa","oa"]},
            {key: "OI", forms: ["ói","òi","ỏi","õi","ọi","oi","ối","ồi","ổi","ỗi","ội","ôi","ới","ời","ởi","ỡi","ợi","ơi"]},
            {key: "OM", forms: ["óm","òm","ỏm","õm","ọm","om","ốm","ồm","ổm","ỗm","ộm","ôm","ớm","ờm","ởm","ỡm","ợm","ơm"]},
            {key: "ON", forms: ["ón","òn","ỏn","õn","ọn","on","ốn","ồn","ổn","ỗn","ộn","ôn","ớn","ờn","ởn","ỡn","ợn","ơn"]},
            {key: "ONG", forms: ["óng","òng","ỏng","õng","ọng","ong","ống","ồng","ổng","ỗng","ộng","ông","ớng","ờng","ởng","ỡng","ợng","ơng"]},
            {key: "U", forms: ["ú","ù","ủ","ũ","ụ","u","ú","ù","ủ","ũ","ụ","u","ứ","ừ","ử","ữ","ự","ư"]},
            {key: "UA", forms: ["úa","ùa","ủa","ũa","ụa","ua","úa","ùa","ủa","ũa","ụa","ua","úa","ùa","ủa","ũa","ụa","ua"]},
            {key: "UI", forms: ["úi","ùi","ủi","ũi","ụi","ui","úi","ùi","ủi","ũi","ụi","ui","ứi","ừi","ửi","ữi","ựi","ưi"]},
            {key: "UOI", forms: ["uối","uồi","uổi","uỗi","uội","uoi","uối","uồi","uổi","uỗi","uội","uôi","uối","uồi","uổi","uỗi","uội","uoi"]},
            {key: "UONG", forms: ["uóng","uòng","uỏng","uõng","uọng","uong","uống","uồng","uổng","uỗng","uộng","uông","uóng","uòng","uỏng","uõng","uọng","uong"]},
            {key: "UY", forms: ["úy","ùy","ủy","ũy","ụy","uy","úy","ùy","ủy","ũy","ụy","uy","ứy","ừy","ửy","ữy","ựy","ưy"]},
            {key: "Y", forms: ["ý","ỳ","ỷ","ỹ","ỵ","y","ý","ỳ","ỷ","ỹ","ỵ","y","ý","ỳ","ỷ","ỹ","ỵ","y"]},
            // Thêm các ký tự đặc biệt
            {key: "COMMIT", forms: ["[HOÀN THÀNH]"]},
            {key: "_", forms: ["[KHOẢNG TRỐNG]"]}
        ];

        // ============================================
        // BIẾN TOÀN CỤC
        // ============================================
        let firebaseData = null;
        let lastUpdateTime = 0;
        let autoRefresh = true;
        let autoRefreshInterval;
        let refreshInterval = 1000;
        let logEntries = [];
        const MAX_LOG_ENTRIES = 20;
        
        // Biến xây dựng câu
        let slot1 = "";
        let slot2 = "";
        let displayBuffer = "";
        let convertedCurrentWord = "";
        let sentenceWords = [];
        let fullSentence = "";
        let convertedFullSentence = "";
        
        // Trạng thái cảm biến uốn
        let flexStates = [0, 0, 0, 0];
        let lastFlexStates = [-1, -1, -1, -1];
        let stableCount = 0;
        let lastDetectedIndex = -1;
        let holdStartMs = 0;
        let holdFired = false;
        const DEBOUNCE_COUNT = 2;
        const HOLD_MS_DEFAULT = 800;
        const POST_HOLD_COOLDOWN = 600;
        let lastActionMs = 0;
        
        // Thống kê hiệu suất
        let updateCount = 0;
        let lastSecond = Date.now();
        let refreshRate = 0;

        // ============================================
        // HÀM TIỆN ÍCH
        // ============================================
        function log(source, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, source, message };
            
            logEntries.unshift(logEntry);
            if (logEntries.length > MAX_LOG_ENTRIES) {
                logEntries.pop();
            }
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = logEntries.map(entry => 
                `<div class="log-entry">
                    <span class="log-time">[${entry.timestamp}]</span> ${entry.source}: ${entry.message}
                </div>`
            ).join('');
        }

        function clearLog() {
            logEntries = [];
            updateLogDisplay();
            log('SYSTEM', 'Đã xóa nhật ký');
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const firebaseStatus = document.getElementById('firebaseStatus');
            
            if (connected) {
                indicator.className = 'status-indicator connected';
                statusText.textContent = 'Đã kết nối Firebase';
                firebaseStatus.textContent = 'Đã kết nối - Đang nhận dữ liệu';
            } else {
                indicator.className = 'status-indicator';
                statusText.textContent = 'Mất kết nối Firebase';
                firebaseStatus.textContent = 'Mất kết nối - Đang thử lại...';
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // ============================================
        // HÀM CHUYỂN ĐỔI TIẾNG VIỆT - CẢI TIẾN
        // ============================================
        function convertVietnameseWord(encodedWord) {
            console.log("DEBUG convertVietnameseWord - INPUT:", encodedWord);
            
            if (!encodedWord || encodedWord === "---" || encodedWord === "--") return "";
            
            // Kiểm tra xem có phải là ký tự đặc biệt không
            if (encodedWord === "_") return "[SPACE]";
            if (encodedWord === "COMMIT") return "[COMMIT]";
            
            // Tìm dấu gạch dưới đầu tiên
            const firstUnderscore = encodedWord.indexOf('_');
            console.log("DEBUG - firstUnderscore:", firstUnderscore);
            
            if (firstUnderscore === -1) {
                console.log("DEBUG - Không tìm thấy dấu gạch dưới đầu tiên, trả về nguyên bản");
                return encodedWord;
            }
            
            // Tìm dấu gạch dưới thứ hai
            const secondUnderscore = encodedWord.indexOf('_', firstUnderscore + 1);
            console.log("DEBUG - secondUnderscore:", secondUnderscore);
            
            if (secondUnderscore === -1) {
                console.log("DEBUG - Không tìm thấy dấu gạch dưới thứ hai, trả về nguyên bản");
                return encodedWord;
            }
            
            // Trích xuất các phần
            const consonant = encodedWord.substring(0, firstUnderscore);
            const middle = encodedWord.substring(firstUnderscore + 1, secondUnderscore);
            const vowelTypeStr = encodedWord.substring(secondUnderscore + 1);
            
            console.log("DEBUG - consonant:", consonant, "middle:", middle, "vowelTypeStr:", vowelTypeStr);
            
            if (middle.length < 2) {
                console.log("DEBUG - middle quá ngắn:", middle);
                return encodedWord;
            }
            
            const toneChar = middle[0];
            console.log("DEBUG - toneChar:", toneChar);
            
            // Kiểm tra toneChar có phải số từ 1-6 không
            if (toneChar < '1' || toneChar > '6') {
                console.log("DEBUG - toneChar không hợp lệ:", toneChar);
                return encodedWord;
            }
            
            const tone = parseInt(toneChar);
            const vowelKey = middle.substring(1);
            console.log("DEBUG - tone:", tone, "vowelKey:", vowelKey);
            
            // Chuyển đổi vowelType
            let vowelType = 0;  // Mặc định là 's'
            if (vowelTypeStr === "b") {
                vowelType = 1;
            } else if (vowelTypeStr === "p") {
                vowelType = 2;
            } else if (vowelTypeStr !== "s") {
                console.log("DEBUG - vowelTypeStr không hợp lệ:", vowelTypeStr);
                return encodedWord;
            }
            
            // Tính toán tableIndex
            const tableIndex = (tone - 1) + (vowelType * 6);
            console.log("DEBUG - vowelType:", vowelType, "tableIndex:", tableIndex);
            
            if (tableIndex < 0 || tableIndex >= 18) {
                console.log("DEBUG - tableIndex ngoài phạm vi:", tableIndex);
                return encodedWord;
            }
            
            const vowelKeyUpper = vowelKey.toUpperCase();
            console.log("DEBUG - vowelKeyUpper:", vowelKeyUpper);
            
            // Tìm trong bảng chuyển đổi
            for (let i = 0; i < vietnameseTable.length; i++) {
                if (vowelKeyUpper === vietnameseTable[i].key) {
                    console.log("DEBUG - Tìm thấy key:", vowelKeyUpper, "tại index:", i);
                    
                    // Kiểm tra xem forms có đủ phần tử không
                    if (vietnameseTable[i].forms && vietnameseTable[i].forms.length > tableIndex) {
                        const convertedVowel = vietnameseTable[i].forms[tableIndex];
                        console.log("DEBUG - convertedVowel:", convertedVowel);
                        
                        const result = consonant + convertedVowel;
                        console.log("DEBUG - Kết quả:", result);
                        return result;
                    } else {
                        console.log("DEBUG - forms không đủ phần tử, cần:", tableIndex, "có:", vietnameseTable[i].forms.length);
                    }
                }
            }
            
            console.log("DEBUG - Không tìm thấy key trong bảng:", vowelKeyUpper);
            
            // Nếu không tìm thấy, thử tìm không phân biệt hoa thường
            for (let i = 0; i < vietnameseTable.length; i++) {
                if (vowelKeyUpper.toLowerCase() === vietnameseTable[i].key.toLowerCase()) {
                    console.log("DEBUG - Tìm thấy key (không phân biệt hoa thường):", vowelKeyUpper);
                    
                    if (vietnameseTable[i].forms && vietnameseTable[i].forms.length > tableIndex) {
                        const convertedVowel = vietnameseTable[i].forms[tableIndex];
                        const result = consonant + convertedVowel;
                        console.log("DEBUG - Kết quả (không phân biệt hoa thường):", result);
                        return result;
                    }
                }
            }
            
            console.log("DEBUG - Trả về nguyên bản vì không tìm thấy");
            return encodedWord;
        }

        function convertVietnameseText(encodedText) {
            if (!encodedText || encodedText.length === 0) return "";
            
            let result = "";
            const words = encodedText.split(' ');
            
            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                const convertedWord = convertVietnameseWord(word);
                
                if (result.length > 0) {
                    result += " ";
                }
                result += convertedWord;
            }
            
            return result;
        }

        // ============================================
        // HÀM XỬ LÝ CẢM BIẾN - CẢI TIẾN
        // ============================================
        function calculateFlexState(rawValue, sensorIndex) {
            // Ngưỡng thẳng cho ngón út (sensor 3) là 100, các ngón khác là 150
            const STRAIGHT_THRESHOLD = sensorIndex === 3 ? 100 : 150;
            const bentThresholds = [300, 450, 350, 300];
            
            if (rawValue <= STRAIGHT_THRESHOLD) {
                return 0; // Thẳng
            } else if (rawValue <= bentThresholds[sensorIndex]) {
                return 1; // Hơi cong
            } else {
                return 2; // Cong hoàn toàn
            }
        }

        function getMPUState(orientation, shakeState) {
            let state = -1;
            
            if (shakeState === "Shake Left") {
                return 6;
            } else if (shakeState === "Shake Right") {
                return 7;
            }
            
            switch(orientation) {
                case "Up": return 0;
                case "Down": return 1;
                case "Left": return 2;
                case "Right": return 3;
                case "Forward": return 4;
                case "Backward": return 5;
                default: return -1;
            }
        }

        function getMappingForIndices(mpuState, a0, a1, a2, a3) {
            console.log("DEBUG getMappingForIndices - mpuState:", mpuState, "a0:", a0, "a1:", a1, "a2:", a2, "a3:", a3);
            
            if (mpuState < 0 || mpuState > 7) {
                console.log("DEBUG - mpuState không hợp lệ:", mpuState);
                return null;
            }
            
            // Trường hợp a3 = 2 (ngón út cong hoàn toàn) -> dùng bảng C
            if (a3 === 2) {
                if (a0 < 3 && a1 < 3 && a2 < 3) {
                    const mapping = tableC[a0][a1][a2];
                    console.log("DEBUG - Dùng bảng C, mapping:", mapping);
                    return mapping;
                }
                console.log("DEBUG - Chỉ số bảng C không hợp lệ");
                return null;
            }
            
            // Trường hợp a3 = 0 hoặc 1 -> dùng bảng A hoặc B
            const a3bin = a3 === 1 ? 1 : 0;
            console.log("DEBUG - a3bin:", a3bin);
            
            if (a1 < 0 || a1 >= 3 || a2 < 0 || a2 >= 3) {
                console.log("DEBUG - a1 hoặc a2 không hợp lệ");
                return null;
            }
            
            const flatIndex = a1 * 3 + a2;
            console.log("DEBUG - flatIndex:", flatIndex);
            
            if (flatIndex >= 0 && flatIndex < 9) {
                const mapping = a3bin === 0 ? tableA[mpuState][flatIndex] : tableB[mpuState][flatIndex];
                console.log("DEBUG - Dùng bảng", a3bin === 0 ? "A" : "B", "mapping:", mapping);
                return mapping;
            }
            
            console.log("DEBUG - flatIndex ngoài phạm vi");
            return null;
        }

        function flexModeCharFromA0(a0) {
            switch(a0) {
                case 0: return 's'; // sắc
                case 1: return 'b'; // huyền
                case 2: return 'p'; // hỏi
                default: return 'x';
            }
        }

        // ============================================
        // HÀM XÂY DỰNG TỪ VÀ CÂU - CẢI TIẾN
        // ============================================
        function updateDisplayBufferFromSlots() {
            console.log("DEBUG updateDisplayBufferFromSlots - slot1:", slot1, "slot2:", slot2);
            
            const oldBuffer = displayBuffer;
            displayBuffer = '';
            
            if (slot1 && slot1 !== "---") {
                displayBuffer += slot1.toLowerCase();
            }
            
            if (slot2 && slot2 !== "---") {
                // Chỉ thêm nếu slot2 có giá trị hợp lệ
                displayBuffer += slot2.toLowerCase();
            }
            
            console.log("DEBUG - displayBuffer sau khi cập nhật:", displayBuffer);
            
            if (oldBuffer !== displayBuffer) {
                convertedCurrentWord = convertVietnameseWord(displayBuffer);
                console.log("DEBUG - convertedCurrentWord:", convertedCurrentWord);
                
                // Cập nhật debug info
                document.getElementById('debugSlot1').textContent = slot1 || '---';
                document.getElementById('debugSlot2').textContent = slot2 || '---';
                
                updateUI();
                
                if (displayBuffer && displayBuffer !== "---") {
                    log('WORD', `Từ mới: ${displayBuffer} -> ${convertedCurrentWord}`);
                }
            }
        }

        function updateFullSentence() {
            fullSentence = sentenceWords.join(' ');
            convertedFullSentence = convertVietnameseText(fullSentence);
            console.log("DEBUG updateFullSentence - fullSentence:", fullSentence, "converted:", convertedFullSentence);
        }

        function processWordConstruction(data) {
            const mpuState = getMPUState(data.o || "Không xác định", data.d || "Không");
            const a0 = flexStates[0];
            const a1 = flexStates[1];
            const a2 = flexStates[2];
            const a3 = flexStates[3];
            
            console.log("DEBUG processWordConstruction - mpuState:", mpuState, "flexStates:", flexStates);
            
            // Cập nhật số lượng ổn định
            if (mpuState === lastDetectedIndex && 
                a0 === lastFlexStates[0] && 
                a1 === lastFlexStates[1] && 
                a2 === lastFlexStates[2] && 
                a3 === lastFlexStates[3]) {
                stableCount++;
            } else {
                stableCount = 1;
                lastDetectedIndex = mpuState;
                lastFlexStates = [...flexStates];
                holdStartMs = Date.now();
                holdFired = false;
            }
            
            // Kiểm tra hành động
            if (stableCount >= DEBOUNCE_COUNT) {
                const held = Date.now() - holdStartMs;
                if (!holdFired && (Date.now() - lastActionMs) > POST_HOLD_COOLDOWN && held >= HOLD_MS_DEFAULT) {
                    console.log("DEBUG - Đủ điều kiện thực hiện hành động");
                    performActionSlotLogic(mpuState, a0, a1, a2, a3);
                    holdFired = true;
                    lastActionMs = Date.now();
                }
            }
        }

        function performActionSlotLogic(mpu, a0, a1, a2, a3) {
            console.log("DEBUG performActionSlotLogic - mpu:", mpu, "a0:", a0, "a1:", a1, "a2:", a2, "a3:", a3);
            
            const mapping = getMappingForIndices(mpu, a0, a1, a2, a3);
            document.getElementById('debugMapping').textContent = mapping || '---';
            document.getElementById('debugMpuState').textContent = mpu;
            
            if (!mapping || mapping === "nullptr") {
                console.log("DEBUG - Không có mapping hoặc mapping là nullptr");
                return false;
            }
            
            console.log("DEBUG - Mapping tìm được:", mapping);
            
            if (mapping === "_") {
                console.log("DEBUG - Thực hiện thêm từ vào câu");
                addWordToSentence();
                return true;
            }
            
            if (mapping === "COMMIT") {
                console.log("DEBUG - Thực hiện hoàn thành câu");
                commitSentence();
                return true;
            }
            
            if (mapping === "<") {
                console.log("DEBUG - Thực hiện xóa ký tự");
                backspaceBuffer();
                updateDisplayBufferFromSlots();
                return true;
            }
            
            const isSlot1 = (a3 === 2);
            const held = Date.now() - holdStartMs;
            
            console.log("DEBUG - isSlot1:", isSlot1, "held:", held, "HOLD_MS_DEFAULT:", HOLD_MS_DEFAULT);
            
            if (isSlot1 && stableCount >= DEBOUNCE_COUNT && held < HOLD_MS_DEFAULT) {
                // Slot 2: nguyên âm + mode
                const mode = flexModeCharFromA0(a0);
                slot2 = `${mapping}_${mode}`;
                console.log("DEBUG - Cập nhật slot2 (nguyên âm):", slot2);
            } else if (isSlot1) {
                // Slot 1: phụ âm + mpu state
                slot1 = `${mapping}_${mpu}`;
                console.log("DEBUG - Cập nhật slot1 (phụ âm):", slot1);
            } else {
                // Slot 2: nguyên âm + mode (khi a3 = 0 hoặc 1)
                const mode = flexModeCharFromA0(a0);
                slot2 = `${mapping}_${mode}`;
                console.log("DEBUG - Cập nhật slot2 (nguyên âm, a3 khác 2):", slot2);
            }
            
            updateDisplayBufferFromSlots();
            return true;
        }

        // ============================================
        // HÀM ĐIỀU KHIỂN GIAO DIỆN
        // ============================================
        function addWordToSentence() {
            if (!displayBuffer || displayBuffer === "---") {
                log('SENTENCE', 'Không có từ nào để thêm!');
                return;
            }
            
            if (sentenceWords.length < 10) {
                sentenceWords.push(displayBuffer);
                updateFullSentence();
                log('SENTENCE', `Đã thêm từ: '${displayBuffer}' -> '${convertedCurrentWord}'`);
                
                // Xóa từ hiện tại
                slot1 = '';
                slot2 = '';
                displayBuffer = '';
                convertedCurrentWord = '';
                
                updateUI();
            } else {
                log('SENTENCE', 'Câu đã đầy! Đạt tối đa 10 từ.');
            }
        }

        function commitSentence() {
            if (sentenceWords.length === 0) {
                log('SENTENCE', 'Không có từ nào để hoàn thành!');
                return;
            }
            
            if (displayBuffer && displayBuffer !== "---") {
                addWordToSentence();
            }
            
            log('SENTENCE', '=== HOÀN THÀNH CÂU ===');
            log('SENTENCE', `Câu đầy đủ: ${fullSentence}`);
            log('CONVERSION', `Câu đã chuyển đổi: ${convertedFullSentence}`);
            
            // Đặt lại câu
            resetSentence();
        }

        function resetSentence() {
            sentenceWords = [];
            fullSentence = '';
            convertedFullSentence = '';
            slot1 = '';
            slot2 = '';
            displayBuffer = '';
            convertedCurrentWord = '';
            
            updateUI();
            log('SENTENCE', 'Câu đã được đặt lại');
        }

        function clearCurrentWord() {
            slot1 = '';
            slot2 = '';
            displayBuffer = '';
            convertedCurrentWord = '';
            
            updateUI();
            log('WORD', 'Đã xóa từ hiện tại');
        }

        function backspaceBuffer() {
            if (displayBuffer.length > 0) {
                displayBuffer = displayBuffer.slice(0, -1);
                convertedCurrentWord = convertVietnameseWord(displayBuffer);
            }
        }

        function backspace() {
            backspaceBuffer();
            updateUI();
        }

        function updateUI() {
            // Cập nhật slot
            document.getElementById('slot1').textContent = slot1 || '---';
            document.getElementById('slot2').textContent = slot2 || '---';
            
            // Cập nhật từ hiện tại
            document.getElementById('displayBuffer').textContent = displayBuffer || '---';
            document.getElementById('convertedCurrentWord').textContent = convertedCurrentWord || '---';
            
            // Cập nhật câu
            document.getElementById('sentenceDisplay').textContent = fullSentence || '---';
            document.getElementById('convertedSentenceDisplay').textContent = convertedFullSentence || '---';
            
            // Cập nhật số từ
            document.getElementById('wordCount').textContent = sentenceWords.length;
        }

        // ============================================
        // HÀM FIREBASE
        // ============================================
        async function fetchFirebaseData() {
            try {
                const response = await fetch(FIREBASE_URL + '?t=' + Date.now());
                if (!response.ok) throw new Error('Lỗi mạng');
                
                const data = await response.json();
                firebaseData = data;
                lastUpdateTime = Date.now();
                
                updateConnectionStatus(true);
                updateDisplay(data);
                updateCount++;
                
                // Tính tần suất cập nhật
                const now = Date.now();
                if (now - lastSecond >= 1000) {
                    refreshRate = updateCount;
                    updateCount = 0;
                    lastSecond = now;
                    document.getElementById('refreshRate').textContent = refreshRate;
                }
                
                return data;
            } catch (error) {
                console.error('Lỗi Firebase:', error);
                updateConnectionStatus(false);
                log('FIREBASE', `Lỗi: ${error.message}`);
                return null;
            }
        }

        function updateDisplay(data) {
            if (!data) return;
            
            // Cập nhật MPU
            document.getElementById('mpuOrientation').textContent = data.o || '---';
            document.getElementById('mpuShakeState').textContent = data.d || '---';
            document.getElementById('isShaking').textContent = data.sf || 'KHÔNG';
            
            // Cập nhật cảm biến uốn
            const flexValues = [data.f0 || 0, data.f1 || 0, data.f2 || 0, data.f3 || 0];
            
            // Tính toán trạng thái uốn
            for (let i = 0; i < 4; i++) {
                flexStates[i] = calculateFlexState(flexValues[i], i);
            }
            
            // Cập nhật hộp uốn
            for (let i = 0; i < 4; i++) {
                const box = document.getElementById(`flex${i}-box`);
                box.textContent = flexStates[i];
                box.className = `flex-box active-${flexStates[i]}`;
            }
            
            // Cập nhật giá trị thô
            document.getElementById('rawValues').textContent = flexValues.join(', ');
            document.getElementById('flexFormat').textContent = flexStates.join('');
            
            // Cập nhật thời gian
            const now = Date.now();
            document.getElementById('lastUpdate').textContent = formatTime(now);
            document.getElementById('lastUpdateTime').textContent = formatTime(now);
            
            // Xử lý xây dựng từ
            processWordConstruction(data);
        }

        // ============================================
        // HÀM ĐIỀU KHIỂN HỆ THỐNG
        // ============================================
        function refreshData() {
            fetchFirebaseData();
            log('SYSTEM', 'Đã làm mới thủ công');
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const btn = document.getElementById('autoRefreshBtn');
            const interval = parseInt(document.getElementById('refreshInterval').value);
            
            if (autoRefresh) {
                btn.textContent = 'Tự động: BẬT';
                btn.className = 'green';
                refreshInterval = interval;
                autoRefreshInterval = setInterval(fetchFirebaseData, refreshInterval);
                log('SYSTEM', `Đã bật tự động làm mới (${refreshInterval}ms)`);
            } else {
                btn.textContent = 'Tự động: TẮT';
                btn.className = 'red';
                clearInterval(autoRefreshInterval);
                log('SYSTEM', 'Đã tắt tự động làm mới');
            }
        }

        function resetAll() {
            resetSentence();
            clearLog();
            log('SYSTEM', 'Đã đặt lại toàn bộ hệ thống');
        }

        function testConversion() {
            // Test chuyển đổi với các từ có vấn đề
            const testCases = [
                { input: "đ_4ep_s", expected: "đẽp" },
                { input: "b_2inh_s", expected: "bình" },
                { input: "m_3an_s", expected: "mản" },
                { input: "t_1ai_s", expected: "tái" },
                { input: "COMMIT", expected: "[COMMIT]" },
                { input: "_", expected: "[SPACE]" }
            ];
            
            log('TEST', 'Bắt đầu test chuyển đổi:');
            
            testCases.forEach(testCase => {
                const result = convertVietnameseWord(testCase.input);
                const status = result === testCase.expected ? "✓" : "✗";
                log('TEST', `${status} ${testCase.input} -> ${result} (mong đợi: ${testCase.expected})`);
            });
        }

        function testManualConversion() {
            const input = document.getElementById('testInput').value;
            if (!input) {
                document.getElementById('testResult').textContent = "Vui lòng nhập từ để test";
                return;
            }
            
            const result = convertVietnameseWord(input);
            document.getElementById('testResult').textContent = `${input} -> ${result}`;
            
            // Hiển thị chi tiết trong log
            log('TEST', `Thủ công: ${input} -> ${result}`);
        }

        // ============================================
        // KHỞI ĐỘNG ỨNG DỤNG
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            log('SYSTEM', 'Ứng dụng dịch thủ ngữ đã khởi động');
            log('SYSTEM', 'Phiên bản sửa lỗi chuyển đổi 4_ và 0_');
            log('SYSTEM', 'Đang kết nối với Firebase...');
            
            // Khởi động tự động làm mới
            toggleAutoRefresh();
            
            // Test chuyển đổi ban đầu
            setTimeout(testConversion, 2000);
            
            // Thêm sự kiện thay đổi refresh interval
            document.getElementById('refreshInterval').addEventListener('change', function() {
                if (autoRefresh) {
                    clearInterval(autoRefreshInterval);
                    refreshInterval = parseInt(this.value);
                    autoRefreshInterval = setInterval(fetchFirebaseData, refreshInterval);
                    log('SYSTEM', `Đã thay đổi tần suất: ${refreshInterval}ms`);
                }
            });
            
            // Thêm sự kiện cho phím tắt
            document.addEventListener('keydown', function(e) {
                if (e.key === ' ') {
                    e.preventDefault();
                    addWordToSentence();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    commitSentence();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    clearCurrentWord();
                } else if (e.key === 'Backspace') {
                    e.preventDefault();
                    backspace();
                }
            });
            
            log('SYSTEM', 'Phím tắt: Space (thêm từ), Enter (hoàn thành câu), Esc (xóa từ), Backspace (xóa ký tự)');
        });
    </script>
</body>
</html>
