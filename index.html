<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gangtay — Debug Clicks & JS</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;padding:14px;max-width:980px;margin:auto}
  h1{margin:0 0 8px 0}
  #log{font-family:monospace;background:#111;color:#e6e6e6;padding:12px;border-radius:8px;min-height:160px;white-space:pre-wrap;overflow:auto}
  button{padding:10px;margin:8px 0;width:100%;box-sizing:border-box}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .half{flex:1 1 48%}
  .ok{color:limegreen}
  .err{color:crimson}
</style>
</head>
<body>
  <h1>Gangtay — Click / JS Debug Page</h1>
  <p style="color:#666;margin:0 0 12px 0">This page logs every JS load, click, and error. Use this to test whether your browser runs the script.</p>

  <label>Audio base URL</label>
  <input id="audioBase" value="/audio/" style="padding:8px;width:100%;box-sizing:border-box"/>

  <label>Index</label>
  <input id="indexInput" type="number" value="2" min="1" style="padding:8px;width:100%;box-sizing:border-box"/>

  <div class="row">
    <button id="btn1" class="half" onclick="safeClick(1)">Test button 1 (onclick)</button>
    <button id="btn2" class="half">Test button 2 (addEventListener)</button>
  </div>

  <div class="row">
    <button id="fetchTest" class="half">Network fetch test (audio URL)</button>
    <button id="runAll" class="half">Run all quick checks</button>
  </div>

  <div style="margin-top:10px">
    <button id="clearLog">Clear log</button>
  </div>

  <h3 style="margin-top:14px">On-page Log</h3>
  <div id="log">[page] HTML loaded — waiting for JS...</div>

<script>
/* Defensive debug script:
   - reports JS load, button clicks, runtime errors and Promise rejections,
   - wires button #2 via addEventListener,
   - safeClick(n) is global (used by inline onclick).
*/

(function(){
  const L = document.getElementById('log');
  const audioBaseEl = document.getElementById('audioBase');
  const idxEl = document.getElementById('indexInput');

  function appendLog(msg, cls) {
    const time = new Date().toLocaleTimeString();
    const line = `[${time}] ${msg}`;
    L.textContent = line + '\n' + L.textContent;
    // keep scroll reasonable
    if (L.childElementCount > 500) L.textContent = L.textContent.substring(0, 20000);
    if (cls === 'err') console.error(line); else console.log(line);
  }

  // Expose safeClick globally for inline onclick fallback
  window.safeClick = async function(n) {
    try {
      appendLog('safeClick(' + n + ') invoked (inline onclick).');
      // visual confirmation on mobile
      try { alert('safeClick(' + n + ')'); } catch(e) {}
      // run a tiny test: attempt to create audio element & play (will likely be blocked on mobile until unlock)
      const i = Number(idxEl.value) || 1;
      appendLog('safeClick -> will attempt to create Audio element for index ' + i);
      const url = makeUrl(i);
      appendLog('safeClick -> URL: ' + url);
      const a = new Audio(url);
      a.crossOrigin = 'anonymous';
      a.onplay = ()=> appendLog('Audio element onplay fired.');
      a.onended = ()=> appendLog('Audio element ended.');
      a.onerror = (ev)=> appendLog('Audio element error: ' + (ev && ev.message ? ev.message : 'unknown'), 'err');
      try { await a.play(); appendLog('Audio.play() promise resolved'); } catch(e) { appendLog('Audio.play() rejected: ' + e, 'err'); }
    } catch (e) {
      appendLog('safeClick exception: ' + e, 'err');
    }
  };

  // helper URL builder
  function makeUrl(i) {
    const base = (audioBaseEl.value || '/audio/').trim();
    const fname = String(i).padStart(4,'0') + '.mp3';
    if (/^https?:\/\//i.test(base)) return (base.endsWith('/') ? base + fname : base + '/' + fname) + '?ts=' + Date.now();
    if (base.startsWith('/')) return location.origin + (base.endsWith('/') ? base + fname : base + '/' + fname) + '?ts=' + Date.now();
    return location.origin + '/' + (base.endsWith('/') ? base + fname : base + '/' + fname) + '?ts=' + Date.now();
  }

  // addEventListener wiring (button 2)
  const btn2 = document.getElementById('btn2');
  btn2.addEventListener('click', async function(ev){
    appendLog('btn2 click (addEventListener) invoked.');
    try {
      // small fetch check
      const i = Number(idxEl.value) || 1;
      const url = makeUrl(i);
      appendLog('btn2 -> fetch ' + url);
      try {
        const r = await fetch(url, { method: 'GET', cache: 'no-store' });
        appendLog('btn2 fetch status: ' + r.status + ' size: ' + (r.headers.get('content-length') || 'unknown'));
        if (r.ok) appendLog('btn2: fetch ok — blob size ' + (await r.blob()).size);
      } catch (e) {
        appendLog('btn2 fetch error: ' + e, 'err');
      }
    } catch (e) {
      appendLog('btn2 handler exception: ' + e, 'err');
    }
  });

  // fetch test button
  document.getElementById('fetchTest').addEventListener('click', async ()=>{
    appendLog('fetchTest clicked — performing HEAD-like fetch (GET but not streaming).');
    try {
      const i = Number(idxEl.value) || 1;
      const url = makeUrl(i);
      const r = await fetch(url, { method: 'GET', cache: 'no-store' });
      appendLog('fetchTest status: ' + r.status);
      if (r.ok) {
        const blob = await r.blob();
        appendLog('fetchTest blob size: ' + blob.size + ' bytes');
      } else {
        appendLog('fetchTest not ok: ' + r.status + ' (CORS or 404 possible)', 'err');
      }
    } catch (e) {
      appendLog('fetchTest exception: ' + e, 'err');
    }
  });

  document.getElementById('runAll').addEventListener('click', async ()=>{
    appendLog('runAll clicked — running quick checks (unlock attempt + fetchTest + btn2 click).');
    try {
      // try unlock
      try {
        ensureAudioCtx();
        const a = new Audio(); a.muted = true;
        try { await a.play(); appendLog('runAll: muted-audio play resolved'); } catch(e){ appendLog('runAll: muted-audio play rejected: ' + e); }
      } catch(e) { appendLog('runAll unlock attempt error: ' + e, 'err'); }
      // do fetchTest:
      document.getElementById('fetchTest').click();
      // do btn2:
      document.getElementById('btn2').click();
    } catch(e) { appendLog('runAll exception: ' + e, 'err'); }
  });

  // clear log
  document.getElementById('clearLog').addEventListener('click', ()=> { L.textContent = ''; appendLog('[log cleared]'); });

  // global error handlers
  window.addEventListener('error', function(evt){
    appendLog('window.error: ' + (evt && evt.message ? evt.message : JSON.stringify(evt)), 'err');
  });
  window.addEventListener('unhandledrejection', function(evt){
    appendLog('unhandledrejection: ' + (evt && evt.reason ? evt.reason : JSON.stringify(evt)), 'err');
  });

  // small helper to create AudioContext if needed
  function ensureAudioCtx(){
    if (window._dbgAudioCtx) return;
    try {
      window._dbgAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
      appendLog('AudioContext created (dbg).');
    } catch(e) {
      appendLog('AudioContext creation failed: ' + e, 'err');
    }
  }

  // report JS loaded
  appendLog('JS loaded and handlers attached.');
  // also print to console for devtools
  console.log('[debug page] JS loaded');

})();
</script>
</body>
</html>
