<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng v√† c·∫£i ti·∫øn "C√¥ng ngh·ªá d·ªãch th·ªß ng·ªØ" v√†o ƒë·ªùi s·ªëng</title>
    
    <!-- Th√™m Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js"></script>
    
    <style>
        /* T·∫•t c·∫£ CSS t·ª´ file g·ªëc gi·ªØ nguy√™n */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .dashboard {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 1px solid #eaeaea;
            will-change: transform, opacity;
            contain: content;
        }

        .card h3 {
            color: #4A00E0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .conversion-display, .sentence-display, .current-word-display {
            will-change: contents;
            transform: translateZ(0);
        }

        .conversion-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2196F3;
            margin: 10px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #E3F2FD;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #2196F3;
            line-height: 1.4;
        }

        .sentence-display {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #E8F5E9;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #4CAF50;
            line-height: 1.4;
        }

        .current-word-display {
            font-size: 2rem;
            font-weight: bold;
            color: #FF5722;
            margin: 10px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #FFF8E1;
            border-radius: 10px;
            padding: 15px;
            border: 2px dashed #FFC107;
        }

        .word-list {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #eaeaea;
        }

        .word-item {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            background: #e3f2fd;
            border-radius: 20px;
            border: 1px solid #bbdefb;
        }

        .word-count {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .sensor-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .sensor-item.mpu {
            border-left-color: #2196F3;
        }

        .sensor-item.flex {
            border-left-color: #4CAF50;
        }

        .sensor-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
            margin: 5px 0;
        }

        .sensor-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .flex-box {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 2px;
            font-weight: bold;
            border: 2px solid transparent;
        }

        .flex-box.active-0 { background: #4CAF50; color: white; }
        .flex-box.active-1 { background: #FF9800; color: white; }
        .flex-box.active-2 { background: #F44336; color: white; }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button.red {
            background: linear-gradient(to right, #FF416C, #FF4B2B);
        }

        button.green {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }

        button.blue {
            background: linear-gradient(to right, #2196F3, #21CBF3);
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .indicator.online {
            background: #4CAF50;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .calibration-status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }

        .calibrating {
            background: #FFF3CD;
            border: 2px solid #FFC107;
            color: #856404;
            animation: pulse 1s infinite;
        }

        .calibrated {
            background: #D4EDDA;
            border: 2px solid #28A745;
            color: #155724;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .shake-active {
            color: #FF5722 !important;
            font-weight: bold !important;
            animation: shake 0.5s infinite;
        }

        .language-select {
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background: white;
            font-size: 1rem;
        }

        .phrase-btn {
            padding: 8px 15px;
            background: linear-gradient(to right, #FF9800, #FF5722);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .phrase-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(255,87,34,0.3);
        }

        .loading {
            animation: pulse 1s infinite;
            color: #2196F3 !important;
        }

        .error {
            color: #F44336 !important;
            border-color: #F44336 !important;
            background: #FFEBEE !important;
        }

        .success {
            color: #4CAF50 !important;
            border-color: #4CAF50 !important;
            background: #E8F5E9 !important;
        }

        textarea {
            width: 100%;
            height: 120px;
            font-size: 1.5rem;
            padding: 15px;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            background: #E8F5E9;
            color: #333;
            resize: vertical;
        }

        select {
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            min-width: 150px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .firebase-status {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .last-update {
            font-size: 0.8rem;
            color: #999;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .phrase-suggestions {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #eaeaea;
        }

        .phrase-suggestions h4 {
            margin-bottom: 10px;
            color: #4A00E0;
            font-size: 1rem;
        }

        .phrase-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .phrase-pill {
            padding: 6px 12px;
            background: linear-gradient(to right, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .phrase-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(76,175,80,0.3);
        }

        .phrase-pill.blue {
            background: linear-gradient(to right, #2196F3, #1976D2);
        }

        .speech-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .speech-btn {
            padding: 10px 20px;
            background: linear-gradient(to right, #9C27B0, #673AB7);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .speech-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(156,39,176,0.3);
        }

        .speech-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .speech-btn.speaking {
            background: linear-gradient(to right, #FF5722, #E64A19);
            animation: pulse 1s infinite;
        }

        .audio-visualizer {
            margin-top: 10px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }

        .audio-bar {
            width: 4px;
            background: #4CAF50;
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .dynamic-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .dynamic-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .suggestion-item:hover {
            background: #f0f7ff;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .text-input-container {
            position: relative;
        }

        .gender-selection {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        .gender-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .gender-btn.active {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border-color: #4A00E0;
        }

        .gender-btn.male {
            background: linear-gradient(to right, #2196F3, #1976D2);
            color: white;
        }

        .gender-btn.female {
            background: linear-gradient(to right, #E91E63, #C2185B);
            color: white;
        }

        .auto-suggestions-panel {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            border-radius: 10px;
            border: 2px solid #e0e6ff;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auto-suggestions-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #4A00E0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .auto-suggestion-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .auto-suggestion-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #4A00E0;
        }

        .auto-suggestion-text {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .auto-suggestion-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .auto-suggestion-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            flex: 1;
            text-align: center;
        }

        .auto-suggestion-btn.speak {
            background: linear-gradient(to right, #9C27B0, #673AB7);
            color: white;
        }

        .auto-suggestion-btn.use {
            background: linear-gradient(to right, #4CAF50, #45a049);
            color: white;
        }

        .auto-suggestion-btn.translate {
            background: linear-gradient(to right, #2196F3, #1976D2);
            color: white;
        }

        .voice-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .voice-btn {
            padding: 6px 12px;
            background: linear-gradient(to right, #FF9800, #FF5722);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .voice-btn.active {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            box-shadow: 0 2px 8px rgba(74,0,224,0.3);
        }

        .language-voice-display {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        .ai-speech-status {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #4CAF50;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .ai-loading {
            animation: pulse 1s infinite;
        }

        .tts-toggle {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .tts-toggle-btn {
            padding: 6px 12px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .tts-toggle-btn.active {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border-color: #4A00E0;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>·ª®ng d·ª•ng v√† c·∫£i ti·∫øn "C√¥ng ngh·ªá d·ªãch th·ªß ng·ªØ" v√†o ƒë·ªùi s·ªëng</h1>
            <div>Gi√°m s√°t th·ªùi gian th·ª±c t·ª´ C∆° s·ªü d·ªØ li·ªáu Firebase</div>
            <div class="firebase-status" id="firebaseStatus">
                ƒêang k·∫øt n·ªëi v·ªõi Firebase...
            </div>
        </header>

        <div class="dashboard">
            <!-- Card X√¢y d·ª±ng C√¢u -->
            <div class="card">
                <h3>X√¢y d·ª±ng C√¢u</h3>
                <div style="text-align: center; padding: 20px; margin-bottom: 20px;">
                    <div class="sensor-label">T·ª™ HI·ªÜN T·∫†I (M√£ h√≥a)</div>
                    <div class="current-word-display" id="displayBuffer">---</div>
                    <div class="sensor-label">T·ª™ HI·ªÜN T·∫†I (Ti·∫øng Vi·ªát)</div>
                    <div class="conversion-display" id="convertedCurrentWord">---</div>
                    
                    <div style="margin: 15px 0; color: #666;">
                        <div><strong>S·ª≠ d·ª•ng '_' ƒë·ªÉ th√™m t·ª´ v√†o c√¢u</strong></div>
                        <div><strong>S·ª≠ d·ª•ng 'COMMIT' ƒë·ªÉ ho√†n th√†nh c√¢u</strong></div>
                    </div>
                    
                    <div class="sensor-label">C√ÇU ƒê·∫¶Y ƒê·ª¶ (M√£ h√≥a)</div>
                    <div class="sentence-display" id="sentenceDisplay">---</div>
                    <div class="sensor-label">C√ÇU ƒê·∫¶Y ƒê·ª¶ (Ti·∫øng Vi·ªát)</div>
                    <div class="conversion-display" id="convertedSentenceDisplay">---</div>
                    
                    <!-- Chuy·ªÉn ƒë·ªïi TTS -->
                    <div class="tts-toggle">
                        <button class="tts-toggle-btn active" id="useGeminiTTS" onclick="toggleTTSMode(true)">üéØ Gi·ªçng AI Gemini</button>
                        <button class="tts-toggle-btn" id="useWebSpeech" onclick="toggleTTSMode(false)">üîä Web Speech</button>
                    </div>
                    
                    <!-- B·∫£ng ƒë·ªÅ xu·∫•t t·ª± ƒë·ªông -->
                    <div class="auto-suggestions-panel" id="autoSuggestionsPanel" style="display: none;">
                        <div class="auto-suggestions-title">
                            <span>üí° ƒê·ªÄ XU·∫§T D·ª∞A TR√äN C√ÇU C·ª¶A B·∫†N</span>
                        </div>
                        <div class="auto-suggestions-grid" id="autoSuggestionsGrid">
                            <!-- ƒê·ªÅ xu·∫•t t·ª± ƒë·ªông s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                        </div>
                    </div>
                    
                    <!-- ƒê·ªÅ xu·∫•t c·ª•m t·ª´ -->
                    <div class="phrase-suggestions">
                        <h4>üìù ƒê·ªÄ XU·∫§T C·ª§M T·ª™ TH√îNG D·ª§NG</h4>
                        <div class="phrase-pills" id="phrasePills">
                            <!-- C√°c n√∫t c·ª•m t·ª´ s·∫Ω ƒë∆∞·ª£c th√™m b·ªüi JavaScript -->
                        </div>
                    </div>
                    
                    <!-- T√πy ch·ªçn gi·ªçng n√≥i -->
                    <div class="voice-options">
                        <div class="voice-btn male active" data-gender="male" data-lang="vi-VN" onclick="selectVoice(this)">
                            üë® Nam Ti·∫øng Vi·ªát
                        </div>
                        <div class="voice-btn female" data-gender="female" data-lang="vi-VN" onclick="selectVoice(this)">
                            üë© N·ªØ Ti·∫øng Vi·ªát
                        </div>
                        <div class="voice-btn male" data-gender="male" data-lang="en-GB" onclick="selectVoice(this)">
                            üë® Nam Ti·∫øng Anh
                        </div>
                        <div class="voice-btn female" data-gender="female" data-lang="en-GB" onclick="selectVoice(this)">
                            üë© N·ªØ Ti·∫øng Anh
                        </div>
                        <div class="voice-btn male" data-gender="male" data-lang="ja-JP" onclick="selectVoice(this)">
                            üë® Nam Ti·∫øng Nh·∫≠t
                        </div>
                        <div class="voice-btn female" data-gender="female" data-lang="ja-JP" onclick="selectVoice(this)">
                            üë© N·ªØ Ti·∫øng Nh·∫≠t
                        </div>
                    </div>
                    
                    <div class="language-voice-display" id="currentVoiceDisplay">
                        Hi·ªán t·∫°i: Nam Ti·∫øng Vi·ªát (Gemini AI)
                    </div>
                    
                    <div class="ai-speech-status" id="aiSpeechStatus" style="display: none;">
                        <span class="ai-loading">‚è≥</span> ƒêang t·∫£i gi·ªçng AI...
                    </div>
                    
                    <!-- ƒêi·ªÅu khi·ªÉn gi·ªçng n√≥i -->
                    <div class="speech-controls">
                        <button class="speech-btn" onclick="speakVietnameseSentence()" id="speakVnBtn">
                            üîä ƒê·ªçc Ti·∫øng Vi·ªát
                        </button>
                        <button class="speech-btn blue" onclick="speakTranslation()" id="speakTransBtn">
                            üîà ƒê·ªçc B·∫£n d·ªãch
                        </button>
                        <button class="speech-btn red" onclick="stopAllSpeech()" id="stopSpeechBtn">
                            ‚èπ D·ª´ng ƒë·ªçc
                        </button>
                    </div>
                    
                    <div class="audio-visualizer" id="audioVisualizer">
                        <!-- Thanh √¢m thanh s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
                    </div>
                    
                    <div class="word-list" id="wordList">Ch∆∞a c√≥ t·ª´ n√†o</div>
                    <div class="word-count">S·ªë t·ª´ trong c√¢u: <span id="wordCount">0</span>/10</div>
                    
                    <div style="display: flex; justify-content: space-around; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div>
                            <div class="sensor-label">KHE 1</div>
                            <div class="sensor-value" id="slot1" style="font-size: 1.2rem;">---</div>
                        </div>
                        <div>
                            <div class="sensor-label">KHE 2</div>
                            <div class="sensor-value" id="slot2" style="font-size: 1.2rem;">---</div>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <button onclick="clearCurrentWord()" class="red">X√≥a t·ª´ hi·ªán t·∫°i</button>
                        <button onclick="backspace()">X√≥a k√Ω t·ª±</button>
                        <button onclick="addWordToSentence()" class="green">Th√™m t·ª´ (_)</button>
                        <button onclick="commitSentence()" class="blue">Ho√†n th√†nh c√¢u</button>
                        <button onclick="resetSentence()" class="red">ƒê·∫∑t l·∫°i t·∫•t c·∫£</button>
                    </div>
                </div>
            </div>

            <!-- Card D·ªãch thu·∫≠t -->
            <div class="card">
                <h3>D·ªãch thu·∫≠t</h3>
                <div style="margin-bottom: 20px;">
                    <div class="sensor-label">C√ÇU ƒê·∫¶Y ƒê·ª¶ (Ti·∫øng Vi·ªát - ƒê·ªÉ d·ªãch)</div>
                    <div class="text-input-container">
                        <textarea id="translationInput" placeholder="Nh·∫≠p vƒÉn b·∫£n ti·∫øng Vi·ªát ·ªü ƒë√¢y..." 
                                  oninput="handleTranslationInput()"></textarea>
                        <div class="dynamic-suggestions" id="translationSuggestions">
                            <!-- ƒê·ªÅ xu·∫•t ƒë·ªông cho d·ªãch thu·∫≠t -->
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div><strong>T√πy ch·ªçn d·ªãch thu·∫≠t:</strong></div>
                        <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                            <div>
                                <div class="sensor-label">Ng√¥n ng·ªØ ƒë√≠ch</div>
                                <select id="targetLanguage" class="language-select">
                                    <option value="en-GB">Ti·∫øng Anh</option>
                                    <option value="ja-JP">Ti·∫øng Nh·∫≠t</option>
                                    <option value="ko-KR">Ti·∫øng H√†n</option>
                                    <option value="zh-CN">Ti·∫øng Trung</option>
                                </select>
                            </div>
                            <div>
                                <div class="sensor-label">Ng√¥n ng·ªØ gi·ªçng n√≥i</div>
                                <select id="voiceLanguage" class="language-select">
                                    <option value="vi-VN">Ti·∫øng Vi·ªát</option>
                                    <option value="en-GB">Ti·∫øng Anh</option>
                                    <option value="ja-JP">Ti·∫øng Nh·∫≠t</option>
                                    <option value="ko-KR">Ti·∫øng H√†n</option>
                                    <option value="zh-CN">Ti·∫øng Trung</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sensor-label">K·∫æT QU·∫¢ D·ªäCH</div>
                <div id="translationOutput" class="conversion-display" style="min-height: 80px; margin-bottom: 15px;">
                    ƒêang ch·ªù d·ªãch...
                </div>

                <div class="controls">
                    <button onclick="translateSentence()" class="blue">D·ªãch c√¢u</button>
                    <button onclick="clearTranslation()" class="red">X√≥a b·∫£n d·ªãch</button>
                </div>
            </div>

            <!-- Card Hi·ªÉn th·ªã C·∫£m bi·∫øn -->
            <div class="card">
                <h3>D·ªØ li·ªáu C·∫£m bi·∫øn t·ª´ Firebase</h3>
                <div class="sensor-grid">
                    <div class="sensor-item mpu">
                        <div class="sensor-label">ƒê·ªäNH H∆Ø·ªöNG MPU6050</div>
                        <div class="sensor-value" id="mpuOrientation">Kh√¥ng x√°c ƒë·ªãnh</div>
                        <div class="sensor-label">TR·∫†NG TH√ÅI L·∫ÆC</div>
                        <div class="sensor-value" id="mpuShakeState">Kh√¥ng</div>
                        <div class="sensor-label">ƒêANG L·∫ÆC?</div>
                        <div class="sensor-value" id="isShaking">KH√îNG</div>
                    </div>
                    <div class="sensor-item flex">
                        <div class="sensor-label">C·∫¢M BI·∫æN U·ªêN</div>
                        <div>
                            <div>
                                <span class="flex-box" id="flex0-box">0</span>
                                <span class="flex-box" id="flex1-box">0</span>
                                <span class="flex-box" id="flex2-box">0</span>
                                <span class="flex-box" id="flex3-box">0</span>
                            </div>
                            <div class="sensor-label" style="margin-top: 10px;">
                                Gi√° tr·ªã th√¥: <span id="rawValues">0, 0, 0, 0</span>
                            </div>
                            <div class="sensor-label">
                                Tr·∫°ng th√°i: <span id="flexFormat">0000</span> (a0,a1,a2,a3)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="sensor-item" style="margin-top: 15px;">
                    <div class="sensor-label">TR·∫†NG TH√ÅI H·ªÜ TH·ªêNG</div>
                    <div>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="lastUpdateTime" class="last-update">Ch∆∞a bao gi·ªù</span></div>
                </div>
                
                <div class="controls" style="margin-top: 15px;">
                    <button onclick="refreshData()" class="blue">L√†m m·ªõi ngay</button>
                    <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="green">T·ª± ƒë·ªông: B·∫¨T</button>
                </div>
            </div>

            <!-- Card Hi·ªÉn th·ªã Nh·∫≠t k√Ω -->
            <div class="card">
                <h3>Nh·∫≠t k√Ω H·ªá th·ªëng</h3>
                <div style="max-height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 10px;">
                    <div id="logContainer">
                        <div class="log-entry">H·ªá th·ªëng ƒë√£ kh·ªüi ƒë·ªông. ƒêang ch·ªù d·ªØ li·ªáu Firebase...</div>
                    </div>
                </div>
                <div class="controls" style="margin-top: 15px;">
                    <button onclick="clearLog()" class="red">X√≥a nh·∫≠t k√Ω</button>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div>
                <span class="indicator" id="connectionStatus"></span>
                <span id="statusText">ƒêang k·∫øt n·ªëi v·ªõi Firebase...</span>
            </div>
            <div>
                <span id="lastUpdate">C·∫≠p nh·∫≠t Firebase l·∫ßn cu·ªëi: --:--:--</span>
            </div>
        </div>
    </div>

    <script>
        // =================== C·∫§U H√åNH T·ªêI ∆ØU ===================
        // C·∫•u h√¨nh Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDdUj2SX83qODeZ1hhru0e9KN1fwDrtUP8",
            authDomain: "gangtay-f1efe.firebaseapp.com",
            databaseURL: "https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gangtay-f1efe",
            storageBucket: "gangtay-f1efe.appspot.com",
            messagingSenderId: "1041559675155",
            appId: "1:1041559675155:web:bd4235af3913248f9a2385"
        };
        
        // C·∫•u h√¨nh API Gemini TTS
        const GEMINI_API_KEY = "AIzaSyDdUj2SX83qODeZ1hhru0e9KN1fwDrtUP8";
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent";
        
        // =================== B·∫¢NG D·ªÆ LI·ªÜU ===================
        // B·∫£ng t·ª´ ESP32 code
        const tableA = [
            ["IAY","IC","ICH","IE","IEC","IEM","IEN","IENG","IEO"],
            ["IEP","IET","IEU","IM","IN","ING","INH","IO","IOI"],
            ["ENG","ENH","EO","EP","ET","EU","I","IA","IAC"],
            ["IAI","IAM","IAN","IANG","IANH","IAO","IAP","IAT","IAU"],
            ["AP","AT","AU","AY","E","EC","ECH","EM","EN"],
            ["A","AC","ACH","AI","AM","AN","ANG","ANH","AO"],
            ["IUN","IUONG","IUP","O","OA","OAC","OACH","OAI","OAM"],
            ["ION","IONG","IOT","IP","IT","IU","IUA","IUC","IUI"]
        ];

        const tableB = [
            ["UE","UECH","UEN","UENH","UEO","UET","UI","UM","UN"],
            ["UNG","UO","UOC","UOI","UOM","UON","UONG","UOP","OUT"],
            ["ONG","OOC","OONG","OP","OT","U","UA","UAC","UACH"],
            ["UAI","UAM","UAN","UANG","UANH","UAO","UAT","UAY","UC"],
            ["OAY","OC","OE","OEN","OEO","OET","OI","OM","ON"],
            ["COMMIT","_","nullptr","nullptr","OAN","OANG","OANH","OAP","OAT"],
            ["UYNH","UYP","UYT","UYU","Y","YEM","YEN","YET","YEU"],
            ["UOU","UP","UT","UU","UY","UYA","UYCH","UYEN","UYET"]
        ];

        const tableC = [
            [ ["B","C","D"],["ƒê","G","H"],["K","L","M"] ],
            [ ["N","P","Q"],["R","S","T"],["V","X","CH"] ],
            [ ["GH","KH","NG"],["NGH","NH","PH"],["TH","TR","_"] ]
        ];

        // B·∫£ng chuy·ªÉn ƒë·ªïi Ti·∫øng Vi·ªát (b·∫£ng ƒë·∫ßy ƒë·ªß t·ª´ ESP32 code)
        const vietnameseTable = [
            {key: "IAY", forms: ["i√°y", "i√†y", "i·∫£y", "i√£y", "i·∫°y", "iay", "i·∫•y", "i·∫ßy", "i·∫©y", "i·∫´y", "i·∫≠y", "i√¢y", "i·∫Øy", "i·∫±y", "i·∫≥y", "i·∫µy", "i·∫∑y", "iƒÉy"]},
            {key: "IC", forms: ["√≠c", "√¨c", "·ªâc", "ƒ©c", "·ªãc", "ic", "√≠c", "√¨c", "·ªâc", "ƒ©c", "·ªãc", "ic", "√≠c", "√¨c", "·ªâc", "ƒ©c", "·ªãc", "ic"]},
            {key: "ICH", forms: ["√≠ch", "√¨ch", "·ªâch", "ƒ©ch", "·ªãch", "ich", "√≠ch", "√¨ch", "·ªâch", "ƒ©ch", "·ªãch", "ich", "√≠ch", "√¨ch", "·ªâch", "ƒ©ch", "·ªãch", "ich"]},
            {key: "IE", forms: ["i√©", "i√®", "i·∫ª", "i·∫Ω", "i·∫π", "ie", "i·∫ø", "i·ªÅ", "i·ªÉ", "i·ªÖ", "i·ªá", "i√™", "i√©", "i√®", "i·∫ª", "i·∫Ω", "i·∫π", "ie"]},
            {key: "IEC", forms: ["i√©c", "i√®c", "i·∫ªc", "i·∫Ωc", "i·∫πc", "iec", "i·∫øc", "i·ªÅc", "i·ªÉc", "i·ªÖc", "i·ªác", "i√™c", "i√©c", "i√®c", "i·∫ªc", "i·∫Ωc", "i·∫πc", "iec"]},
            {key: "IEM", forms: ["i√©m", "i√®m", "i·ªÉm", "i·∫Ωm", "·ªãem", "iem", "i·∫øm", "i·ªÅm", "i·ªÉm", "i·ªÖm", "i·ªám", "i√™m", "i√©m", "i√®m", "i·ªÉm", "i·∫Ωm", "·ªãem", "iem"]},
            {key: "IEN", forms: ["ien", "i√®n", "i·∫ªn", "i·∫Ωn", "i·∫πn", "ien", "i√™n", "i·ªÅn", "i·ªÉn", "i·ªÖn", "i·ªán", "i√™n", "ien", "i√®n", "i·∫ªn", "i·∫Ωn", "i·∫πn", "ien"]},
            {key: "IENG", forms: ["ieng", "i√®ng", "i·∫ªng", "i·∫Ωng", "i·∫πng", "ieng", "i√™ng", "i·ªÅng", "i·ªÉng", "i·ªÖng", "i·ªáng", "i√™ng", "ieng", "i√®ng", "i·∫ªng", "i·∫Ωng", "i·∫πng", "ieng"]},
            {key: "IEO", forms: ["i√©o", "i√®o", "i·∫ªo", "i·∫Ωo", "i·∫πo", "ieo", "i·∫øo", "i·ªÅo", "i·ªÉo", "i·ªÖo", "i·ªáo", "i√™o", "i√©o", "i√®o", "i·∫ªo", "i·∫Ωo", "i·∫πo", "ieo"]},
            {key: "IEP", forms: ["i√©p", "i√®p", "i·∫ªp", "i·∫Ωp", "i·∫πp", "iep", "i·∫øp", "i·ªÅp", "i·ªÉp", "i·ªÖp", "i·ªáp", "i√™p", "i√©p", "i√®p", "i·∫ªp", "i·∫Ωp", "i·∫πp", "iep"]},
            {key: "IET", forms: ["i√©t", "i√®t", "i·∫ªt", "i·∫Ωt", "i·∫πt", "iet", "i·∫øt", "i·ªÅt", "i·ªÉt", "i·ªÖt", "i·ªát", "i√™t", "i√©t", "i√®t", "i·∫ªt", "i·∫Ωt", "i·∫πt", "iet"]},
            {key: "IEU", forms: ["i√©u", "i√®u", "i·∫ªu", "i·∫Ωu", "i·∫πu", "ieu", "i·∫øu", "i·ªÅu", "i·ªÉu", "i·ªÖu", "i·ªáu", "i√™u", "i√©u", "i√®u", "i·∫ªu", "i·∫Ωu", "i·∫πu", "ieu"]},
            {key: "IM", forms: ["√≠m", "√¨m", "·ªâm", "ƒ©m", "·ªãm", "im", "√≠m", "√¨m", "·ªâm", "ƒ©m", "·ªãm", "im", "√≠m", "√¨m", "·ªâm", "ƒ©m", "·ªãm", "im"]},
            {key: "IN", forms: ["√≠n", "√¨n", "·ªân", "ƒ©n", "·ªãn", "in", "√≠n", "√¨n", "·ªân", "ƒ©n", "·ªãn", "in", "√≠n", "√¨n", "·ªân", "ƒ©n", "·ªãn", "in"]},
            {key: "ING", forms: ["√≠ng", "√¨ng", "·ªâng", "ƒ©ng", "·ªãng", "ing", "√≠ng", "√¨ng", "·ªâng", "ƒ©ng", "·ªãng", "ing", "√≠ng", "√¨ng", "·ªâng", "ƒ©ng", "·ªãng", "ing"]},
            {key: "INH", forms: ["√≠nh", "√¨nh", "·ªânh", "ƒ©nh", "·ªãnh", "inh", "√≠nh", "√¨nh", "·ªânh", "ƒ©nh", "·ªãnh", "inh", "√≠nh", "√¨nh", "·ªânh", "ƒ©nh", "·ªãnh", "inh"]},
            {key: "IO", forms: ["i√≥", "i√≤", "i·ªè", "i√µ", "i·ªç", "io", "i·ªë", "i·ªì", "i·ªï", "i·ªó", "i·ªô", "i√¥", "i·ªõ", "i·ªù", "i·ªü", "i·ª°", "i·ª£", "i∆°"]},
            {key: "IOI", forms: ["i√≥i", "i√≤i", "i·ªèi", "i√µi", "i·ªçi", "ioi", "i·ªëi", "i·ªìi", "i·ªïi", "i·ªói", "i·ªôi", "i√¥i", "i·ªõi", "i·ªùi", "i·ªüi", "i·ª°i", "i·ª£i", "i∆°i"]},
            {key: "I", forms: ["√≠", "√¨", "·ªâ", "ƒ©", "·ªã", "i", "√≠", "√¨", "·ªâ", "ƒ©", "·ªã", "i", "√≠", "√¨", "·ªâ", "ƒ©", "·ªã", "i"]},
            {key: "IA", forms: ["√≠a", "√¨a", "·ªâa", "ƒ©a", "·ªãa", "ia", "√≠a", "√¨a", "·ªâa", "ƒ©a", "·ªãa", "ia", "√≠a", "√¨a", "·ªâa", "ƒ©a", "·ªãa", "ia"]},
            {key: "IAI", forms: ["i√°i", "i√†i", "i·∫£i", "i√£i", "i·∫°i", "iai", "i·∫•i", "i·∫ßi", "i·∫©i", "i·∫´i", "i·∫≠i", "i√¢i", "i·∫Øi", "i·∫±i", "i·∫≥i", "i·∫µi", "i·∫∑i", "iƒÉi"]},
            {key: "IAM", forms: ["i√°m", "i√†m", "i·∫£m", "i√£m", "i·∫°m", "iam", "i·∫•m", "i·∫ßm", "i·∫©m", "i·∫´m", "i·∫≠m", "i√¢m", "i·∫Øm", "i·∫±m", "i·∫≥m", "i·∫µm", "i·∫∑m", "iƒÉm"]},
            {key: "IAN", forms: ["i√°n", "i√†n", "i·∫£n", "i√£n", "i·∫°n", "ian", "i·∫•n", "i·∫ßn", "i·∫©n", "i·∫´n", "i·∫≠n", "i√¢n", "i·∫Øn", "i·∫±n", "i·∫≥n", "i·∫µn", "i·∫∑n", "iƒÉn"]},
            {key: "IANG", forms: ["i√°ng", "i√†ng", "i·∫£ng", "i√£ng", "i·∫°ng", "iang", "i·∫•ng", "i·∫ßng", "i·∫©ng", "i·∫´ng", "i·∫≠ng", "i√¢ng", "i·∫Øng", "i·∫±ng", "i·∫≥ng", "i·∫µng", "i·∫∑ng", "iƒÉng"]},
            {key: "IANH", forms: ["i√°nh", "i√†nh", "i·∫£nh", "i√£nh", "i·∫°nh", "ianh", "i·∫•nh", "i·∫ßnh", "i·∫©nh", "i·∫´nh", "i·∫≠nh", "i√¢nh", "i·∫Ønh", "i·∫±nh", "i·∫≥nh", "i·∫µnh", "i·∫∑nh", "iƒÉnh"]},
            {key: "IAO", forms: ["i√°o", "i√†o", "i·∫£o", "i√£o", "i·∫°o", "iao", "i√°o", "i√†o", "i·∫£o", "i√£o", "i·∫°o", "iao", "i√°o", "i√†o", "i·∫£o", "i√£o", "i·∫°o", "iao"]},
            {key: "IAP", forms: ["i√°p", "i√†p", "i·∫£p", "i√£p", "i·∫°p", "iap", "i·∫•p", "i·∫ßp", "i·∫©p", "i·∫´p", "i·∫≠p", "i√¢p", "i·∫Øp", "i·∫±p", "i·∫≥p", "i·∫µp", "i·∫∑p", "iƒÉp"]},
            {key: "IAT", forms: ["i√°t", "i√†t", "i·∫£t", "i√£t", "i·∫°t", "iat", "i·∫•t", "i·∫ßt", "i·∫©t", "i·∫´t", "i·∫≠t", "i√¢t", "i·∫Øt", "i·∫±t", "i·∫≥t", "i·∫µt", "i·∫∑t", "iƒÉt"]},
            {key: "IAU", forms: ["i√°u", "i√†u", "i·∫£u", "i√£u", "i·∫°u", "iau", "i·∫•u", "i·∫ßu", "i·∫©u", "i·∫´u", "i·∫≠u", "i√¢u", "i√°u", "i√†u", "i·∫£u", "i√£u", "i·∫°u", "iau"]},
            {key: "AP", forms: ["√°p", "√†p", "·∫£p", "√£p", "·∫°p", "ap", "·∫•p", "·∫ßp", "·∫©p", "·∫´p", "·∫≠p", "√¢p", "·∫Øp", "·∫±p", "·∫≥p", "·∫µp", "·∫∑p", "ƒÉp"]},
            {key: "AT", forms: ["√°t", "√†t", "·∫£t", "√£t", "·∫°t", "at", "·∫•t", "·∫ßt", "·∫©t", "·∫´t", "·∫≠t", "√¢t", "·∫Øt", "·∫±t", "·∫≥t", "·∫µt", "·∫∑t", "ƒÉt"]},
            {key: "AU", forms: ["√°u", "√†u", "·∫£u", "√£u", "·∫°u", "au", "·∫•u", "·∫ßu", "·∫©u", "·∫´u", "·∫≠u", "√¢u", "·∫Øu", "·∫±u", "·∫≥u", "·∫µu", "·∫∑u", "ƒÉu"]},
            {key: "AY", forms: ["√°y", "√†y", "·∫£y", "√£y", "·∫°y", "ay", "·∫•y", "·∫ßy", "·∫©y", "·∫´y", "·∫≠y", "√¢y", "·∫Øy", "·∫±y", "·∫≥y", "·∫µy", "·∫∑y", "ƒÉy"]},
            {key: "E", forms: ["√©", "√®", "·∫ª", "·∫Ω", "·∫π", "e", "·∫ø", "·ªÅ", "·ªÉ", "·ªÖ", "·ªá", "√™", "√©", "√®", "·∫ª", "·∫Ω", "·∫π", "e"]},
            {key: "EM", forms: ["√©m", "√®m", "·ªÉm", "·∫Ωm", "·∫πm", "em", "·∫øm", "·ªÅm", "·ªÉm", "·ªÖm", "·ªám", "√™m", "√©m", "√®m", "·ªÉm", "·∫Ωm", "·∫πm", "em"]},
            {key: "EN", forms: ["√©n", "√®n", "·ªÉn", "·ªÖn", "·ªán", "en", "·∫øn", "·ªÅn", "·ªÉn", "·ªÖn", "·ªán", "√™n", "√©n", "√®n", "·ªÉn", "·ªÖn", "·ªán", "en"]},
            {key: "A", forms: ["√°", "√†", "·∫£", "√£", "·∫°", "a", "·∫•", "·∫ß", "·∫©", "·∫´", "·∫≠", "√¢", "·∫Ø", "·∫±", "·∫≥", "·∫µ", "·∫∑", "ƒÉ"]},
            {key: "AI", forms: ["√°i", "√†i", "·∫£i", "√£i", "·∫°i", "ai", "·∫•i", "·∫ßi", "·∫©i", "·∫´i", "·∫≠i", "√¢i", "·∫Øi", "·∫±i", "·∫≥i", "·∫µi", "·∫∑i", "ƒÉi"]},
            {key: "AM", forms: ["√°m", "√†m", "·∫£m", "√£m", "·∫°m", "am", "·∫•m", "·∫ßm", "·∫©m", "·∫´m", "·∫≠m", "√¢m", "·∫Øm", "·∫±m", "·∫≥m", "·∫µm", "·∫∑m", "ƒÉm"]},
            {key: "AN", forms: ["√°n", "√†n", "·∫£n", "√£n", "·∫°n", "an", "·∫•n", "·∫ßn", "·∫©n", "·∫´n", "·∫≠n", "√¢n", "·∫Øn", "·∫±n", "·∫≥n", "·∫µn", "·∫∑n", "ƒÉn"]},
            {key: "ANG", forms: ["√°ng", "√†ng", "·∫£ng", "√£ng", "·∫°ng", "ang", "·∫•ng", "·∫ßng", "·∫©ng", "·∫´ng", "·∫≠ng", "√¢ng", "·∫Øng", "·∫±ng", "·∫≥ng", "·∫µng", "·∫∑ng", "ƒÉng"]},
            {key: "ANH", forms: ["√°nh", "√†nh", "·∫£nh", "√£nh", "·∫°nh", "anh", "·∫•nh", "·∫ßnh", "·∫©nh", "·∫´nh", "·∫≠nh", "√¢nh", "·∫Ønh", "·∫±nh", "·∫≥nh", "·∫µnh", "·∫∑nh", "ƒÉnh"]},
            {key: "AO", forms: ["√°o", "√†o", "·∫£o", "√£o", "·∫°o", "ao", "·∫•o", "·∫ßo", "·∫©o", "·∫´o", "·∫≠o", "√¢o", "·∫Øo", "·∫±o", "·∫≥o", "·∫µo", "·∫∑o", "ƒÉo"]},
            {key: "UE", forms: ["u√©", "u√®", "u·∫ª", "u·∫Ω", "u·∫π", "ue", "u·∫ø", "u·ªÅ", "u·ªÉ", "u·ªÖ", "u·ªá", "u√™", "∆∞√©", "∆∞√®", "∆∞·∫ª", "∆∞·∫Ω", "∆∞·∫π", "∆∞e"]},
            {key: "UEN", forms: ["u√™n", "u·ªÅn", "u·ªÉn", "u·ªÖn", "u·ªán", "uen", "u√™n", "u·ªÅn", "u·ªÉn", "u·ªÖn", "u·ªán", "u√™n", "∆∞√™n", "∆∞·ªÅn", "∆∞·ªÉn", "∆∞·ªÖn", "∆∞·ªán", "∆∞en"]},
            {key: "UI", forms: ["√∫i", "√πi", "·ªßi", "≈©i", "·ª•i", "ui", "√∫i", "√πi", "·ªßi", "≈©i", "·ª•i", "ui", "·ª©i", "·ª´i", "·ª≠i", "·ªØi", "·ª±i", "∆∞i"]},
            {key: "UM", forms: ["√∫m", "√πm", "·ªßm", "≈©m", "·ª•m", "um", "√∫m", "√πm", "·ªßm", "≈©m", "·ª•m", "um", "·ª©m", "·ª´m", "·ª≠m", "·ªØm", "·ª±m", "∆∞m"]},
            {key: "UN", forms: ["√∫n", "√πn", "·ªßn", "≈©n", "·ª•n", "un", "√∫n", "√πn", "·ªßn", "≈©n", "·ª•n", "un", "·ª©n", "·ª´n", "·ª≠n", "·ªØn", "·ª±n", "∆∞n"]},
            {key: "UNG", forms: ["√∫ng", "√πng", "·ªßng", "≈©ng", "·ª•ng", "ung", "√∫ng", "√πng", "·ªßng", "≈©ng", "·ª•ng", "ung", "·ª©ng", "·ª´ng", "·ª≠ng", "·ªØng", "·ª±ng", "∆∞ng"]},
            {key: "UO", forms: ["u√≥", "u√≤", "u·ªè", "u√µ", "u·ªç", "uo", "u·ªë", "u·ªì", "u·ªï", "u·ªó", "u·ªô", "u√¥", "∆∞·ªõ", "∆∞·ªù", "∆∞·ªü", "∆∞·ª°", "∆∞·ª£", "∆∞∆°"]},
            {key: "UOC", forms: ["u·ªëc", "u·ªôc", "u·ªïc", "u·ªóc", "u·ªôc", "uoc", "u·ªëc", "u·ªôc", "u·ªïc", "u·ªóc", "u·ªôc", "u√¥c", "∆∞·ªëc", "∆∞·ªôc", "∆∞·ªïc", "∆∞·ªóc", "∆∞·ªôc", "∆∞∆°c"]},
            {key: "UOI", forms: ["u·ªëi", "u·ªìi", "u·ªïi", "u·ªói", "u·ªôi", "uoi", "u·ªëi", "u·ªìi", "u·ªïi", "u·ªói", "u·ªôi", "u√¥i", "∆∞·ªëi", "∆∞·ªìi", "∆∞·ªïi", "∆∞·ªói", "∆∞·ªôi", "∆∞∆°i"]},
            {key: "UON", forms: ["u√≥n", "u√≤n", "u·ªèn", "u√µn", "u·ªçn", "uon", "u·ªën", "u·ªìn", "u·ªïn", "u·ªón", "u·ªôn", "u√¥n", "∆∞·ªõn", "∆∞·ªùn", "∆∞·ªün", "∆∞·ª°n", "∆∞·ª£n", "∆∞∆°n"]},
            {key: "UONG", forms: ["u√≥ng", "u√≤ng", "u·ªèng", "u√µng", "u·ªçng", "uong", "u·ªëng", "u·ªìng", "u·ªïng", "u·ªóng", "u·ªông", "u√¥ng", "∆∞·ªõng", "∆∞·ªùng", "∆∞·ªüng", "∆∞·ª°ng", "∆∞·ª£ng", "∆∞∆°ng"]},
            {key: "ONG", forms: ["√≥ng", "√≤ng", "·ªèng", "√µng", "·ªçng", "ong", "·ªëng", "·ªìng", "·ªïng", "·ªóng", "·ªông", "√¥ng", "·ªõng", "·ªùng", "·ªüng", "·ª°ng", "·ª£ng", "∆°ng"]},
            {key: "OP", forms: ["√≥p", "√≤p", "·ªèp", "√µp", "·ªçp", "op", "·ªëp", "·ªìp", "·ªïp", "·ªóp", "·ªôp", "√¥p", "·ªõp", "·ªùp", "·ªüp", "·ª°p", "·ª£p", "∆°p"]},
            {key: "OT", forms: ["√≥t", "√≤t", "·ªèt", "√µt", "·ªçt", "ot", "·ªët", "·ªìt", "·ªït", "·ªót", "·ªôt", "√¥t", "·ªõt", "·ªùt", "·ªüt", "·ª°t", "·ª£t", "∆°t"]},
            {key: "U", forms: ["√∫", "√π", "·ªß", "≈©", "·ª•", "u", "√∫", "√π", "·ªß", "≈©", "·ª•", "u", "·ª©", "·ª´", "·ª≠", "·ªØ", "·ª±", "∆∞"]},
            {key: "UA", forms: ["√∫a", "√πa", "·ªßa", "≈©a", "·ª•a", "ua", "√∫a", "√πa", "·ªßa", "≈©a", "·ª•a", "ua", "√∫a", "√πa", "·ªßa", "≈©a", "·ª•a", "ua"]},
            {key: "UAI", forms: ["u√°i", "u√†i", "u·∫£i", "u√£i", "u·∫°i", "uai", "u·∫•i", "u·∫ßi", "u·∫©i", "u·∫´i", "u·∫≠i", "u√¢i", "u√°i", "u√†i", "u·∫£i", "u√£i", "u·∫°i", "uai"]},
            {key: "UAN", forms: ["u√°n", "u√†n", "u·∫£n", "u√£n", "u·∫°n", "uan", "u·∫•n", "u·∫ßn", "u·∫©n", "u·∫´n", "u·∫≠n", "u√¢n", "u·∫Øn", "u·∫±n", "u·∫≥n", "u·∫µn", "u·∫∑n", "uƒÉn"]},
            {key: "UANG", forms: ["u√°ng", "u√†ng", "u·∫£ng", "u√£ng", "u·∫°ng", "uang", "u·∫•ng", "u·∫ßng", "u·∫©ng", "u·∫´ng", "u·∫≠ng", "u√¢ng", "u·∫Øng", "u·∫±ng", "u·∫≥ng", "u·∫µng", "u·∫∑ng", "uƒÉng"]},
            {key: "UANH", forms: ["u√°nh", "u√†nh", "u·∫£nh", "u√£nh", "u·∫°nh", "uanh", "u·∫•nh", "u·∫ßnh", "u·∫©nh", "u·∫´nh", "u·∫≠nh", "u√¢nh", "u·∫Ønh", "u·∫±nh", "u·∫≥nh", "u·∫µnh", "u·∫∑nh", "uƒÉnh"]},
            {key: "UAY", forms: ["u√°y", "u√†y", "u·∫£y", "u√£y", "u·∫°y", "uay", "u·∫•y", "u·∫ßy", "u·∫©y", "u·∫´y", "u·∫≠y", "u√¢y", "u·∫Øy", "u·∫±y", "u·∫≥y", "u·∫µy", "u·∫∑y", "uƒÉy"]},
            {key: "UC", forms: ["√∫c", "√πc", "·ªßc", "≈©c", "·ª•c", "uc", "√∫c", "√πc", "·ªßc", "≈©c", "·ª•c", "uc", "·ª©c", "·ª´c", "·ª≠c", "·ªØc", "·ª±c", "∆∞c"]},
            {key: "OAY", forms: ["o√°y", "o√†y", "o·∫£y", "o√£y", "o·∫°y", "oay", "o√°y", "o√†y", "o·∫£y", "o√£y", "o·∫°y", "oay", "o√°y", "o√†y", "o·∫£y", "o√£y", "o·∫°y", "oay"]},
            {key: "OC", forms: ["√≥c", "√≤c", "·ªèc", "√µc", "·ªçc", "oc", "·ªëc", "·ªìc", "·ªïc", "·ªóc", "·ªôc", "√¥c", "·ªõc", "·ªùc", "·ªüc", "·ª°c", "·ª£c", "∆°c"]},
            {key: "OE", forms: ["√≥e", "√≤e", "·ªèe", "√µe", "·ªçe", "oe", "√≥e", "√≤e", "·ªèe", "√µe", "·ªçe", "oe", "√≥e", "√≤e", "·ªèe", "√µe", "·ªçe", "oe"]},
            {key: "OI", forms: ["√≥i", "√≤i", "·ªèi", "√µi", "·ªçi", "oi", "·ªëi", "·ªìi", "·ªïi", "·ªói", "·ªôi", "√¥i", "·ªõi", "·ªùi", "·ªüi", "·ª°i", "·ª£i", "∆°i"]},
            {key: "OM", forms: ["√≥m", "√≤m", "·ªèm", "√µm", "·ªçm", "om", "·ªëm", "·ªìm", "·ªïm", "·ªóm", "·ªôm", "√¥m", "·ªõm", "·ªùm", "·ªüm", "·ª°m", "·ª£m", "∆°m"]},
            {key: "ON", forms: ["√≥n", "√≤n", "·ªèn", "√µn", "·ªçn", "on", "·ªën", "·ªìn", "·ªïn", "·ªón", "·ªôn", "√¥n", "·ªõn", "·ªùn", "·ªün", "·ª°n", "·ª£n", "∆°n"]},
            {key: "OAN", forms: ["o√°n", "o√†n", "o·∫£n", "o√£n", "o·∫°n", "oan", "o√°n", "o√†n", "o·∫£n", "o√£n", "o·∫°n", "oan", "o√°n", "o√†n", "o·∫£n", "o√£n", "o·∫°n", "oan"]},
            {key: "OANG", forms: ["o√°ng", "o√†ng", "o·∫£ng", "o√£ng", "o·∫°ng", "oang", "o√°ng", "o√†ng", "o·∫£ng", "o√£ng", "o·∫°ng", "oang", "o√°ng", "o√†ng", "o·∫£ng", "o√£ng", "o·∫°ng", "oang"]},
            {key: "OANH", forms: ["o√°nh", "o√†nh", "o·∫£nh", "o√£nh", "o·∫°nh", "oanh", "o√°nh", "o√†nh", "o·∫£nh", "o√£nh", "o·∫°nh", "oanh", "o√°nh", "o√†nh", "o·∫£nh", "o√£nh", "o·∫°nh", "oanh"]},
            {key: "OAT", forms: ["o√°t", "√≤at", "o·∫£t", "o√£t", "o·∫°t", "oat", "o√°t", "√≤at", "o·∫£t", "o√£t", "o·∫°t", "oat", "o√°t", "√≤at", "o·∫£t", "o√£t", "o·∫°t", "oat"]},
            {key: "Y", forms: ["√Ω", "·ª≥", "·ª∑", "·ªπ", "·ªµ", "y", "√Ω", "·ª≥", "·ª∑", "·ªπ", "·ªµ", "y", "√Ω", "·ª≥", "·ª∑", "·ªπ", "·ªµ", "y"]},
            {key: "YEN", forms: ["yen", "y√®n", "y·∫ªn", "y·∫Ωn", "y·∫πn", "yen", "y√™n", "y·ªÅn", "y·ªÉn", "y·ªÖn", "y·ªán", "y√™n", "yen", "y√®n", "y·∫ªn", "y·∫Ωn", "y·∫πn", "yen"]},
            {key: "YET", forms: ["y√©t", "y√®t", "y·∫ªt", "y·∫Ωt", "y·∫πt", "yet", "y·∫øt", "y·ªÅt", "y·ªÉt", "y·ªÖt", "y·ªát", "y√™t", "y√©t", "y√®t", "y·∫ªt", "y·∫Ωt", "y·∫πt", "yet"]},
            {key: "YEU", forms: ["y√™u", "y·ªÅu", "y·ªÉu", "y·ªÖu", "y·ªáu", "yeu", "y√™u", "y·ªÅu", "y·ªÉu", "y·ªÖu", "y·ªáu", "y√™u", "y√™u", "y·ªÅu", "y·ªÉu", "y·ªÖu", "y·ªáu", "yeu"]},
            {key: "UY", forms: ["√∫y", "√πy", "·ªßy", "≈©y", "·ª•y", "uy", "√∫y", "√πy", "·ªßy", "≈©y", "·ª•y", "uy", "·ª©y", "·ª´y", "·ª≠y", "·ªØy", "·ª±y", "∆∞y"]},
            {key: "UYET", forms: ["uy√©t", "uy√®t", "uy·∫ªt", "uy·∫Ωt", "uy·∫πt", "uyet", "uy·∫øt", "uy·ªÅt", "uy·ªÉt", "uy·ªÖt", "uy·ªát", "uy√™t", "uy√©t", "uy√®t", "uy·∫ªt", "uy·∫Ωt", "uy·∫πt", "uyet"]},
            {key: "AC", forms: ["√°c", "√†c", "·∫£c", "√£c", "·∫°c", "ac", "·∫•c", "·∫ßc", "·∫©c", "·∫´c", "·∫≠c", "√¢c", "·∫Øc", "·∫±c", "·∫≥c", "·∫µc", "·∫∑c", "ƒÉc"]},
            {key: "ACH", forms: ["√°ch", "√†ch", "·∫£ch", "√£ch", "·∫°ch", "ach", "·∫•ch", "·∫ßch", "·∫©ch", "·∫´ch", "·∫≠ch", "√¢ch", "·∫Øch", "·∫±ch", "·∫≥ch", "·∫µch", "·∫∑ch", "ƒÉch"]},
            {key: "EC", forms: ["√©c", "√®c", "·∫ªc", "·∫Ωc", "·∫πc", "ec", "·∫øc", "·ªÅc", "·ªÉc", "·ªÖc", "·ªác", "√™c", "√©c", "√®c", "·∫ªc", "·∫Ωc", "·∫πc", "ec"]},
            {key: "ECH", forms: ["√©ch", "√®ch", "·∫ªch", "·∫Ωch", "·∫πch", "ech", "·∫øch", "·ªÅch", "·ªÉch", "·ªÖch", "·ªách", "√™ch", "√©ch", "√®ch", "·∫ªch", "·∫Ωch", "·∫πch", "ech"]},
            {key: "ENG", forms: ["√©ng", "√®ng", "·∫ªng", "·∫Ωng", "·∫πng", "eng", "·∫øng", "·ªÅng", "·ªÉng", "·ªÖng", "·ªáng", "√™ng", "√©ng", "√®ng", "·∫ªng", "·∫Ωng", "·∫πng", "eng"]},
            {key: "ENH", forms: ["enh", "√®nh", "·∫ªnh", "·∫Ωnh", "·∫πnh", "enh", "·∫ønh", "·ªÅnh", "·ªÉnh", "·ªÖnh", "·ªánh", "√™nh", "enh", "√®nh", "·∫ªnh", "·∫Ωnh", "·∫πnh", "enh"]},
            {key: "EO", forms: ["√©o", "√®o", "·∫ªo", "·∫Ωo", "·∫πo", "eo", "√©o", "√®o", "·∫ªo", "·∫Ωo", "·∫πo", "eo", "√©o", "√®o", "·∫ªo", "·∫Ωo", "·∫πo", "eo"]},
            {key: "EP", forms: ["√©p", "√®p", "·∫ªp", "·∫Ωp", "·∫πp", "ep", "·∫øp", "·ªÅp", "·ªÉp", "·ªÖp", "·ªáp", "√™p", "√©p", "√®p", "·∫ªp", "·∫Ωp", "·∫πp", "ep"]},
            {key: "ET", forms: ["√©t", "√®t", "·∫ªt", "·∫Ωt", "·∫πt", "et", "·∫øt", "·ªÅt", "·ªÉt", "·ªÖt", "·ªát", "√™t", "√©t", "√®t", "·∫ªt", "·∫Ωt", "·∫πt", "et"]},
            {key: "EU", forms: ["√©u", "√®u", "·∫ªu", "·∫Ωu", "·∫πu", "eu", "·∫øu", "·ªÅu", "·ªÉu", "·ªÖu", "·ªáu", "√™u", "√©u", "√®u", "·∫ªu", "·∫Ωu", "·∫πu", "eu"]},
            {key: "IAC", forms: ["i√°c", "i√†c", "i·∫£c", "i√£c", "i·∫°c", "iac", "i·∫•c", "i·∫ßc", "i·∫©c", "i·∫´c", "i·∫≠c", "i√¢c", "i·∫Øc", "i·∫±c", "i·∫≥c", "i·∫µc", "i·∫∑c", "iƒÉc"]},
            {key: "ION", forms: ["i√≥n", "√¨on", "·ªâon", "ƒ©on", "·ªãon", "ion", "i√≥n", "√¨on", "·ªâon", "ƒ©on", "·ªãon", "ion", "i√≥n", "√¨on", "·ªâon", "ƒ©on", "·ªãon", "ion"]},
            {key: "IONG", forms: ["i√≥ng", "√¨ong", "·ªâong", "ƒ©ong", "·ªãong", "iong", "i√≥ng", "√¨ong", "·ªâong", "ƒ©ong", "·ªãong", "iong", "i√≥ng", "√¨ong", "·ªâong", "ƒ©ong", "·ªãong", "iong"]},
            {key: "IOT", forms: ["i√≥t", "√¨ot", "·ªâot", "ƒ©ot", "·ªãot", "iot", "i√≥t", "√¨ot", "·ªâot", "ƒ©ot", "·ªãot", "iot", "i√≥t", "√¨ot", "·ªâot", "ƒ©ot", "·ªãot", "iot"]},
            {key: "IP", forms: ["√≠p", "√¨p", "·ªâp", "ƒ©p", "·ªãp", "ip", "√≠p", "√¨p", "·ªâp", "ƒ©p", "·ªãp", "ip", "√≠p", "√¨p", "·ªâp", "ƒ©p", "·ªãp", "ip"]},
            {key: "IT", forms: ["√≠t", "√¨t", "·ªât", "ƒ©t", "·ªãt", "it", "√≠t", "√¨t", "·ªât", "ƒ©t", "·ªãt", "it", "√≠t", "√¨t", "·ªât", "ƒ©t", "·ªãt", "it"]},
            {key: "IU", forms: ["i√∫", "√¨u", "·ªâu", "ƒ©u", "·ªãu", "iu", "i√∫", "√¨u", "·ªâu", "ƒ©u", "·ªãu", "iu", "i√∫", "√¨u", "·ªâu", "ƒ©u", "·ªãu", "iu"]},
            {key: "IUA", forms: ["i√∫a", "i√πa", "i·ªßa", "i≈©a", "i·ª•a", "iua", "i√∫a", "i√πa", "i·ªßa", "i≈©a", "i·ª•a", "iua", "i√∫a", "i√πa", "i·ªßa", "i≈©a", "i·ª•a", "iua"]},
            {key: "IUC", forms: ["i√∫c", "i√πc", "i·ªßc", "i≈©c", "i·ª•c", "iuc", "i√∫c", "i√πc", "i·ªßc", "i≈©c", "i·ª•c", "iuc", "i√∫c", "i√πc", "i·ªßc", "i≈©c", "i·ª•c", "iuc"]},
            {key: "IUI", forms: ["√≠ui", "√¨ui", "·ªâui", "ƒ©ui", "·ªãui", "iui", "√≠ui", "√¨ui", "·ªâui", "ƒ©ui", "·ªãui", "iui", "√≠ui", "√¨ui", "·ªâui", "ƒ©ui", "·ªãui", "iui"]},
            {key: "IUN", forms: ["i√∫n", "i√πn", "i·ªßn", "i≈©n", "i·ª•n", "iun", "i√∫n", "i√πn", "i·ªßn", "i≈©n", "i·ª•n", "iun", "i√∫n", "i√πn", "i·ªßn", "i≈©n", "i·ª•n", "iun"]},
            {key: "IUONG", forms: ["√≠uong", "√¨uong", "·ªâuong", "ƒ©uong", "·ªãuong", "iuong", "√≠uong", "√¨uong", "·ªâuong", "ƒ©uong", "·ªãuong", "iuong", "i∆∞·ªõng", "i∆∞·ªùng", "i∆∞·ªüng", "i∆∞·ª°ng", "i∆∞·ª£ng", "i∆∞∆°ng"]},
            {key: "IUP", forms: ["i√∫p", "i√πp", "i·ªßp", "i≈©p", "i·ª•p", "iup", "i√∫p", "i√πp", "i·ªßp", "i≈©p", "i·ª•p", "iup", "√≠up", "√¨up", "·ªâup", "i≈©p", "i·ª•p", "iup"]},
            {key: "O", forms: ["√≥", "√≤", "·ªè", "√µ", "·ªç", "o", "·ªë", "·ªì", "·ªï", "·ªó", "·ªô", "√¥", "·ªõ", "·ªù", "·ªü", "·ª°", "·ª£", "∆°"]},
            {key: "OA", forms: ["√≥a", "√≤a", "·ªèa", "√µa", "·ªça", "oa", "√≥a", "√≤a", "·ªèa", "√µa", "·ªça", "oa", "√≥a", "√≤a", "·ªèa", "√µa", "·ªça", "oa"]},
            {key: "OAC", forms: ["o√°c", "o√†c", "o·∫£c", "o√£c", "o·∫°c", "oac", "o√°c", "o√†c", "o·∫£c", "o√£c", "o·∫°c", "oac", "o·∫Øc", "o·∫±c", "o·∫≥c", "o·∫µc", "o·∫∑c", "oƒÉc"]},
            {key: "OACH", forms: ["o√°ch", "o√†ch", "o·∫£ch", "o√£ch", "o·∫°ch", "oach", "o√°ch", "o√†ch", "o·∫£ch", "o√£ch", "o·∫°ch", "oach", "o√°ch", "o√†ch", "o·∫£ch", "o√£ch", "o·∫°ch", "oach"]},
            {key: "OAI", forms: ["o√°i", "o√†i", "o·∫£i", "o√£i", "o·∫°i", "oai", "o√°i", "o√†i", "o·∫£i", "o√£i", "o·∫°i", "oai", "o√°i", "o√†i", "o·∫£i", "o√£i", "o·∫°i", "oai"]},
            {key: "OAM", forms: ["o√°m", "o√†m", "o·∫£m", "o√£m", "o·∫°m", "oam", "o√°m", "o√†m", "o·∫£m", "o√£m", "o·∫°m", "oam", "o√°m", "o√†m", "o·∫£m", "o√£m", "o·∫°m", "oam"]},
            {key: "OEN", forms: ["o√©n", "o√®n", "o·∫ªn", "o·∫Ωn", "o·∫πn", "oen", "o·∫øn", "o·ªÅn", "o·ªÉn", "o·ªÖn", "o·ªán", "o√™n", "o√©n", "o√®n", "o·∫ªn", "o·∫Ωn", "o·∫πn", "oen"]},
            {key: "OEO", forms: ["o√©o", "o√®o", "o·∫ªo", "o·∫Ωo", "o·∫πo", "oeo", "o·∫øo", "o·ªÅo", "o·ªÉo", "o·ªÖo", "o·ªáo", "o√™o", "o√©o", "o√®o", "o·∫ªo", "o·∫Ωo", "o·∫πo", "oeo"]},
            {key: "OET", forms: ["o√©t", "o√®t", "o·∫ªt", "o·∫Ωt", "o·∫πt", "oet", "o·∫øt", "o·ªÅt", "o·ªÉt", "o·ªÖt", "o·ªát", "o√™t", "o√©t", "o√®t", "o·∫ªt", "o·∫Ωt", "o·∫πt", "oet"]},
            {key: "OOC", forms: ["o√≥c", "o√≤c", "o·ªèc", "o√µc", "o·ªçc", "ooc", "o√≥c", "o√≤c", "o·ªèc", "o√µc", "o·ªçc", "ooc", "o√≥c", "o√≤c", "o·ªèc", "o√µc", "o·ªçc", "ooc"]},
            {key: "OONG", forms: ["o√≥ng", "o√≤ng", "o·ªèng", "o√µng", "o·ªçng", "oong", "o√≥ng", "o√≤ng", "o·ªèng", "o√µng", "o·ªçng", "oong", "o√≥ng", "o√≤ng", "o·ªèng", "o√µng", "o·ªçng", "oong"]},
            {key: "UAC", forms: ["u√°c", "u√†c", "u·∫£c", "u√£c", "u·∫°c", "uac", "u·∫•c", "u·∫ßc", "u·∫©c", "u·∫´c", "u·∫≠c", "u√¢c", "u·∫Øc", "u·∫±c", "u·∫≥c", "u·∫µc", "u·∫∑c", "uƒÉc"]},
            {key: "UACH", forms: ["u√°ch", "u√†ch", "u·∫£ch", "u√£ch", "u·∫°ch", "uach", "u·∫•ch", "u·∫ßch", "u·∫©ch", "u·∫´ch", "u·∫≠ch", "u√¢ch", "u·∫Øch", "u·∫±ch", "u·∫≥ch", "u·∫µch", "u·∫∑ch", "uƒÉch"]},
            {key: "UAI", forms: ["u√°i", "u√†i", "u·∫£i", "u√£i", "u·∫°i", "uai", "u·∫•i", "u·∫ßi", "u·∫©i", "u·∫´i", "u·∫≠i", "u√¢i", "u√°i", "u√†i", "u·∫£i", "u√£i", "u·∫°i", "uai"]},
            {key: "UAM", forms: ["u√°m", "u√†m", "u·∫£m", "u√£m", "u·∫°m", "uam", "u·∫•m", "u·∫ßm", "u·∫©m", "u·∫´m", "u·∫≠m", "u√¢m", "u√°m", "u√†m", "u·∫£m", "u√£m", "u·∫°m", "uam"]},
            {key: "UAO", forms: ["u√°o", "u√†o", "u·∫£o", "u√£o", "u·∫°o", "uao", "u√°o", "u√†o", "u·∫£o", "u√£o", "u·∫°o", "uao", "u√°o", "u√†o", "u·∫£o", "u√£o", "u·∫°o", "uao"]},
            {key: "UAT", forms: ["u√°t", "u√†t", "u·∫£t", "u√£t", "u·∫°t", "uat", "u·∫•t", "u·∫ßt", "u·∫©t", "u·∫´t", "u·∫≠t", "u√¢t", "u·∫Øt", "u·∫±t", "u·∫≥t", "u·∫µt", "u·∫∑t", "uƒÉt"]},
            {key: "UECH", forms: ["u√©ch", "u√®ch", "u·∫ªch", "u·∫Ωch", "u·∫πch", "uech", "u·∫øch", "u·ªÅch", "u·ªÉch", "u·ªÖch", "u·ªách", "u√™ch", "u√©ch", "u√®ch", "u·∫ªch", "u·∫Ωch", "u·∫πch", "uech"]},
            {key: "UENH", forms: ["u√©nh", "u√®nh", "u·∫ªnh", "u·∫Ωnh", "u·∫πnh", "uenh", "u·∫ønh", "u·ªÅnh", "u·ªÉnh", "u·ªÖnh", "u·ªánh", "u√™nh", "u√©nh", "u√®nh", "u·∫ªnh", "u·∫Ωnh", "u·∫πnh", "uenh"]},
            {key: "UEO", forms: ["u√©o", "u√®o", "u·∫ªo", "u·∫Ωo", "u·∫πo", "ueo", "u·∫øo", "u·ªÅo", "u·ªÉo", "u·ªÖo", "u·ªáo", "u√™o", "u√©o", "u√®o", "u·∫ªo", "u·∫Ωo", "u·∫πo", "ueo"]},
            {key: "UET", forms: ["u√©t", "u√®t", "u·∫ªt", "u·∫Ωt", "u·∫πt", "uet", "u·∫øt", "u·ªÅt", "u·ªÉt", "u·ªÖt", "u·ªát", "u√™t", "u√©t", "u√®t", "u·∫ªt", "u·∫Ωt", "u·∫πt", "uet"]},
            {key: "UOM", forms: ["u√≥m", "u√≤m", "u·ªèm", "u√µm", "u·ªçm", "uom", "u·ªëm", "u·ªìm", "u·ªïm", "u·ªóm", "u·ªôm", "u√¥m", "∆∞·ªõm", "∆∞·ªùm", "∆∞·ªüm", "∆∞·ª°m", "∆∞·ª£m", "∆∞∆°m"]},
            {key: "UOP", forms: ["u√≥p", "u√≤p", "u·ªèp", "u√µp", "u·ªçp", "uop", "u·ªëp", "u·ªìp", "u·ªïp", "u·ªóp", "u·ªôp", "u√¥p", "∆∞·ªõp", "∆∞·ªùp", "∆∞·ªüp", "∆∞·ª°p", "∆∞·ª£p", "∆∞∆°p"]},
            {key: "OUT", forms: ["√≥ut", "√≤ut", "·ªèut", "√µut", "·ªçut", "out", "√≥ut", "√≤ut", "·ªèut", "√µut", "·ªçut", "out", "√≥ut", "√≤ut", "·ªèut", "√µut", "·ªçut", "out"]},
            {key: "UOU", forms: ["u√≥u", "u√≤u", "u·ªèu", "u√µu", "u·ªçu", "uou", "u·ªëu", "u·ªìu", "u·ªïu", "u·ªóu", "u·ªôu", "u√¥u", "∆∞·ªõu", "∆∞·ªùu", "∆∞·ªüu", "∆∞·ª°u", "∆∞·ª£u", "∆∞∆°u"]},
            {key: "UP", forms: ["√∫p", "√πp", "·ªßp", "≈©p", "·ª•p", "up", "√∫p", "√πp", "·ªßp", "≈©p", "·ª•p", "up", "·ª©p", "·ª´p", "·ª≠p", "·ªØp", "·ª±p", "∆∞p"]},
            {key: "UT", forms: ["√∫t", "√πt", "·ªßt", "≈©t", "·ª•t", "ut", "√∫t", "√πt", "·ªßt", "≈©t", "·ª•t", "ut", "·ª©t", "·ª´t", "·ª≠t", "·ªØt", "·ª±t", "∆∞t"]},
            {key: "UU", forms: ["√∫u", "√πu", "·ªßu", "≈©u", "·ª•u", "uu", "√∫u", "√πu", "·ªßu", "≈©u", "·ª•u", "uu", "·ª©u", "·ª´u", "·ª≠u", "·ªØu", "·ª±u", "∆∞u"]},
            {key: "UYA", forms: ["u√Ωa", "u·ª≥a", "u·ª∑a", "u·ªπa", "u·ªµa", "uya", "u√Ωa", "u·ª≥a", "u·ª∑a", "u·ªπa", "u·ªµa", "uya", "u√Ωa", "u·ª≥a", "u·ª∑a", "u·ªπa", "u·ªµa", "uya"]},
            {key: "UYCH", forms: ["u√Ωch", "u·ª≥ch", "u·ª∑ch", "u·ªπch", "u·ªµch", "uych", "u√Ωch", "u·ª≥ch", "u·ª∑ch", "u·ªπch", "u·ªµch", "uych", "u√Ωch", "u·ª≥ch", "u·ª∑ch", "u·ªπch", "u·ªµch", "uych"]},
            {key: "UYEN", forms: ["uy√©n", "uy√®n", "uy·∫ªn", "uy·∫Ωn", "uy·∫πn", "uyen", "uy·∫øn", "uy·ªÅn", "uy·ªÉn", "uy·ªÖn", "uy·ªán", "uy√™n", "uy√©n", "uy√®n", "uy·∫ªn", "uy·∫Ωn", "uy·∫πn", "uyen"]},
            {key: "UYET", forms: ["uy√©t", "uy√®t", "uy·∫ªt", "uy·∫Ωt", "uy·∫πt", "uyet", "uy·∫øt", "uy·ªÅt", "uy·ªÉt", "uy·ªÖt", "uy·ªát", "uy√™t", "uy√©t", "uy√®t", "uy·∫ªt", "uy·∫Ωt", "uy·∫πt", "uyet"]},
            {key: "UYNH", forms: ["u√Ωnh", "u·ª≥nh", "u·ª∑nh", "u·ªπnh", "u·ªµnh", "uynh", "u√Ωnh", "u·ª≥nh", "u·ª∑nh", "u·ªπnh", "u·ªµnh", "uynh", "u√Ωnh", "u·ª≥nh", "u·ª∑nh", "u·ªπnh", "u·ªµnh", "uynh"]},
            {key: "UYP", forms: ["u√Ωp", "u·ª≥p", "u·ª∑p", "u·ªπp", "u·ªµp", "uyp", "u√Ωp", "u·ª≥p", "u·ª∑p", "u·ªπp", "u·ªµp", "uyp", "u√Ωp", "u·ª≥p", "u·ª∑p", "u·ªπp", "u·ªµp", "uyp"]},
            {key: "UYT", forms: ["u√Ωt", "u·ª≥t", "u·ª∑t", "u·ªπt", "u·ªµt", "uyt", "u√Ωt", "u·ª≥t", "u·ª∑t", "u·ªπt", "u·ªµt", "uyt", "u√Ωt", "u·ª≥t", "u·ª∑t", "u·ªπt", "u·ªµt", "uyt"]},
            {key: "UYU", forms: ["u√Ωu", "u·ª≥u", "u·ª∑u", "u·ªπu", "u·ªµu", "uyu", "u√Ωu", "u·ª≥u", "u·ª∑u", "u·ªπu", "u·ªµu", "uyu", "u√Ωu", "u·ª≥u", "u·ª∑u", "u·ªπu", "u·ªµu", "uyu"]},
            {key: "YEM", forms: ["y√©m", "y√®m", "y·∫ªm", "y·∫Ωm", "y·∫πm", "yem", "y·∫øm", "y·ªÅm", "y·ªÉm", "y·ªÖm", "y·ªám", "y√™m", "y√©m", "y√®m", "y·∫ªm", "y·∫Ωm", "y·∫πm", "yem"]},
            {key: "OAP", forms: ["o√°p", "o√†p", "o·∫£p", "o√£p", "o·∫°p", "oap", "o√°p", "o√†p", "o·∫£p", "o√£p", "o·∫°p", "oap", "o√°p", "o√†p", "o·∫£p", "o√£p", "o·∫°p", "oap"]}
        ];

        // =================== BI·∫æN TO√ÄN C·ª§C T·ªêI ∆ØU ===================
        let firebaseData = null;
        let lastUpdateTime = 0;
        let autoRefresh = true;
        let autoRefreshInterval;
        let logEntries = [];
        const MAX_LOG_ENTRIES = 20;
        
        // Bi·∫øn x√¢y d·ª±ng c√¢u
        let slot1 = "";
        let slot2 = "";
        let displayBuffer = "";
        let convertedCurrentWord = "";
        let sentenceWords = [];
        let fullSentence = "";
        let convertedFullSentence = "";
        
        // Tr·∫°ng th√°i c·∫£m bi·∫øn u·ªën
        let flexStates = [0, 0, 0, 0];
        let lastFlexStates = [-1, -1, -1, -1];
        let stableCount = 0;
        let lastDetectedIndex = -1;
        let holdStartMs = 0;
        let holdFired = false;
        const DEBOUNCE_COUNT = 3;
        const HOLD_MS_DEFAULT = 800;
        const POST_HOLD_COOLDOWN = 600;
        let lastActionMs = 0;
        
        // T·ªëi ∆∞u: Debouncing cho c·∫≠p nh·∫≠t hi·ªÉn th·ªã
        let lastUpdateTimeStamp = 0;
        const UPDATE_DEBOUNCE_MS = 50;
        let isUpdatingDisplay = false;
        
        // T·ªëi ∆∞u: Batch UI updates
        let uiDirty = false;
        let uiUpdateScheduled = false;
        
        // T·ªëi ∆∞u: Cache chuy·ªÉn ƒë·ªïi ti·∫øng Vi·ªát
        const vietnameseConversionCache = new Map();
        
        // T·ªëi ∆∞u: Gi·ªçng n√≥i
        let voicesLoaded = false;
        const voiceCache = new Map();
        
        // Bi·∫øn t·ªïng h·ª£p gi·ªçng n√≥i
        let isSpeaking = false;
        let currentSpeech = null;
        let audioVisualizerInterval = null;
        let audioCache = {};
        
        // Ch·∫ø ƒë·ªô TTS
        let useGeminiTTS = true;
        
        // C√†i ƒë·∫∑t gi·ªçng n√≥i hi·ªán t·∫°i
        let currentVoice = {
            lang: 'vi-VN',
            gender: 'male'
        };

        // √Ånh x·∫° tr·∫°ng th√°i MPU
        const mpuStateMap = {
            "Up": 0,
            "Down": 1,
            "Left": 2,
            "Right": 3,
            "Forward": 4,
            "Backward": 5
        };

        // ƒê·ªÅ xu·∫•t c·ª•m t·ª´
        const commonPhrases = [
            "Xin ch√†o, r·∫•t vui ƒë∆∞·ª£c g·∫∑p b·∫°n",
            "B·∫°n kh·ªèe kh√¥ng?",
            "C·∫£m ∆°n b·∫°n r·∫•t nhi·ªÅu",
            "L√†m ∆°n cho t√¥i h·ªèi ƒë∆∞·ªùng",
            "Ch√∫c m·ªôt ng√†y t·ªët l√†nh",
            "T√¥i y√™u ng√¥n ng·ªØ n√†y",
            "H·∫πn g·∫∑p l·∫°i sau",
            "T√¥i ƒë√≥i b·ª•ng",
            "Bao nhi√™u ti·ªÅn?",
            "T√¥i kh√¥ng hi·ªÉu"
        ];

        // √Ånh x·∫° gi·ªçng n√≥i cho Gemini TTS
        const geminiVoiceMap = {
            'vi-VN': {
                male: 'Aoede',
                female: 'Kore'
            },
            'en-GB': {
                male: 'Kore',
                female: 'Aoede'
            },
            'ja-JP': {
                male: 'Aoede',
                female: 'Kore'
            },
            'ko-KR': {
                male: 'Kore',
                female: 'Aoede'
            },
            'zh-CN': {
                male: 'Zubenelgenubi',
                female: 'Aoede'
            }
        };

        // √Ånh x·∫° gi·ªçng n√≥i cho Web Speech API
        const webSpeechVoiceMap = {
            'vi-VN': {
                male: { lang: 'vi-VN', name: 'Vietnamese Male', rate: 0.9, pitch: 0.8 },
                female: { lang: 'vi-VN', name: 'Vietnamese Female', rate: 0.9, pitch: 1.2 }
            },
            'en-GB': {
                male: { lang: 'en-GB', name: 'Google UK English Male', rate: 0.9, pitch: 0.8 },
                female: { lang: 'en-GB', name: 'Google UK English Female', rate: 0.9, pitch: 1.2 }
            },
            'ja-JP': {
                male: { lang: 'ja-JP', name: 'Japanese Male', rate: 0.9, pitch: 0.8 },
                female: { lang: 'ja-JP', name: 'Japanese Female', rate: 0.9, pitch: 1.2 }
            },
            'ko-KR': {
                male: { lang: 'ko-KR', name: 'Korean Male', rate: 0.9, pitch: 0.8 },
                female: { lang: 'ko-KR', name: 'Korean Female', rate: 0.9, pitch: 1.2 }
            },
            'zh-CN': {
                male: { lang: 'zh-CN', name: 'Chinese Male', rate: 0.9, pitch: 0.8 },
                female: { lang: 'zh-CN', name: 'Chinese Female', rate: 0.9, pitch: 1.2 }
            }
        };

        // =================== H√ÄM T·ªêI ∆ØU H√ìA ===================
        
        // H√†m debounced updateDisplay
        function updateDisplayOptimized(data) {
            const now = Date.now();
            if (now - lastUpdateTimeStamp < UPDATE_DEBOUNCE_MS || isUpdatingDisplay) {
                return;
            }
            
            lastUpdateTimeStamp = now;
            isUpdatingDisplay = true;
            
            requestAnimationFrame(() => {
                try {
                    if (!data) return;
                    
                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã c·∫£m bi·∫øn
                    document.getElementById('mpuOrientation').textContent = data.o || 'Kh√¥ng x√°c ƒë·ªãnh';
                    document.getElementById('mpuShakeState').textContent = data.d || 'Kh√¥ng';
                    document.getElementById('isShaking').textContent = data.sf || 'KH√îNG';
                    
                    // C·∫≠p nh·∫≠t c·∫£m bi·∫øn u·ªën
                    const flexValues = [data.f0 || 0, data.f1 || 0, data.f2 || 0, data.f3 || 0];
                    
                    // T√≠nh to√°n tr·∫°ng th√°i u·ªën
                    let shouldUpdateFlex = false;
                    for (let i = 0; i < 4; i++) {
                        const newState = calculateFlexState(flexValues[i], i);
                        if (newState !== flexStates[i]) {
                            flexStates[i] = newState;
                            shouldUpdateFlex = true;
                        }
                    }
                    
                    // Ch·ªâ c·∫≠p nh·∫≠t DOM n·∫øu c√≥ thay ƒë·ªïi
                    if (shouldUpdateFlex) {
                        for (let i = 0; i < 4; i++) {
                            const box = document.getElementById(`flex${i}-box`);
                            if (box.textContent !== flexStates[i].toString()) {
                                box.textContent = flexStates[i];
                                box.className = `flex-box active-${flexStates[i]}`;
                            }
                        }
                        
                        document.getElementById('rawValues').textContent = flexValues.join(', ');
                        document.getElementById('flexFormat').textContent = flexStates.join('');
                    }
                    
                    // C·∫≠p nh·∫≠t th·ªùi gian
                    const updateElement = document.getElementById('lastUpdate');
                    const currentTime = new Date().toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                    
                    if (updateElement.textContent !== `C·∫≠p nh·∫≠t Firebase l·∫ßn cu·ªëi: ${currentTime}`) {
                        updateElement.textContent = `C·∫≠p nh·∫≠t Firebase l·∫ßn cu·ªëi: ${currentTime}`;
                        document.getElementById('lastUpdateTime').textContent = currentTime;
                    }
                    
                    // X·ª≠ l√Ω x√¢y d·ª±ng t·ª´
                    processWordConstruction(data);
                    
                    // ƒê√°nh d·∫•u c·∫ßn c·∫≠p nh·∫≠t UI
                    markUIDirty();
                    
                } finally {
                    isUpdatingDisplay = false;
                }
            });
        }
        
        // H√†m ƒë√°nh d·∫•u UI c·∫ßn c·∫≠p nh·∫≠t
        function markUIDirty() {
            uiDirty = true;
            scheduleUIUpdate();
        }
        
        function scheduleUIUpdate() {
            if (!uiUpdateScheduled) {
                uiUpdateScheduled = true;
                requestAnimationFrame(performUIUpdate);
            }
        }
        
        function performUIUpdate() {
            if (!uiDirty) {
                uiUpdateScheduled = false;
                return;
            }
            
            // Batch t·∫•t c·∫£ DOM updates
            const fragment = document.createDocumentFragment();
            
            // C·∫≠p nh·∫≠t c√°c ph·∫ßn t·ª≠
            updateElementIfChanged('slot1', slot1 || '---');
            updateElementIfChanged('slot2', slot2 || '---');
            updateElementIfChanged('displayBuffer', displayBuffer || '---');
            updateElementIfChanged('convertedCurrentWord', convertedCurrentWord || '---');
            updateElementIfChanged('sentenceDisplay', fullSentence || '---');
            updateElementIfChanged('convertedSentenceDisplay', convertedFullSentence || '---');
            updateElementIfChanged('wordCount', sentenceWords.length);
            
            // C·∫≠p nh·∫≠t danh s√°ch t·ª´
            const wordListDiv = document.getElementById('wordList');
            if (sentenceWords.length > 0) {
                const newContent = sentenceWords.map(word => 
                    `<div class="word-item">${word}</div>`
                ).join('');
                
                if (wordListDiv.innerHTML !== newContent) {
                    wordListDiv.innerHTML = newContent;
                }
            } else if (wordListDiv.innerHTML !== 'Ch∆∞a c√≥ t·ª´ n√†o') {
                wordListDiv.innerHTML = 'Ch∆∞a c√≥ t·ª´ n√†o';
            }
            
            // C·∫≠p nh·∫≠t textarea
            const translationInput = document.getElementById('translationInput');
            if (translationInput.value !== convertedFullSentence) {
                translationInput.value = convertedFullSentence || '';
            }
            
            // C·∫≠p nh·∫≠t n√∫t gi·ªçng n√≥i
            updateSpeechButtons();
            
            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã gi·ªçng n√≥i hi·ªán t·∫°i
            updateVoiceDisplay();
            
            // Reset flags
            uiDirty = false;
            uiUpdateScheduled = false;
        }
        
        function updateElementIfChanged(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (element && element.textContent !== newValue.toString()) {
                element.textContent = newValue;
            }
        }
        
        function updateSpeechButtons() {
            const speakVnBtn = document.getElementById('speakVnBtn');
            const speakTransBtn = document.getElementById('speakTransBtn');
            const stopSpeechBtn = document.getElementById('stopSpeechBtn');
            
            speakVnBtn.disabled = !convertedFullSentence || isSpeaking;
            speakTransBtn.disabled = !document.getElementById('translationOutput').textContent || isSpeaking;
            stopSpeechBtn.disabled = !isSpeaking;
            
            if (isSpeaking) {
                speakVnBtn.classList.add('speaking');
            } else {
                speakVnBtn.classList.remove('speaking');
            }
        }
        
        function updateVoiceDisplay() {
            const langNames = {
                'vi-VN': 'Ti·∫øng Vi·ªát',
                'en-GB': 'Ti·∫øng Anh',
                'ja-JP': 'Ti·∫øng Nh·∫≠t',
                'ko-KR': 'Ti·∫øng H√†n',
                'zh-CN': 'Ti·∫øng Trung'
            };
            const genderNames = {
                'male': 'Nam',
                'female': 'N·ªØ'
            };
            const ttsMode = useGeminiTTS ? 'Gemini AI' : 'Web Speech';
            
            const displayText = `Hi·ªán t·∫°i: ${langNames[currentVoice.lang] || currentVoice.lang} ${genderNames[currentVoice.gender] || currentVoice.gender} (${ttsMode})`;
            
            const displayElement = document.getElementById('currentVoiceDisplay');
            if (displayElement.textContent !== displayText) {
                displayElement.textContent = displayText;
            }
            
            // C·∫≠p nh·∫≠t n√∫t chuy·ªÉn ƒë·ªïi TTS
            const geminiBtn = document.getElementById('useGeminiTTS');
            const webSpeechBtn = document.getElementById('useWebSpeech');
            
            if (useGeminiTTS) {
                geminiBtn.classList.add('active');
                webSpeechBtn.classList.remove('active');
            } else {
                geminiBtn.classList.remove('active');
                webSpeechBtn.classList.add('active');
            }
        }
        
        // =================== FIREBASE REALTIME LISTENER ===================
        let database;
        let sensorRef;
        
        function initializeFirebase() {
            try {
                // Kh·ªüi t·∫°o Firebase
                const app = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                // L·∫Øng nghe realtime
                sensorRef = database.ref('sensorData');
                sensorRef.on('value', handleFirebaseData);
                
                log('Firebase', 'ƒê√£ kh·ªüi t·∫°o Firebase SDK v·ªõi realtime listener');
                updateConnectionStatus(true);
                
                // ·∫®n n√∫t auto refresh v√¨ kh√¥ng c·∫ßn polling
                document.getElementById('autoRefreshBtn').style.display = 'none';
                
            } catch (error) {
                console.error('L·ªói kh·ªüi t·∫°o Firebase:', error);
                log('Firebase', `L·ªói kh·ªüi t·∫°o: ${error.message}`);
                updateConnectionStatus(false);
                
                // Fallback v·ªÅ REST API
                setupPollingFallback();
            }
        }
        
        function handleFirebaseData(snapshot) {
            const data = snapshot.val();
            if (!data) return;
            
            lastUpdateTime = Date.now();
            firebaseData = data;
            
            // S·ª≠ d·ª•ng debounced update
            updateDisplayOptimized(data);
            log('Firebase', 'D·ªØ li·ªáu realtime ƒë√£ nh·∫≠n');
        }
        
        function setupPollingFallback() {
            log('SYSTEM', 'Fallback: S·ª≠ d·ª•ng polling REST API');
            const btn = document.getElementById('autoRefreshBtn');
            btn.style.display = 'inline-block';
            btn.textContent = 'T·ª± ƒë·ªông: B·∫¨T';
            btn.className = 'green';
            
            // Polling m·ªói 500ms (nhanh h∆°n 2 gi√¢y)
            setInterval(() => {
                fetch('https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/sensorData.json')
                    .then(response => response.json())
                    .then(data => {
                        if (data) {
                            updateDisplayOptimized(data);
                        }
                    })
                    .catch(error => {
                        console.error('Polling error:', error);
                        updateConnectionStatus(false);
                    });
            }, 500);
        }
        
        // =================== H√ÄM CHUY·ªÇN ƒê·ªîI TI·∫æNG VI·ªÜT T·ªêI ∆ØU ===================
        
        // T·∫°o Map cho tra c·ª©u nhanh
        const vietnameseMap = new Map();
        vietnameseTable.forEach(item => {
            vietnameseMap.set(item.key, item.forms);
        });
        
        function convertVietnameseWordOptimized(encodedWord) {
            // Ki·ªÉm tra cache
            if (vietnameseConversionCache.has(encodedWord)) {
                return vietnameseConversionCache.get(encodedWord);
            }
            
            if (!encodedWord || encodedWord.length === 0) {
                vietnameseConversionCache.set(encodedWord, "");
                return "";
            }
            
            const firstUnderscore = encodedWord.indexOf('_');
            if (firstUnderscore === -1) {
                vietnameseConversionCache.set(encodedWord, encodedWord);
                return encodedWord;
            }
            
            const secondUnderscore = encodedWord.indexOf('_', firstUnderscore + 1);
            if (secondUnderscore === -1) {
                vietnameseConversionCache.set(encodedWord, encodedWord);
                return encodedWord;
            }
            
            const consonant = encodedWord.substring(0, firstUnderscore);
            const middle = encodedWord.substring(firstUnderscore + 1, secondUnderscore);
            const vowelTypeStr = encodedWord.substring(secondUnderscore + 1);
            
            if (middle.length < 2) {
                vietnameseConversionCache.set(encodedWord, encodedWord);
                return encodedWord;
            }
            
            const toneChar = middle[0];
            if (toneChar < '1' || toneChar > '6') {
                vietnameseConversionCache.set(encodedWord, encodedWord);
                return encodedWord;
            }
            
            const tone = parseInt(toneChar);
            const vowelKey = middle.substring(1).toUpperCase();
            
            let vowelType = 0;
            if (vowelTypeStr === "b") {
                vowelType = 1;
            } else if (vowelTypeStr === "p") {
                vowelType = 2;
            } else if (vowelTypeStr !== "s") {
                vietnameseConversionCache.set(encodedWord, encodedWord);
                return encodedWord;
            }
            
            const tableIndex = (tone - 1) + (vowelType * 6);
            
            if (tableIndex < 0 || tableIndex >= 18) {
                vietnameseConversionCache.set(encodedWord, encodedWord);
                return encodedWord;
            }
            
            const convertedVowel = vietnameseMap.get(vowelKey)?.[tableIndex];
            
            let result;
            if (convertedVowel) {
                result = consonant + convertedVowel;
            } else {
                result = encodedWord;
            }
            
            vietnameseConversionCache.set(encodedWord, result);
            return result;
        }
        
        function convertVietnameseTextOptimized(encodedText) {
            if (!encodedText || encodedText.length === 0) return "";
            
            // Ki·ªÉm tra cache to√†n b·ªô text
            if (vietnameseConversionCache.has(encodedText)) {
                return vietnameseConversionCache.get(encodedText);
            }
            
            const words = encodedText.split(' ');
            const convertedWords = words.map(word => convertVietnameseWordOptimized(word));
            const result = convertedWords.join(' ');
            
            vietnameseConversionCache.set(encodedText, result);
            return result;
        }
        
        function updateConversions() {
            // C·∫≠p nh·∫≠t chuy·ªÉn ƒë·ªïi t·ª´ hi·ªán t·∫°i
            if (displayBuffer.length > 0) {
                convertedCurrentWord = convertVietnameseWordOptimized(displayBuffer);
            } else {
                convertedCurrentWord = "";
            }
            
            // C·∫≠p nh·∫≠t chuy·ªÉn ƒë·ªïi to√†n b·ªô c√¢u
            if (fullSentence.length > 0) {
                convertedFullSentence = convertVietnameseTextOptimized(fullSentence);
            } else {
                convertedFullSentence = "";
            }
        }
        
        // =================== PRELOAD VOICES ===================
        
        function preloadVoices() {
            if ('speechSynthesis' in window) {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voicesLoaded = true;
                    
                    voices.forEach(voice => {
                        const key = `${voice.lang}-${voice.name.includes('Male') ? 'male' : 'female'}`;
                        voiceCache.set(key, voice);
                    });
                    
                    log('SPEECH', `ƒê√£ t·∫£i tr∆∞·ªõc ${voices.length} gi·ªçng n√≥i`);
                }
            }
        }
        
        // =================== H√ÄM TR·ª¢ GI√öP ===================
        
        function log(source, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, source, message };
            
            logEntries.unshift(logEntry);
            if (logEntries.length > MAX_LOG_ENTRIES) {
                logEntries.pop();
            }
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = logEntries.map(entry => 
                `<div class="log-entry">
                    <span style="color: #666; font-size: 0.8rem;">[${entry.timestamp}] ${entry.source}:</span>
                    <span style="color: #333;"> ${entry.message}</span>
                </div>`
            ).join('');
        }

        function clearLog() {
            logEntries = [];
            updateLogDisplay();
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                indicator.className = 'indicator online';
                statusText.textContent = 'ƒê√£ k·∫øt n·ªëi v·ªõi Firebase';
            } else {
                indicator.className = 'indicator';
                statusText.textContent = 'M·∫•t k·∫øt n·ªëi v·ªõi Firebase';
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        
        // =================== H√ÄM C·∫¢M BI·∫æN ===================
        
        function calculateFlexState(rawValue, sensorIndex) {
            // Ng∆∞·ª°ng th·∫≥ng (STRAIGHT_THRESHOLD) cho ng√≥n √∫t (sensor 3) l√† 100, c√°c ng√≥n kh√°c l√† 150
            const STRAIGHT_THRESHOLD = sensorIndex === 3 ? 100 : 150;
            const bentThresholds = [300, 450, 350, 300];
            
            if (rawValue <= STRAIGHT_THRESHOLD) {
                return 0;
            } else if (rawValue <= bentThresholds[sensorIndex]) {
                return 1;
            } else {
                return 2;
            }
        }

        function getMPUState(orientation, shakeState) {
            let state = -1;
            
            if (shakeState === "Shake Left") {
                return 6;
            } else if (shakeState === "Shake Right") {
                return 7;
            }
            
            switch(orientation) {
                case "Up": return 0;
                case "Down": return 1;
                case "Left": return 2;
                case "Right": return 3;
                case "Forward": return 4;
                case "Backward": return 5;
                default: return -1;
            }
        }

        function getMappingForIndices(mpuState, a0, a1, a2, a3) {
            if (mpuState < 0 || mpuState > 7) return null;
            
            if (a3 === 2) {
                if (a0 < 3 && a1 < 3 && a2 < 3) {
                    return tableC[a0][a1][a2];
                }
                return null;
            }
            
            const a3bin = a3 === 1 ? 1 : 0;
            if (a1 < 0 || a1 >= 3 || a2 < 0 || a2 >= 3) return null;
            
            const flatIndex = a1 * 3 + a2;
            
            if (flatIndex >= 0 && flatIndex < 9) {
                return a3bin === 0 ? tableA[mpuState][flatIndex] : tableB[mpuState][flatIndex];
            }
            
            return null;
        }

        function flexModeCharFromA0(a0) {
            switch(a0) {
                case 0: return 's';
                case 1: return 'b';
                case 2: return 'p';
                default: return 'x';
            }
        }
        
        function processWordConstruction(data) {
            const mpuState = getMPUState(data.o || "Kh√¥ng x√°c ƒë·ªãnh", data.d || "Kh√¥ng");
            const a0 = flexStates[0];
            const a1 = flexStates[1];
            const a2 = flexStates[2];
            const a3 = flexStates[3];
            
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ·ªïn ƒë·ªãnh
            if (mpuState === lastDetectedIndex && 
                a0 === lastFlexStates[0] && 
                a1 === lastFlexStates[1] && 
                a2 === lastFlexStates[2] && 
                a3 === lastFlexStates[3]) {
                stableCount++;
            } else {
                stableCount = 1;
                lastDetectedIndex = mpuState;
                lastFlexStates = [...flexStates];
                holdStartMs = Date.now();
                holdFired = false;
            }
            
            // Ki·ªÉm tra h√†nh ƒë·ªông
            if (stableCount >= DEBOUNCE_COUNT) {
                const held = Date.now() - holdStartMs;
                if (!holdFired && (Date.now() - lastActionMs) > POST_HOLD_COOLDOWN && held >= HOLD_MS_DEFAULT) {
                    performActionSlotLogic(mpuState, a0, a1, a2, a3);
                    holdFired = true;
                    lastActionMs = Date.now();
                }
            }
        }

        function performActionSlotLogic(mpu, a0, a1, a2, a3) {
            const mapping = getMappingForIndices(mpu, a0, a1, a2, a3);
            if (!mapping || mapping === "nullptr") return false;
            
            if (mapping === "_") {
                addWordToSentence();
                return true;
            }
            
            if (mapping === "COMMIT") {
                commitSentence();
                return true;
            }
            
            if (mapping === "<") {
                backspaceBuffer();
                updateDisplayBufferFromSlots();
                return true;
            }
            
            const isSlot1 = (a3 === 2);
            const held = Date.now() - holdStartMs;
            
            if (isSlot1 && stableCount >= DEBOUNCE_COUNT && held < HOLD_MS_DEFAULT) {
                const mode = flexModeCharFromA0(a0);
                slot2 = `${mapping}_${mode}`;
            } else if (isSlot1) {
                slot1 = `${mapping}_${mpu}`;
            } else {
                const mode = flexModeCharFromA0(a0);
                slot2 = `${mapping}_${mode}`;
            }
            
            updateDisplayBufferFromSlots();
            log('WORD', `H√†nh ƒë·ªông th·ª±c hi·ªán: ${displayBuffer}`);
            return true;
        }

        function updateDisplayBufferFromSlots() {
            const oldBuffer = displayBuffer;
            displayBuffer = '';
            
            if (slot1) {
                displayBuffer += slot1.toLowerCase();
            }
            
            if (slot2) {
                displayBuffer += slot2.toLowerCase();
            }
            
            if (oldBuffer !== displayBuffer) {
                updateConversions();
                log('WORD', `T·ª´ ƒë√£ c·∫≠p nh·∫≠t: ${displayBuffer}`);
            }
            
            markUIDirty();
        }
        
        // =================== H√ÄM C√ÇU ===================
        
        function addWordToSentence() {
            if (!displayBuffer) return;
            
            if (sentenceWords.length < 10) {
                sentenceWords.push(displayBuffer);
                updateFullSentence();
                log('SENTENCE', `ƒê√£ th√™m t·ª´: '${displayBuffer}'`);
                
                // Hi·ªÉn th·ªã ƒë·ªÅ xu·∫•t t·ª± ƒë·ªông sau khi th√™m t·ª´
                showAutoSuggestions();
                
                // X√≥a t·ª´ hi·ªán t·∫°i
                slot1 = '';
                slot2 = '';
                displayBuffer = '';
                convertedCurrentWord = '';
                
                markUIDirty();
            } else {
                log('SENTENCE', 'C√¢u ƒë√£ ƒë·∫ßy! ƒê·∫°t t·ªëi ƒëa 10 t·ª´.');
            }
        }

        function updateFullSentence() {
            fullSentence = sentenceWords.join(' ');
            convertedFullSentence = convertVietnameseTextOptimized(fullSentence);
        }

        function commitSentence() {
            if (sentenceWords.length === 0) {
                log('SENTENCE', 'Kh√¥ng c√≥ t·ª´ n√†o ƒë·ªÉ ho√†n th√†nh!');
                return;
            }
            
            if (displayBuffer) {
                addWordToSentence();
            }
            
            log('SENTENCE', '=== HO√ÄN TH√ÄNH C√ÇU ===');
            log('SENTENCE', `C√¢u ƒë·∫ßy ƒë·ªß: ${fullSentence}`);
            log('CONVERSION', `C√¢u ƒë√£ chuy·ªÉn ƒë·ªïi: ${convertedFullSentence}`);
            
            sentenceWords.forEach((word, i) => {
                const convertedWord = convertVietnameseWordOptimized(word);
                log('SENTENCE', `T·ª´ ${i + 1}: ${word} -> ${convertedWord}`);
            });
            
            // ƒê·∫∑t l·∫°i c√¢u
            resetSentence();
        }

        function resetSentence() {
            sentenceWords = [];
            fullSentence = '';
            convertedFullSentence = '';
            slot1 = '';
            slot2 = '';
            displayBuffer = '';
            convertedCurrentWord = '';
            
            // ·∫®n ƒë·ªÅ xu·∫•t t·ª± ƒë·ªông
            document.getElementById('autoSuggestionsPanel').style.display = 'none';
            
            log('SENTENCE', 'C√¢u ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i - s·∫µn s√†ng cho ƒë·∫ßu v√†o m·ªõi');
            markUIDirty();
        }

        function clearCurrentWord() {
            slot1 = '';
            slot2 = '';
            displayBuffer = '';
            convertedCurrentWord = '';
            
            markUIDirty();
            log('WORD', 'T·ª´ hi·ªán t·∫°i ƒë√£ ƒë∆∞·ª£c x√≥a');
        }

        function backspaceBuffer() {
            if (displayBuffer.length > 0) {
                displayBuffer = displayBuffer.slice(0, -1);
                updateConversions();
                log('WORD', `X√≥a k√Ω t·ª± - B·ªô ƒë·ªám: ${displayBuffer}`);
            }
        }

        function backspace() {
            backspaceBuffer();
            markUIDirty();
        }
        
        // =================== H√ÄM ƒê·ªÄ XU·∫§T ===================
        
        function showAutoSuggestions() {
            if (sentenceWords.length === 0) {
                document.getElementById('autoSuggestionsPanel').style.display = 'none';
                return;
            }
            
            const currentSentence = convertedFullSentence.toLowerCase();
            const suggestionsDiv = document.getElementById('autoSuggestionsGrid');
            const panel = document.getElementById('autoSuggestionsPanel');
            
            // L·ªçc c√°c c·ª•m t·ª´ c√≥ ch·ª©a ho·∫∑c b·∫Øt ƒë·∫ßu b·∫±ng c√¢u hi·ªán t·∫°i
            const relevantPhrases = commonPhrases.filter(phrase => {
                const phraseLower = phrase.toLowerCase();
                return phraseLower.includes(currentSentence) && phraseLower !== currentSentence;
            });
            
            // Gi·ªõi h·∫°n 6 ƒë·ªÅ xu·∫•t
            const displayPhrases = relevantPhrases.slice(0, 6);
            
            if (displayPhrases.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            suggestionsDiv.innerHTML = displayPhrases.map(phrase => `
                <div class="auto-suggestion-item">
                    <div class="auto-suggestion-text">${phrase}</div>
                    <div class="auto-suggestion-actions">
                        <button class="auto-suggestion-btn speak" onclick="speakSuggestion('${phrase}')">üîä ƒê·ªçc</button>
                        <button class="auto-suggestion-btn use" onclick="useSuggestion('${phrase}')">‚úì D√πng</button>
                        <button class="auto-suggestion-btn translate" onclick="translateSuggestion('${phrase}')">üåê D·ªãch</button>
                    </div>
                </div>
            `).join('');
            
            panel.style.display = 'block';
            
            log('SUGGESTIONS', `Hi·ªÉn th·ªã ${displayPhrases.length} ƒë·ªÅ xu·∫•t t·ª± ƒë·ªông`);
        }

        function speakSuggestion(text) {
            // S·ª≠ d·ª•ng gi·ªçng ti·∫øng Vi·ªát hi·ªán t·∫°i cho ƒë·ªÅ xu·∫•t
            speakText(text, currentVoice.lang);
            log('SUGGESTIONS', `ƒêang ƒë·ªçc ƒë·ªÅ xu·∫•t: "${text}"`);
        }

        function useSuggestion(text) {
            // Thay th·∫ø c√¢u hi·ªán t·∫°i b·∫±ng ƒë·ªÅ xu·∫•t
            const words = text.split(' ');
            sentenceWords = [];
            
            // Th√™m t·ª´ v√†o c√¢u
            words.forEach(word => {
                sentenceWords.push(word);
            });
            
            // ƒê·∫£m b·∫£o kh√¥ng v∆∞·ª£t qu√° gi·ªõi h·∫°n
            if (sentenceWords.length > 10) {
                sentenceWords = sentenceWords.slice(0, 10);
            }
            
            updateFullSentence();
            markUIDirty();
            
            // ·∫®n ƒë·ªÅ xu·∫•t
            document.getElementById('autoSuggestionsPanel').style.display = 'none';
            
            log('SUGGESTIONS', `ƒê√£ d√πng ƒë·ªÅ xu·∫•t: "${text}"`);
        }

        function translateSuggestion(text) {
            // ƒê·∫∑t v√†o input d·ªãch thu·∫≠t v√† t·ª± ƒë·ªông d·ªãch
            document.getElementById('translationInput').value = text;
            translateSentence();
            log('SUGGESTIONS', `ƒêang d·ªãch ƒë·ªÅ xu·∫•t: "${text}"`);
        }
        
        // H√†m ƒë·ªÅ xu·∫•t c·ª•m t·ª´
        function loadPhraseSuggestions() {
            const phrasePills = document.getElementById('phrasePills');
            phrasePills.innerHTML = '';
            
            commonPhrases.forEach(phrase => {
                const pill = document.createElement('button');
                pill.className = 'phrase-pill';
                pill.textContent = phrase.length > 30 ? phrase.substring(0, 27) + '...' : phrase;
                pill.onclick = () => {
                    // ƒê·∫∑t c·ª•m t·ª´ v√†o input d·ªãch thu·∫≠t
                    document.getElementById('translationInput').value = phrase;
                    // T·ª± ƒë·ªông d·ªãch
                    translateSentence();
                    log('PHRASE', `ƒê√£ ch·ªçn c·ª•m t·ª´: "${phrase}"`);
                };
                pill.title = phrase; // Hi·ªÉn th·ªã to√†n b·ªô vƒÉn b·∫£n khi di chu·ªôt
                phrasePills.appendChild(pill);
            });
        }
        
        // =================== H√ÄM GI·ªåNG N√ìI ===================
        
        function selectVoice(button) {
            const lang = button.getAttribute('data-lang');
            const gender = button.getAttribute('data-gender');
            
            // C·∫≠p nh·∫≠t gi·ªçng n√≥i hi·ªán t·∫°i
            currentVoice = {
                lang: lang,
                gender: gender
            };
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
            document.querySelectorAll('.voice-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
            
            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
            markUIDirty();
            log('VOICE', `ƒê√£ ch·ªçn gi·ªçng: ${lang} ${gender}`);
        }

        function toggleTTSMode(useGemini) {
            useGeminiTTS = useGemini;
            markUIDirty();
            log('TTS', `ƒê√£ chuy·ªÉn sang ${useGemini ? 'Gemini AI' : 'Web Speech'} TTS`);
        }
        
        // H√†m ƒë·ªÅ xu·∫•t ƒë·ªông (cho input d·ªãch thu·∫≠t)
        function handleTranslationInput() {
            const input = document.getElementById('translationInput').value;
            const suggestionsDiv = document.getElementById('translationSuggestions');
            
            if (!input || input.trim().length === 0) {
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.classList.remove('show');
                return;
            }
            
            const inputLower = input.toLowerCase();
            const filteredPhrases = commonPhrases.filter(phrase => 
                phrase.toLowerCase().includes(inputLower)
            );
            
            if (filteredPhrases.length > 0) {
                suggestionsDiv.innerHTML = filteredPhrases.map(phrase => `
                    <div class="suggestion-item" onclick="selectTranslationSuggestion('${phrase.replace(/'/g, "\\'")}')">
                        ${phrase}
                    </div>
                `).join('');
                suggestionsDiv.classList.add('show');
            } else {
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.classList.remove('show');
            }
        }

        function selectTranslationSuggestion(phrase) {
            document.getElementById('translationInput').value = phrase;
            document.getElementById('translationSuggestions').innerHTML = '';
            document.getElementById('translationSuggestions').classList.remove('show');
            translateSentence();
        }
        
        // H√†m Gemini TTS
        const pcmToWav = (base64PCM, sampleRate = 24000) => {
            try {
                const binaryString = atob(base64PCM);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                const wavHeader = new ArrayBuffer(44);
                const view = new DataView(wavHeader);

                const writeString = (view, offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };

                writeString(view, 0, "RIFF");
                view.setUint32(4, 36 + len, true);
                writeString(view, 8, "WAVE");
                writeString(view, 12, "fmt ");
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(view, 36, "data");
                view.setUint32(40, len, true);

                return new Blob([wavHeader, bytes], { type: "audio/wav" });
            } catch (error) {
                console.error("L·ªói chuy·ªÉn ƒë·ªïi PCM sang WAV:", error);
                return null;
            }
        };

        async function speakWithRetry(text, langCode, retries = 3) {
            const voiceName = geminiVoiceMap[langCode]?.[currentVoice.gender] || 
                            (currentVoice.gender === 'male' ? 'Aoede' : 'Kore');
            
            for (let i = 0; i < retries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);

                    const response = await fetch(
                        `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            signal: controller.signal,
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: text }] }],
                                generationConfig: {
                                    responseModalities: ["AUDIO"],
                                    speechConfig: {
                                        voiceConfig: { prebuiltVoiceConfig: { voiceName } },
                                    },
                                },
                            }),
                        }
                    );

                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`API_ERROR_${response.status}: ${errorData?.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    const inlineData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                    
                    if (!inlineData || !inlineData.data) {
                        throw new Error("NO_DATA");
                    }

                    return inlineData.data;
                } catch (err) {
                    if (i === retries - 1) throw err;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }
        
        async function speakVietnameseSentence() {
            const text = convertedFullSentence || document.getElementById('convertedSentenceDisplay').textContent;
            if (!text || text === '---') {
                log('SPEECH', 'Kh√¥ng c√≥ vƒÉn b·∫£n ti·∫øng Vi·ªát ƒë·ªÉ ƒë·ªçc');
                return;
            }
            
            speakText(text, currentVoice.lang);
        }

        async function speakTranslation() {
            const text = document.getElementById('translationOutput').textContent;
            if (!text || text.includes('ƒêang ch·ªù d·ªãch') || text.includes('Vui l√≤ng nh·∫≠p')) {
                log('SPEECH', 'Kh√¥ng c√≥ vƒÉn b·∫£n d·ªãch ƒë·ªÉ ƒë·ªçc');
                return;
            }
            
            const lang = document.getElementById('voiceLanguage').value;
            speakText(text, lang);
        }

        async function speakText(text, langCode) {
            if (isSpeaking) {
                stopAllSpeech();
                return;
            }
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i AI
            if (useGeminiTTS) {
                document.getElementById('aiSpeechStatus').style.display = 'flex';
            }
            
            if (useGeminiTTS && GEMINI_API_KEY) {
                // S·ª≠ d·ª•ng Gemini TTS
                await speakWithGeminiTTS(text, langCode);
            } else {
                // Fallback v·ªÅ Web Speech API
                speakWithWebSpeech(text, langCode);
            }
        }

        async function speakWithGeminiTTS(text, langCode) {
            setIsSpeaking(true);
            startAudioVisualizer();
            
            const cacheKey = `${langCode}:${currentVoice.gender}:${text}`;
            
            try {
                // Ki·ªÉm tra b·ªô nh·ªõ ƒë·ªám tr∆∞·ªõc
                if (audioCache[cacheKey]) {
                    playAudioFromCache(cacheKey, text);
                    return;
                }
                
                // L·∫•y d·ªØ li·ªáu √¢m thanh t·ª´ API Gemini
                const audioDataBase64 = await speakWithRetry(text, langCode);
                
                // Chuy·ªÉn ƒë·ªïi PCM sang WAV
                const wavBlob = pcmToWav(audioDataBase64, 24000);
                
                if (!wavBlob) {
                    throw new Error("Kh√¥ng th·ªÉ t·∫°o blob √¢m thanh");
                }
                
                // T·∫°o URL v√† l∆∞u v√†o b·ªô nh·ªõ ƒë·ªám
                const audioUrl = URL.createObjectURL(wavBlob);
                audioCache[cacheKey] = audioUrl;
                
                // ·∫®n tr·∫°ng th√°i t·∫£i
                document.getElementById('aiSpeechStatus').style.display = 'none';
                
                // Ph√°t √¢m thanh
                playAudio(audioUrl, text);
                
                log('SPEECH', `ƒêang ph√°t Gemini TTS: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);
                
            } catch (error) {
                console.error('L·ªói Gemini TTS:', error);
                document.getElementById('aiSpeechStatus').style.display = 'none';
                log('SPEECH', `Gemini TTS th·∫•t b·∫°i: ${error.message}. Fallback v·ªÅ Web Speech.`);
                
                // Fallback v·ªÅ Web Speech API
                speakWithWebSpeech(text, langCode);
            }
        }

        function playAudioFromCache(cacheKey, text) {
            const audioUrl = audioCache[cacheKey];
            playAudio(audioUrl, text);
            log('SPEECH', `ƒêang ph√°t √¢m thanh t·ª´ b·ªô nh·ªõ ƒë·ªám: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);
        }

        function playAudio(audioUrl, text) {
            const audio = new Audio(audioUrl);
            currentSpeech = audio;
            
            audio.onended = function() {
                setIsSpeaking(false);
                currentSpeech = null;
                stopAudioVisualizer();
                markUIDirty();
                log('SPEECH', 'ƒê√£ ƒë·ªçc xong');
            };
            
            audio.onerror = function(event) {
                console.error('L·ªói ph√°t √¢m thanh:', event);
                setIsSpeaking(false);
                currentSpeech = null;
                stopAudioVisualizer();
                markUIDirty();
                log('SPEECH', `L·ªói √¢m thanh: ${event.error}`);
            };
            
            audio.onplay = function() {
                setIsSpeaking(true);
                startAudioVisualizer();
                markUIDirty();
            };
            
            audio.play().catch(error => {
                console.error('Ph√°t √¢m thanh th·∫•t b·∫°i:', error);
                setIsSpeaking(false);
                currentSpeech = null;
                stopAudioVisualizer();
                markUIDirty();
            });
        }

        function speakWithWebSpeech(text, langCode) {
            if (isSpeaking) {
                stopAllSpeech();
                return;
            }
            
            // Ki·ªÉm tra h·ªó tr·ª£ tr√¨nh duy·ªát
            if (!('speechSynthesis' in window)) {
                log('SPEECH', 'T·ªïng h·ª£p gi·ªçng n√≥i kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ trong tr√¨nh duy·ªát n√†y');
                return;
            }
            
            // D·ª´ng m·ªçi gi·ªçng n√≥i ƒëang ph√°t
            window.speechSynthesis.cancel();
            
            // T·∫°o l·ªùi n√≥i t·ªïng h·ª£p
            const utterance = new SpeechSynthesisUtterance(text);
            
            // L·∫•y c√†i ƒë·∫∑t gi·ªçng n√≥i
            let voiceSettings = webSpeechVoiceMap[langCode]?.[currentVoice.gender];
            
            if (!voiceSettings && langCode === currentVoice.lang) {
                // S·ª≠ d·ª•ng c√†i ƒë·∫∑t gi·ªçng hi·ªán t·∫°i n·∫øu ng√¥n ng·ªØ kh·ªõp
                voiceSettings = webSpeechVoiceMap[currentVoice.lang]?.[currentVoice.gender];
            }
            
            if (!voiceSettings) {
                // C√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh
                voiceSettings = { lang: langCode, rate: 0.9, pitch: currentVoice.gender === 'male' ? 0.8 : 1.2 };
            }
            
            utterance.lang = voiceSettings.lang || langCode;
            utterance.rate = voiceSettings.rate || 0.9;
            utterance.pitch = voiceSettings.pitch || (currentVoice.gender === 'male' ? 0.8 : 1.2);
            utterance.volume = 1;
            
            // Th·ª≠ t√¨m gi·ªçng c·ª• th·ªÉ
            const voices = speechSynthesis.getVoices();
            let targetVoice = null;
            
            if (voiceSettings.name) {
                targetVoice = voices.find(voice => voice.name === voiceSettings.name);
            }
            
            // N·∫øu kh√¥ng t√¨m th·∫•y gi·ªçng c·ª• th·ªÉ, th·ª≠ t√¨m gi·ªçng cho ng√¥n ng·ªØ
            if (!targetVoice) {
                targetVoice = voices.find(voice => 
                    voice.lang === utterance.lang || 
                    voice.lang.startsWith(utterance.lang.split('-')[0])
                );
            }
            
            if (targetVoice) {
                utterance.voice = targetVoice;
            }
            
            // B·ªô l·∫Øng nghe s·ª± ki·ªán
            utterance.onstart = function() {
                setIsSpeaking(true);
                markUIDirty();
                startAudioVisualizer();
                log('SPEECH', `ƒê√£ b·∫Øt ƒë·∫ßu Web Speech: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);
            };
            
            utterance.onend = function() {
                setIsSpeaking(false);
                currentSpeech = null;
                stopAudioVisualizer();
                markUIDirty();
                log('SPEECH', 'ƒê√£ k·∫øt th√∫c Web Speech');
            };
            
            utterance.onerror = function(event) {
                setIsSpeaking(false);
                currentSpeech = null;
                stopAudioVisualizer();
                markUIDirty();
                log('SPEECH', `L·ªói Web Speech: ${event.error}`);
            };
            
            currentSpeech = utterance;
            window.speechSynthesis.speak(utterance);
        }

        function setIsSpeaking(speaking) {
            isSpeaking = speaking;
            markUIDirty();
        }

        function stopAllSpeech() {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            
            if (currentSpeech && currentSpeech.pause) {
                currentSpeech.pause();
                currentSpeech.currentTime = 0;
            }
            
            setIsSpeaking(false);
            currentSpeech = null;
            stopAudioVisualizer();
            markUIDirty();
            
            // ·∫®n tr·∫°ng th√°i t·∫£i AI
            document.getElementById('aiSpeechStatus').style.display = 'none';
            
            log('SPEECH', 'ƒê√£ d·ª´ng ƒë·ªçc');
        }

        function startAudioVisualizer() {
            stopAudioVisualizer();
            
            const visualizer = document.getElementById('audioVisualizer');
            visualizer.innerHTML = '';
            
            // T·∫°o 20 thanh √¢m thanh
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '5px';
                visualizer.appendChild(bar);
            }
            
            const bars = visualizer.querySelectorAll('.audio-bar');
            audioVisualizerInterval = setInterval(() => {
                bars.forEach(bar => {
                    const height = 5 + Math.random() * 35;
                    bar.style.height = `${height}px`;
                    bar.style.backgroundColor = `hsl(${120 + Math.random() * 60}, 70%, 50%)`;
                });
            }, 100);
        }

        function stopAudioVisualizer() {
            if (audioVisualizerInterval) {
                clearInterval(audioVisualizerInterval);
                audioVisualizerInterval = null;
            }
            
            const visualizer = document.getElementById('audioVisualizer');
            visualizer.innerHTML = '';
            
            // T·∫°o thanh tƒ©nh khi kh√¥ng ƒë·ªçc
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '5px';
                bar.style.backgroundColor = '#e0e0e0';
                visualizer.appendChild(bar);
            }
        }
        
        // =================== H√ÄM D·ªäCH THU·∫¨T ===================
        
        let translationCache = {};
        let lastTranslationTime = 0;
        const TRANSLATION_COOLDOWN = 2000;

        async function translateSentence() {
            const textarea = document.getElementById('translationInput');
            const text = textarea.value.trim();
            const targetLang = document.getElementById('targetLanguage').value;
            const outputDiv = document.getElementById('translationOutput');
            
            if (!text) {
                outputDiv.innerHTML = '<span style="color: #F44336;">Vui l√≤ng nh·∫≠p vƒÉn b·∫£n ƒë·ªÉ d·ªãch!</span>';
                outputDiv.className = 'conversion-display error';
                return;
            }
            
            const now = Date.now();
            if (now - lastTranslationTime < TRANSLATION_COOLDOWN) {
                outputDiv.innerHTML = '<span style="color: #FF9800;">Vui l√≤ng ƒë·ª£i tr∆∞·ªõc khi d·ªãch l·∫°i...</span>';
                outputDiv.className = 'conversion-display';
                return;
            }
            
            const cacheKey = text + '|' + targetLang;
            if (translationCache[cacheKey]) {
                outputDiv.innerHTML = translationCache[cacheKey];
                outputDiv.className = 'conversion-display success';
                lastTranslationTime = now;
                return;
            }
            
            outputDiv.innerHTML = '<span class="loading">ƒêang d·ªãch v·ªõi AI... ‚è≥</span>';
            outputDiv.className = 'conversion-display loading';
            
            try {
                const langMap = {
                    'en-GB': 'en',
                    'ja-JP': 'ja',
                    'ko-KR': 'ko',
                    'zh-CN': 'zh'
                };
                
                const langCode = langMap[targetLang] || 'en';
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=vi|${langCode}`);
                const data = await response.json();
                
                if (data.responseStatus === 200 && data.responseData) {
                    const translated = data.responseData.translatedText;
                    translationCache[cacheKey] = translated;
                    outputDiv.innerHTML = translated;
                    outputDiv.className = 'conversion-display success';
                    lastTranslationTime = Date.now();
                    log('TRANSLATION', `ƒê√£ d·ªãch sang ${targetLang}: ${translated}`);
                } else {
                    throw new Error('D·ªãch th·∫•t b·∫°i');
                }
            } catch (error) {
                console.error('L·ªói d·ªãch thu·∫≠t:', error);
                outputDiv.innerHTML = '<span style="color: #F44336;">D·ªãch v·ª• d·ªãch thu·∫≠t kh√¥ng kh·∫£ d·ª•ng. Vui l√≤ng th·ª≠ l·∫°i sau.</span>';
                outputDiv.className = 'conversion-display error';
            }
        }

        function clearTranslation() {
            document.getElementById('translationOutput').innerHTML = 'ƒêang ch·ªù d·ªãch...';
            document.getElementById('translationOutput').className = 'conversion-display';
            translationCache = {};
        }
        
        // =================== H√ÄM ƒêI·ªÄU KHI·ªÇN ===================
        
        function refreshData() {
            if (database) {
                // N·∫øu ƒëang d√πng Firebase SDK, refetch data
                sensorRef.once('value').then(snapshot => {
                    handleFirebaseData(snapshot);
                });
            } else {
                // N·∫øu ƒëang d√πng polling
                fetch('https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/sensorData.json')
                    .then(response => response.json())
                    .then(data => {
                        if (data) {
                            updateDisplayOptimized(data);
                        }
                    });
            }
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefresh) {
                btn.textContent = 'T·ª± ƒë·ªông: B·∫¨T';
                btn.className = 'green';
                autoRefreshInterval = setInterval(refreshData, 2000);
                log('SYSTEM', 'ƒê√£ b·∫≠t t·ª± ƒë·ªông l√†m m·ªõi');
            } else {
                btn.textContent = 'T·ª± ƒë·ªông: T·∫ÆT';
                btn.className = 'red';
                clearInterval(autoRefreshInterval);
                log('SYSTEM', 'ƒê√£ t·∫Øt t·ª± ƒë·ªông l√†m m·ªõi');
            }
        }
        
        // =================== KH·ªûI T·∫†O ===================
        
        document.addEventListener('DOMContentLoaded', function() {
            log('SYSTEM', '·ª®ng d·ª•ng ƒë√£ kh·ªüi ƒë·ªông v·ªõi c√°c t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t');
            
            // Kh·ªüi t·∫°o Firebase realtime
            initializeFirebase();
            
            // Preload voices
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = preloadVoices;
                preloadVoices();
            }
            
            // Kh·ªüi t·∫°o ƒë·ªÅ xu·∫•t c·ª•m t·ª´
            loadPhraseSuggestions();
            
            // Ki·ªÉm tra kh√≥a API
            if (!GEMINI_API_KEY) {
                log('SYSTEM', 'L∆∞u √Ω: Ch∆∞a c·∫•u h√¨nh kh√≥a API Gemini TTS. S·ª≠ d·ª•ng Web Speech API.');
                useGeminiTTS = false;
            }
            
            // ƒê√≥ng ƒë·ªÅ xu·∫•t khi nh·∫•p b√™n ngo√†i
            document.addEventListener('click', function(event) {
                const suggestions = document.getElementById('dynamicSuggestions');
                const translationSuggestions = document.getElementById('translationSuggestions');
                
                if (suggestions && !suggestions.contains(event.target)) {
                    suggestions.classList.remove('show');
                }
                
                if (translationSuggestions && !translationSuggestions.contains(event.target)) {
                    translationSuggestions.classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
