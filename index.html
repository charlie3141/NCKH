<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gangtay — Simple Poll & Play (revert)</title>
<style>
  body{font-family:system-ui,Arial;padding:16px;max-width:900px;margin:auto}
  input,button{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
  .row{display:flex;gap:8px}
  .half{flex:1}
  #log{white-space:pre-wrap;background:#f6f6f6;padding:10px;border-radius:6px;min-height:200px}
</style>
</head>
<body>
  <h2>Gangtay — Simple Poll & Play (simple revert)</h2>
  <label>Firebase message.json URL</label>
  <input id="firebaseUrl" value="https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/message.json">
  <label>Audio base URL (folder)</label>
  <input id="audioBase" value="/audio/">
  <div class="row" style="margin-top:8px">
    <button id="unlock">Unlock audio (tap once)</button>
    <input id="pollMs" type="number" value="800" min="100" style="width:120px">
    <button id="start">Start</button>
    <button id="stop">Stop</button>
  </div>
  <div id="status">Status: idle</div>
  <pre id="log">log...</pre>

<script>
async function fetchJson(url) {
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error('Fetch failed ' + r.status);
  return await r.json();
}

function findLatestLogIndex(logsObj) {
  // logsObj is an object where keys are push-ids; we pick last key by iterating
  let lastKey = null;
  for (const k in logsObj) lastKey = k; // order is insertion order in most RB trees; last wins
  if (!lastKey) return null;
  const entry = logsObj[lastKey];
  if (!entry) return null;
  // try several fields: entry.log, entry.message, entry.logText
  const text = (entry.log || entry.message || entry.logText || JSON.stringify(entry));
  const m = text.match(/\d+/); // first number
  return m ? parseInt(m[0], 10) : null;
}

async function pollOnce(){
  const baseUrl = (firebaseUrlEl.value || '').trim();
  if (!baseUrl) { log('No Firebase URL'); return; }

  try {
    // 1) try message.json
    const j = await fetchJson(baseUrl);
    const s = JSON.stringify(j);
    if (s !== lastPayload) {
      lastPayload = s;
      log('New payload (message.json): ' + s);
      if (typeof j.index === 'number') { await playIndex(j.index); return; }
      if (typeof j.text === 'string' && /^\d+$/.test(j.text.trim())) { await playIndex(parseInt(j.text.trim(),10)); return; }
    }

    // 2) fallback to logs.json (same host path but /logs.json)
    // build logs url based on firebaseUrlEl: replace '/message.json' with '/logs.json'
    const logsUrl = baseUrl.replace(/message\.json$/,'logs.json');
    if (!logsUrl || logsUrl === baseUrl) return; // nothing to do
    const logsObj = await fetchJson(logsUrl);
    const idx = findLatestLogIndex(logsObj);
    if (idx !== null) {
      // avoid replaying same index (compare lastPayload+index)
      const combined = 'logs:' + String(idx);
      if (combined !== lastPayload) {
        lastPayload = combined;
        log('Found index in logs.json -> ' + idx);
        await playIndex(idx);
      }
    } else {
      // nothing numeric found
      //log('No numeric index in logs fallback');
    }
  } catch(e) {
    log('Poll error: ' + e);
  }
}
</script>

</body>
</html>
