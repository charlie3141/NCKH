<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Word Constructor - Firebase Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            background-attachment: fixed;
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #4A00E0 0%, #8E2DE2 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.1;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        header > div {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .firebase-status {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 50px;
            display: inline-block;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
            position: relative;
            z-index: 1;
        }

        /* Dashboard Layout */
        .dashboard {
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
        }

        .card h3 {
            color: #4A00E0;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 i {
            font-size: 1.2rem;
        }

        /* Display Areas */
        .conversion-display, .sentence-display, .current-word-display {
            font-size: 1.6rem;
            font-weight: 600;
            margin: 15px 0;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            padding: 20px;
            line-height: 1.4;
            text-align: center;
            word-break: break-word;
            transition: all 0.3s ease;
        }

        .conversion-display {
            color: #2196F3;
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border: 2px solid #2196F3;
        }

        .sentence-display {
            color: #4CAF50;
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            border: 2px solid #4CAF50;
            font-size: 1.8rem;
            min-height: 90px;
        }

        .current-word-display {
            color: #FF5722;
            background: linear-gradient(135deg, #FFF8E1, #FFECB3);
            border: 2px dashed #FFC107;
            font-size: 2.2rem;
            font-weight: 700;
            min-height: 80px;
            position: relative;
            overflow: hidden;
        }

        .current-word-display::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            animation: shimmer 3s infinite linear;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
        }

        .sensor-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        /* Word List */
        .word-list {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border: 1px solid #dee2e6;
            min-height: 80px;
        }

        .word-item {
            display: inline-block;
            padding: 10px 18px;
            margin: 6px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 25px;
            border: 1px solid #90caf9;
            font-weight: 500;
            color: #1565c0;
            box-shadow: 0 3px 8px rgba(33, 150, 243, 0.1);
            transition: all 0.2s ease;
        }

        .word-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.2);
        }

        .word-count {
            font-size: 0.95rem;
            color: #666;
            margin-top: 10px;
            text-align: center;
            font-weight: 500;
        }

        /* Sensor Grid */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .sensor-item {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border-left: 5px solid;
            transition: transform 0.3s ease;
        }

        .sensor-item:hover {
            transform: translateY(-3px);
        }

        .sensor-item.mpu {
            border-left-color: #2196F3;
        }

        .sensor-item.flex {
            border-left-color: #4CAF50;
        }

        .sensor-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin: 10px 0;
        }

        /* Flex Boxes */
        .flex-box {
            display: inline-block;
            width: 50px;
            height: 50px;
            line-height: 50px;
            text-align: center;
            border-radius: 10px;
            margin: 5px;
            font-weight: 700;
            border: 2px solid transparent;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .flex-box.active-0 { 
            background: linear-gradient(135deg, #4CAF50, #45a049); 
            color: white; 
            transform: scale(1);
        }
        .flex-box.active-1 { 
            background: linear-gradient(135deg, #FF9800, #F57C00); 
            color: white; 
            transform: scale(1.05);
        }
        .flex-box.active-2 { 
            background: linear-gradient(135deg, #F44336, #D32F2F); 
            color: white; 
            transform: scale(1.1);
        }

        .flex-box:hover {
            transform: scale(1.15) rotate(5deg);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #4A00E0, #8E2DE2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            letter-spacing: 0.5px;
            box-shadow: 0 5px 15px rgba(74, 0, 224, 0.2);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(74, 0, 224, 0.3);
        }

        button:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(74, 0, 224, 0.3);
        }

        button.red {
            background: linear-gradient(135deg, #FF416C, #FF4B2B);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.2);
        }

        button.green {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.2);
        }

        button.blue {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.2);
        }

        button.orange {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.2);
        }

        /* Status Bar */
        .status-bar {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 18px 25px;
            border-top: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
        }

        .indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            box-shadow: 0 0 10px currentColor;
        }

        .indicator.online {
            background: #4CAF50;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 15px #4CAF50;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        /* Calibration Status */
        .calibration-status {
            margin: 15px 0;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .calibrating {
            background: linear-gradient(135deg, #FFF3CD, #FFE69C);
            border: 2px solid #FFC107;
            color: #856404;
            animation: pulse 1s infinite;
        }

        .calibrated {
            background: linear-gradient(135deg, #D4EDDA, #C3E6CB);
            border: 2px solid #28A745;
            color: #155724;
        }

        /* Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .shake-active {
            color: #FF5722 !important;
            font-weight: 700 !important;
            animation: shake 0.5s infinite;
        }

        /* Dropdowns */
        select, .language-select {
            padding: 10px 18px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 170px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234A00E0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 15px;
            appearance: none;
            padding-right: 45px;
        }

        select:hover, .language-select:hover {
            border-color: #4A00E0;
            box-shadow: 0 3px 10px rgba(74, 0, 224, 0.1);
        }

        select:focus, .language-select:focus {
            outline: none;
            border-color: #8E2DE2;
            box-shadow: 0 0 0 3px rgba(142, 45, 226, 0.2);
        }

        textarea {
            width: 100%;
            height: 140px;
            font-size: 1.6rem;
            padding: 20px;
            border: 2px solid #4CAF50;
            border-radius: 12px;
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            color: #333;
            resize: vertical;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        textarea:focus {
            outline: none;
            border-color: #2E7D32;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            background: linear-gradient(135deg, #C8E6C9, #A5D6A7);
        }

        /* Radio Group */
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        /* Last Update */
        .last-update {
            font-size: 0.85rem;
            color: #888;
            font-style: italic;
        }

        /* Log Entry */
        .log-entry {
            margin-bottom: 8px;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
        }

        .log-entry:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        /* Loading & Error States */
        .loading {
            animation: pulse 1.5s infinite;
            color: #2196F3 !important;
        }

        .error {
            color: #F44336 !important;
            border-color: #F44336 !important;
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2) !important;
        }

        .success {
            color: #4CAF50 !important;
            border-color: #4CAF50 !important;
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9) !important;
        }

        /* Phrase Suggestions */
        .phrase-suggestions {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .phrase-suggestions h4 {
            margin-bottom: 15px;
            color: #4A00E0;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .phrase-suggestions h4 i {
            color: #FF9800;
        }

        .phrase-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .phrase-pill {
            padding: 10px 18px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.2);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .phrase-pill:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
            background: linear-gradient(135deg, #45a049, #3d8b40);
        }

        .phrase-pill i {
            font-size: 0.8rem;
        }

        .phrase-pill.blue {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            box-shadow: 0 3px 10px rgba(33, 150, 243, 0.2);
        }

        .phrase-pill.blue:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.3);
        }

        .phrase-pill.purple {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            box-shadow: 0 3px 10px rgba(156, 39, 176, 0.2);
        }

        .phrase-pill.purple:hover {
            background: linear-gradient(135deg, #7B1FA2, #6A1B9A);
            box-shadow: 0 8px 20px rgba(156, 39, 176, 0.3);
        }

        /* Speech Controls */
        .speech-controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .speech-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #9C27B0, #673AB7);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.2);
            position: relative;
            overflow: hidden;
            min-width: 180px;
        }

        .speech-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(156, 39, 176, 0.3);
        }

        .speech-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1) !important;
        }

        .speech-btn.speaking {
            background: linear-gradient(135deg, #FF5722, #E64A19);
            animation: pulse 1.5s infinite;
            box-shadow: 0 5px 20px rgba(255, 87, 34, 0.3);
        }

        .speech-btn.blue {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.2);
        }

        .speech-btn.red {
            background: linear-gradient(135deg, #FF416C, #FF4B2B);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.2);
        }

        /* Voice Selection */
        .voice-selection {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .voice-option {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .voice-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #4A00E0;
        }

        .voice-option.selected {
            background: linear-gradient(135deg, #4A00E0, #8E2DE2);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(74, 0, 224, 0.3);
        }

        .voice-option.selected:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(74, 0, 224, 0.4);
        }

        /* Audio Visualizer */
        .audio-visualizer {
            margin-top: 15px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border-radius: 12px;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            padding: 0 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .audio-bar {
            width: 5px;
            background: linear-gradient(to top, #4CAF50, #2196F3);
            border-radius: 3px;
            transition: height 0.1s ease;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .container {
                border-radius: 15px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .dashboard {
                padding: 15px;
                gap: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .conversion-display, .sentence-display, .current-word-display {
                font-size: 1.4rem;
                padding: 15px;
            }
            
            button, .speech-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
                min-width: auto;
            }
            
            .sensor-grid {
                grid-template-columns: 1fr;
            }
            
            .controls, .speech-controls, .voice-selection {
                flex-direction: column;
                align-items: stretch;
            }
            
            .voice-option {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.7rem;
            }
            
            .dashboard {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .conversion-display, .sentence-display, .current-word-display {
                font-size: 1.2rem;
                min-height: 60px;
                padding: 12px;
            }
            
            .sensor-value {
                font-size: 1.6rem;
            }
            
            .flex-box {
                width: 40px;
                height: 40px;
                line-height: 40px;
                font-size: 1rem;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4A00E0, #8E2DE2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #3a00b0, #6a1fd2);
        }

        /* Animation for new word addition */
        @keyframes wordAdded {
            0% { transform: scale(0.9); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        .word-added {
            animation: wordAdded 0.3s ease;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: #333;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-microchip"></i> ESP32 Word Constructor - Firebase Monitor</h1>
            <div>Real-time monitoring from Firebase Realtime Database</div>
            <div class="firebase-status" id="firebaseStatus">
                <i class="fas fa-wifi"></i> Connecting to Firebase...
            </div>
        </header>

        <div class="dashboard">
            <!-- Sentence Construction Card -->
            <div class="card">
                <h3><i class="fas fa-keyboard"></i> Sentence Construction</h3>
                <div style="text-align: center; padding: 10px; margin-bottom: 20px;">
                    <div class="sensor-label">CURRENT WORD (Encoded)</div>
                    <div class="current-word-display" id="displayBuffer">---</div>
                    <div class="sensor-label">CURRENT WORD (Vietnamese)</div>
                    <div class="conversion-display" id="convertedCurrentWord">---</div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px;">
                        <div style="color: #4A00E0; font-weight: 600; margin-bottom: 8px;"><i class="fas fa-info-circle"></i> Instructions:</div>
                        <div style="color: #666; font-size: 0.95rem;">
                            <div><strong>Use '_' to add word to sentence</strong></div>
                            <div><strong>Use 'COMMIT' to finalize sentence</strong></div>
                        </div>
                    </div>
                    
                    <div class="sensor-label">FULL SENTENCE (Encoded)</div>
                    <div class="sentence-display" id="sentenceDisplay">---</div>
                    <div class="sensor-label">FULL SENTENCE (Vietnamese)</div>
                    <div class="conversion-display" id="convertedSentenceDisplay">---</div>
                    
                    <!-- Phrase Suggestions -->
                    <div class="phrase-suggestions">
                        <h4><i class="fas fa-lightbulb"></i> PHRASE SUGGESTIONS (Based on current words)</h4>
                        <div class="phrase-pills" id="phrasePills">
                            <!-- Phrase pills will be added here by JavaScript -->
                            <div class="phrase-pill" style="background: #6c757d; cursor: default;">
                                <i class="fas fa-spinner fa-spin"></i> Loading suggestions...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Voice Selection -->
                    <div class="voice-selection">
                        <div class="voice-option selected" data-gender="female" data-voice="Aoede">
                            <i class="fas fa-female"></i>
                            <span>Female Voice (Aoede)</span>
                        </div>
                        <div class="voice-option" data-gender="male" data-voice="Kore">
                            <i class="fas fa-male"></i>
                            <span>Male Voice (Kore)</span>
                        </div>
                        <div class="voice-option" data-gender="female" data-voice="Zubenelgenubi">
                            <i class="fas fa-user"></i>
                            <span>Female Voice 2 (Zuben)</span>
                        </div>
                    </div>
                    
                    <!-- Speech Controls -->
                    <div class="speech-controls">
                        <button class="speech-btn" onclick="speakVietnameseSentence()" id="speakVnBtn">
                            <i class="fas fa-volume-up"></i> Speak Vietnamese
                        </button>
                        <button class="speech-btn blue" onclick="speakTranslation()" id="speakTransBtn">
                            <i class="fas fa-language"></i> Speak Translation
                        </button>
                        <button class="speech-btn red" onclick="stopAllSpeech()" id="stopSpeechBtn">
                            <i class="fas fa-stop"></i> Stop Speech
                        </button>
                    </div>
                    
                    <div class="audio-visualizer" id="audioVisualizer">
                        <!-- Audio bars will be added here -->
                        <div class="audio-bar" style="height: 10px;"></div>
                        <div class="audio-bar" style="height: 20px;"></div>
                        <div class="audio-bar" style="height: 15px;"></div>
                        <div class="audio-bar" style="height: 25px;"></div>
                        <div class="audio-bar" style="height: 30px;"></div>
                        <div class="audio-bar" style="height: 25px;"></div>
                        <div class="audio-bar" style="height: 15px;"></div>
                        <div class="audio-bar" style="height: 20px;"></div>
                        <div class="audio-bar" style="height: 10px;"></div>
                    </div>
                    
                    <div class="word-list" id="wordList">
                        <div style="color: #999; text-align: center; padding: 20px;">
                            <i class="fas fa-inbox"></i> No words yet. Start constructing!
                        </div>
                    </div>
                    <div class="word-count">Words in sentence: <span id="wordCount" style="font-weight: 700; color: #4A00E0;">0</span>/10</div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px;">
                        <div>
                            <div class="sensor-label">SLOT 1</div>
                            <div class="sensor-value" id="slot1" style="font-size: 1.4rem; color: #2196F3;">---</div>
                        </div>
                        <div>
                            <div class="sensor-label">SLOT 2</div>
                            <div class="sensor-value" id="slot2" style="font-size: 1.4rem; color: #4CAF50;">---</div>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <button onclick="clearCurrentWord()" class="red tooltip">
                            <i class="fas fa-trash"></i> Clear Current
                            <span class="tooltip-text">Clear the current word buffer</span>
                        </button>
                        <button onclick="backspace()" class="tooltip">
                            <i class="fas fa-backspace"></i> Backspace
                            <span class="tooltip-text">Remove last character</span>
                        </button>
                        <button onclick="addWordToSentence()" class="green tooltip">
                            <i class="fas fa-plus-circle"></i> Add Word (_)
                            <span class="tooltip-text">Add current word to sentence</span>
                        </button>
                        <button onclick="commitSentence()" class="blue tooltip">
                            <i class="fas fa-check-double"></i> Commit Sentence
                            <span class="tooltip-text">Finalize and log the sentence</span>
                        </button>
                        <button onclick="resetSentence()" class="red tooltip">
                            <i class="fas fa-redo"></i> Reset All
                            <span class="tooltip-text">Clear entire sentence</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Translation Card -->
            <div class="card">
                <h3><i class="fas fa-language"></i> Translation</h3>
                <div style="margin-bottom: 20px;">
                    <div class="sensor-label">FULL SENTENCE (Vietnamese - For Translation)</div>
                    <textarea id="translationInput" placeholder="Enter Vietnamese text here..."></textarea>
                    
                    <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px;">
                        <div style="color: #4A00E0; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-cog"></i> Translation Options:
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <div class="sensor-label">Target Language</div>
                                <select id="targetLanguage" class="language-select">
                                    <option value="en-GB">English</option>
                                    <option value="ja-JP">Japanese</option>
                                    <option value="ko-KR">Korean</option>
                                    <option value="zh-CN">Chinese</option>
                                </select>
                            </div>
                            <div>
                                <div class="sensor-label">Voice Language</div>
                                <select id="voiceLanguage" class="language-select">
                                    <option value="vi-VN">Vietnamese</option>
                                    <option value="en-GB">English</option>
                                    <option value="ja-JP">Japanese</option>
                                    <option value="ko-KR">Korean</option>
                                    <option value="zh-CN">Chinese</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sensor-label">TRANSLATED RESULT</div>
                <div id="translationOutput" class="conversion-display" style="min-height: 90px; margin-bottom: 15px;">
                    <span style="color: #999; font-style: italic;">
                        <i class="fas fa-clock"></i> Waiting for translation...
                    </span>
                </div>

                <div class="controls">
                    <button onclick="translateSentence()" class="blue">
                        <i class="fas fa-exchange-alt"></i> Translate Sentence
                    </button>
                    <button onclick="clearTranslation()" class="red">
                        <i class="fas fa-times"></i> Clear Translation
                    </button>
                </div>
            </div>

            <!-- Sensors Display Card -->
            <div class="card">
                <h3><i class="fas fa-sensor"></i> Sensors Data from Firebase</h3>
                <div class="sensor-grid">
                    <div class="sensor-item mpu">
                        <div class="sensor-label">MPU6050 ORIENTATION</div>
                        <div class="sensor-value" id="mpuOrientation">Unknown</div>
                        <div class="sensor-label">SHAKE STATUS</div>
                        <div class="sensor-value" id="mpuShakeState" style="font-size: 1.4rem;">None</div>
                        <div class="sensor-label">IS SHAKING?</div>
                        <div class="sensor-value" id="isShaking" style="font-size: 1.8rem; color: #F44336;">NO</div>
                    </div>
                    <div class="sensor-item flex">
                        <div class="sensor-label">FLEX SENSORS</div>
                        <div>
                            <div style="margin: 15px 0;">
                                <span class="flex-box" id="flex0-box">0</span>
                                <span class="flex-box" id="flex1-box">0</span>
                                <span class="flex-box" id="flex2-box">0</span>
                                <span class="flex-box" id="flex3-box">0</span>
                            </div>
                            <div class="sensor-label" style="margin-top: 15px;">
                                Raw Values: <span id="rawValues" style="font-family: monospace;">0, 0, 0, 0</span>
                            </div>
                            <div class="sensor-label">
                                State: <span id="flexFormat" style="font-family: monospace; font-weight: 700;">0000</span> (a0,a1,a2,a3)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="sensor-item" style="margin-top: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                    <div class="sensor-label">SYSTEM STATUS</div>
                    <div style="margin-top: 10px; font-size: 1.1rem;">
                        <i class="fas fa-clock"></i> Last Update: 
                        <span id="lastUpdateTime" class="last-update" style="color: #4A00E0; font-weight: 600;">Never</span>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.9rem; color: #666;">
                        <i class="fas fa-database"></i> Firebase: <span id="connectionStatusText">Disconnected</span>
                    </div>
                </div>
                
                <div class="controls" style="margin-top: 20px;">
                    <button onclick="refreshData()" class="blue">
                        <i class="fas fa-sync-alt"></i> Refresh Now
                    </button>
                    <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="green">
                        <i class="fas fa-toggle-on"></i> Auto: ON
                    </button>
                </div>
            </div>

            <!-- Log Display Card -->
            <div class="card">
                <h3><i class="fas fa-clipboard-list"></i> System Log</h3>
                <div style="max-height: 300px; overflow-y: auto; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; padding: 15px; border: 1px solid #dee2e6;">
                    <div id="logContainer">
                        <div class="log-entry">
                            <span style="color: #4A00E0; font-weight: 600;">[System]</span>
                            <span>Application started. Waiting for Firebase data...</span>
                        </div>
                    </div>
                </div>
                <div class="controls" style="margin-top: 20px;">
                    <button onclick="clearLog()" class="red">
                        <i class="fas fa-broom"></i> Clear Log
                    </button>
                    <button onclick="exportLog()" class="blue">
                        <i class="fas fa-download"></i> Export Log
                    </button>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div>
                <span class="indicator" id="connectionStatus"></span>
                <span id="statusText">Connecting to Firebase...</span>
            </div>
            <div>
                <i class="fas fa-clock"></i>
                <span id="lastUpdate">Last Firebase update: --:--:--</span>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const FIREBASE_URL = "https://gangtay-f1efe-default-rtdb.asia-southeast1.firebasedatabase.app/sensorData.json";
        
        // Tables from ESP32 code
        const tableA = [
            ["IAY","IC","ICH","IE","IEC","IEM","IEN","IENG","IEO"],
            ["IEP","IET","IEU","IM","IN","ING","INH","IO","IOI"],
            ["ENG","ENH","EO","EP","ET","EU","I","IA","IAC"],
            ["IAI","IAM","IAN","IANG","IANH","IAO","IAP","IAT","IAU"],
            ["AP","AT","AU","AY","E","EC","ECH","EM","EN"],
            ["A","AC","ACH","AI","AM","AN","ANG","ANH","AO"],
            ["IUN","IUONG","IUP","O","OA","OAC","OACH","OAI","OAM"],
            ["ION","IONG","IOT","IP","IT","IU","IUA","IUC","IUI"]
        ];

        const tableB = [
            ["UE","UECH","UEN","UENH","UEO","UET","UI","UM","UN"],
            ["UNG","UO","UOC","UOI","UOM","UON","UONG","UOP","OUT"],
            ["ONG","OOC","OONG","OP","OT","U","UA","UAC","UACH"],
            ["UAI","UAM","UAN","UANG","UANH","UAO","UAT","UAY","UC"],
            ["OAY","OC","OE","OEN","OEO","OET","OI","OM","ON"],
            ["COMMIT","_","nullptr","nullptr","OAN","OANG","OANH","OAP","OAT"],
            ["UYNH","UYP","UYT","UYU","Y","YEM","YEN","YET","YEU"],
            ["UOU","UP","UT","UU","UY","UYA","UYCH","UYEN","UYET"]
        ];

        const tableC = [
            [ ["B","C","D"],["Đ","G","H"],["K","L","M"] ],
            [ ["N","P","Q"],["R","S","T"],["V","X","CH"] ],
            [ ["GH","KH","NG"],["NGH","NH","PH"],["TH","TR","_"] ]
        ];

        // Vietnamese Conversion Table (full table from ESP32 code)
        const vietnameseTable = [
            {key: "IAY", forms: ["iáy", "iày", "iảy", "iãy", "iạy", "iay", "iấy", "iầy", "iẩy", "iẫy", "iậy", "iây", "iắy", "iằy", "iẳy", "iẵy", "iặy", "iăy"]},
            {key: "IC", forms: ["íc", "ìc", "ỉc", "ĩc", "ịc", "ic", "íc", "ìc", "ỉc", "ĩc", "ịc", "ic", "íc", "ìc", "ỉc", "ĩc", "ịc", "ic"]},
            {key: "ICH", forms: ["ích", "ìch", "ỉch", "ĩch", "ịch", "ich", "ích", "ìch", "ỉch", "ĩch", "ịch", "ich", "ích", "ìch", "ỉch", "ĩch", "ịch", "ich"]},
            {key: "IE", forms: ["ié", "iè", "iẻ", "iẽ", "iẹ", "ie", "iế", "iề", "iể", "iễ", "iệ", "iê", "ié", "iè", "iẻ", "iẽ", "iẹ", "ie"]},
            {key: "IEC", forms: ["iéc", "ièc", "iẻc", "iẽc", "iẹc", "iec", "iếc", "iềc", "iểc", "iễc", "iệc", "iêc", "iéc", "ièc", "iẻc", "iẽc", "iẹc", "iec"]},
            {key: "IEM", forms: ["iém", "ièm", "iểm", "iẽm", "ịem", "iem", "iếm", "iềm", "iểm", "iễm", "iệm", "iêm", "iém", "ièm", "iểm", "iẽm", "ịem", "iem"]},
            {key: "IEN", forms: ["ien", "ièn", "iẻn", "iẽn", "iẹn", "ien", "iên", "iền", "iển", "iễn", "iện", "iên", "ien", "ièn", "iẻn", "iẽn", "iẹn", "ien"]},
            {key: "IENG", forms: ["ieng", "ièng", "iẻng", "iẽng", "iẹng", "ieng", "iêng", "iềng", "iểng", "iễng", "iệng", "iêng", "ieng", "ièng", "iẻng", "iẽng", "iẹng", "ieng"]},
            {key: "IEO", forms: ["iéo", "ièo", "iẻo", "iẽo", "iẹo", "ieo", "iếo", "iềo", "iểo", "iễo", "iệo", "iêo", "iéo", "ièo", "iẻo", "iẽo", "iẹo", "ieo"]},
            {key: "IEP", forms: ["iép", "ièp", "iẻp", "iẽp", "iẹp", "iep", "iếp", "iềp", "iểp", "iễp", "iệp", "iêp", "iép", "ièp", "iẻp", "iẽp", "iẹp", "iep"]},
            {key: "IET", forms: ["iét", "ièt", "iẻt", "iẽt", "iẹt", "iet", "iết", "iềt", "iểt", "iễt", "iệt", "iêt", "iét", "ièt", "iẻt", "iẽt", "iẹt", "iet"]},
            {key: "IEU", forms: ["iéu", "ièu", "iẻu", "iẽu", "iẹu", "ieu", "iếu", "iều", "iểu", "iễu", "iệu", "iêu", "iéu", "ièu", "iẻu", "iẽu", "iẹu", "ieu"]},
            {key: "IM", forms: ["ím", "ìm", "ỉm", "ĩm", "ịm", "im", "ím", "ìm", "ỉm", "ĩm", "ịm", "im", "ím", "ìm", "ỉm", "ĩm", "ịm", "im"]},
            {key: "IN", forms: ["ín", "ìn", "ỉn", "ĩn", "ịn", "in", "ín", "ìn", "ỉn", "ĩn", "ịn", "in", "ín", "ìn", "ỉn", "ĩn", "ịn", "in"]},
            {key: "ING", forms: ["íng", "ìng", "ỉng", "ĩng", "ịng", "ing", "íng", "ìng", "ỉng", "ĩng", "ịng", "ing", "íng", "ìng", "ỉng", "ĩng", "ịng", "ing"]},
            {key: "INH", forms: ["ính", "ình", "ỉnh", "ĩnh", "ịnh", "inh", "ính", "ình", "ỉnh", "ĩnh", "ịnh", "inh", "ính", "ình", "ỉnh", "ĩnh", "ịnh", "inh"]},
            {key: "IO", forms: ["ió", "iò", "iỏ", "iõ", "iọ", "io", "iố", "iồ", "iổ", "iỗ", "iộ", "iô", "iớ", "iờ", "iở", "iỡ", "iợ", "iơ"]},
            {key: "IOI", forms: ["iói", "iòi", "iỏi", "iõi", "iọi", "ioi", "iối", "iồi", "iổi", "iỗi", "iội", "iôi", "iới", "iời", "iởi", "iỡi", "iợi", "iơi"]},
            {key: "I", forms: ["í", "ì", "ỉ", "ĩ", "ị", "i", "í", "ì", "ỉ", "ĩ", "ị", "i", "í", "ì", "ỉ", "ĩ", "ị", "i"]},
            {key: "IA", forms: ["ía", "ìa", "ỉa", "ĩa", "ịa", "ia", "ía", "ìa", "ỉa", "ĩa", "ịa", "ia", "ía", "ìa", "ỉa", "ĩa", "ịa", "ia"]},
            {key: "IAI", forms: ["iái", "iài", "iải", "iãi", "iại", "iai", "iấi", "iầi", "iẩi", "iẫi", "iậi", "iâi", "iắi", "iằi", "iẳi", "iẵi", "iặi", "iăi"]},
            {key: "IAM", forms: ["iám", "iàm", "iảm", "iãm", "iạm", "iam", "iấm", "iầm", "iẩm", "iẫm", "iậm", "iâm", "iắm", "iằm", "iẳm", "iẵm", "iặm", "iăm"]},
            {key: "IAN", forms: ["ián", "iàn", "iản", "iãn", "iạn", "ian", "iấn", "iần", "iẩn", "iẫn", "iận", "iân", "iắn", "iằn", "iẳn", "iẵn", "iặn", "iăn"]},
            {key: "IANG", forms: ["iáng", "iàng", "iảng", "iãng", "iạng", "iang", "iấng", "iầng", "iẩng", "iẫng", "iậng", "iâng", "iắng", "iằng", "iẳng", "iẵng", "iặng", "iăng"]},
            {key: "IANH", forms: ["iánh", "iành", "iảnh", "iãnh", "iạnh", "ianh", "iấnh", "iầnh", "iẩnh", "iẫnh", "iậnh", "iânh", "iắnh", "iằnh", "iẳnh", "iẵnh", "iặnh", "iănh"]},
            {key: "IAO", forms: ["iáo", "iào", "iảo", "ião", "iạo", "iao", "iáo", "iào", "iảo", "ião", "iạo", "iao", "iáo", "iào", "iảo", "ião", "iạo", "iao"]},
            {key: "IAP", forms: ["iáp", "iàp", "iảp", "iãp", "iạp", "iap", "iấp", "iầp", "iẩp", "iẫp", "iập", "iâp", "iắp", "iằp", "iẳp", "iẵp", "iặp", "iăp"]},
            {key: "IAT", forms: ["iát", "iàt", "iảt", "iãt", "iạt", "iat", "iất", "iầt", "iẩt", "iẫt", "iật", "iât", "iắt", "iằt", "iẳt", "iẵt", "iặt", "iăt"]},
            {key: "IAU", forms: ["iáu", "iàu", "iảu", "iãu", "iạu", "iau", "iấu", "iầu", "iẩu", "iẫu", "iậu", "iâu", "iáu", "iàu", "iảu", "iãu", "iạu", "iau"]},
            {key: "AP", forms: ["áp", "àp", "ảp", "ãp", "ạp", "ap", "ấp", "ầp", "ẩp", "ẫp", "ập", "âp", "ắp", "ằp", "ẳp", "ẵp", "ặp", "ăp"]},
            {key: "AT", forms: ["át", "àt", "ảt", "ãt", "ạt", "at", "ất", "ầt", "ẩt", "ẫt", "ật", "ât", "ắt", "ằt", "ẳt", "ẵt", "ặt", "ăt"]},
            {key: "AU", forms: ["áu", "àu", "ảu", "ãu", "ạu", "au", "ấu", "ầu", "ẩu", "ẫu", "ậu", "âu", "ắu", "ằu", "ẳu", "ẵu", "ặu", "ău"]},
            {key: "AY", forms: ["áy", "ày", "ảy", "ãy", "ạy", "ay", "ấy", "ầy", "ẩy", "ẫy", "ậy", "ây", "ắy", "ằy", "ẳy", "ẵy", "ặy", "ăy"]},
            {key: "E", forms: ["é", "è", "ẻ", "ẽ", "ẹ", "e", "ế", "ề", "ể", "ễ", "ệ", "ê", "é", "è", "ẻ", "ẽ", "ẹ", "e"]},
            {key: "EM", forms: ["ém", "èm", "ểm", "ẽm", "ẹm", "em", "ếm", "ềm", "ểm", "ễm", "ệm", "êm", "ém", "èm", "ểm", "ẽm", "ẹm", "em"]},
            {key: "EN", forms: ["én", "èn", "ển", "ễn", "ện", "en", "ến", "ền", "ển", "ễn", "ện", "ên", "én", "èn", "ển", "ễn", "ện", "en"]},
            {key: "A", forms: ["á", "à", "ả", "ã", "ạ", "a", "ấ", "ầ", "ẩ", "ẫ", "ậ", "â", "ắ", "ằ", "ẳ", "ẵ", "ặ", "ă"]},
            {key: "AI", forms: ["ái", "ài", "ải", "ãi", "ại", "ai", "ấi", "ầi", "ẩi", "ẫi", "ậi", "âi", "ắi", "ằi", "ẳi", "ẵi", "ặi", "ăi"]},
            {key: "AM", forms: ["ám", "àm", "ảm", "ãm", "ạm", "am", "ấm", "ầm", "ẩm", "ẫm", "ậm", "âm", "ắm", "ằm", "ẳm", "ẵm", "ặm", "ăm"]},
            {key: "AN", forms: ["án", "àn", "ản", "ãn", "ạn", "an", "ấn", "ần", "ẩn", "ẫn", "ận", "ân", "ắn", "ằn", "ẳn", "ẵn", "ặn", "ăn"]},
            {key: "ANG", forms: ["áng", "àng", "ảng", "ãng", "ạng", "ang", "ấng", "ầng", "ẩng", "ẫng", "ậng", "âng", "ắng", "ằng", "ẳng", "ẵng", "ặng", "ăng"]},
            {key: "ANH", forms: ["ánh", "ành", "ảnh", "ãnh", "ạnh", "anh", "ấnh", "ầnh", "ẩnh", "ẫnh", "ậnh", "ânh", "ắnh", "ằnh", "ẳnh", "ẵnh", "ặnh", "ănh"]},
            {key: "AO", forms: ["áo", "ào", "ảo", "ão", "ạo", "ao", "ấo", "ầo", "ẩo", "ẫo", "ậo", "âo", "ắo", "ằo", "ẳo", "ẵo", "ặo", "ăo"]},
            {key: "UE", forms: ["ué", "uè", "uẻ", "uẽ", "uẹ", "ue", "uế", "uề", "uể", "uễ", "uệ", "uê", "ưé", "ưè", "ưẻ", "ưẽ", "ưẹ", "ưe"]},
            {key: "UEN", forms: ["uên", "uền", "uển", "uễn", "uện", "uen", "uên", "uền", "uển", "uễn", "uện", "uên", "ưên", "ưền", "ưển", "ưễn", "ưện", "ưen"]},
            {key: "UI", forms: ["úi", "ùi", "ủi", "ũi", "ụi", "ui", "úi", "ùi", "ủi", "ũi", "ụi", "ui", "ứi", "ừi", "ửi", "ữi", "ựi", "ưi"]},
            {key: "UM", forms: ["úm", "ùm", "ủm", "ũm", "ụm", "um", "úm", "ùm", "ủm", "ũm", "ụm", "um", "ứm", "ừm", "ửm", "ữm", "ựm", "ưm"]},
            {key: "UN", forms: ["ún", "ùn", "ủn", "ũn", "ụn", "un", "ún", "ùn", "ủn", "ũn", "ụn", "un", "ứn", "ừn", "ửn", "ữn", "ựn", "ưn"]},
            {key: "UNG", forms: ["úng", "ùng", "ủng", "ũng", "ụng", "ung", "úng", "ùng", "ủng", "ũng", "ụng", "ung", "ứng", "ừng", "ửng", "ững", "ựng", "ưng"]},
            {key: "UO", forms: ["uó", "uò", "uỏ", "uõ", "uọ", "uo", "uố", "uồ", "uổ", "uỗ", "uộ", "uô", "ướ", "ườ", "ưở", "ưỡ", "ượ", "ươ"]},
            {key: "UOC", forms: ["uốc", "uộc", "uổc", "uỗc", "uộc", "uoc", "uốc", "uộc", "uổc", "uỗc", "uộc", "uôc", "ưốc", "ưộc", "ưổc", "ưỗc", "ưộc", "ươc"]},
            {key: "UOI", forms: ["uối", "uồi", "uổi", "uỗi", "uội", "uoi", "uối", "uồi", "uổi", "uỗi", "uội", "uôi", "ưối", "ưồi", "ưổi", "ưỗi", "ưội", "ươi"]},
            {key: "UON", forms: ["uón", "uòn", "uỏn", "uõn", "uọn", "uon", "uốn", "uồn", "uổn", "uỗn", "uộn", "uôn", "ướn", "ườn", "ưởn", "ưỡn", "ượn", "ươn"]},
            {key: "UONG", forms: ["uóng", "uòng", "uỏng", "uõng", "uọng", "uong", "uống", "uồng", "uổng", "uỗng", "uộng", "uông", "ướng", "ường", "ưởng", "ưỡng", "ượng", "ương"]},
            {key: "ONG", forms: ["óng", "òng", "ỏng", "õng", "ọng", "ong", "ống", "ồng", "ổng", "ỗng", "ộng", "ông", "ớng", "ờng", "ởng", "ỡng", "ợng", "ơng"]},
            {key: "OP", forms: ["óp", "òp", "ỏp", "õp", "ọp", "op", "ốp", "ồp", "ổp", "ỗp", "ộp", "ôp", "ớp", "ờp", "ởp", "ỡp", "ợp", "ơp"]},
            {key: "OT", forms: ["ót", "òt", "ỏt", "õt", "ọt", "ot", "ốt", "ồt", "ổt", "ỗt", "ột", "ôt", "ớt", "ờt", "ởt", "ỡt", "ợt", "ơt"]},
            {key: "U", forms: ["ú", "ù", "ủ", "ũ", "ụ", "u", "ú", "ù", "ủ", "ũ", "ụ", "u", "ứ", "ừ", "ử", "ữ", "ự", "ư"]},
            {key: "UA", forms: ["úa", "ùa", "ủa", "ũa", "ụa", "ua", "úa", "ùa", "ủa", "ũa", "ụa", "ua", "úa", "ùa", "ủa", "ũa", "ụa", "ua"]},
            {key: "UAI", forms: ["uái", "uài", "uải", "uãi", "uại", "uai", "uái", "uài", "uải", "uãi", "uại", "uai", "uái", "uài", "uải", "uãi", "uại", "uai"]},
            {key: "UAN", forms: ["uán", "uàn", "uản", "uãn", "uạn", "uan", "uấn", "uần", "uẩn", "uẫn", "uận", "uân", "uắn", "uằn", "uẳn", "uẵn", "uặn", "uăn"]},
            {key: "UANG", forms: ["uáng", "uàng", "uảng", "uãng", "uạng", "uang", "uấng", "uầng", "uẩng", "uẫng", "uậng", "uâng", "uắng", "uằng", "uẳng", "uẵng", "uặng", "uăng"]},
            {key: "UANH", forms: ["uánh", "uành", "uảnh", "uãnh", "uạnh", "uanh", "uấnh", "uầnh", "uẩnh", "uẫnh", "uậnh", "uânh", "uắnh", "uằnh", "uẳnh", "uẵnh", "uặnh", "uănh"]},
            {key: "UAY", forms: ["uáy", "uày", "uảy", "uãy", "uạy", "uay", "uấy", "uầy", "uẩy", "uẫy", "uậy", "uây", "uắy", "uằy", "uẳy", "uẵy", "uặy", "uăy"]},
            {key: "UC", forms: ["úc", "ùc", "ủc", "ũc", "ục", "uc", "úc", "ùc", "ủc", "ũc", "ục", "uc", "ức", "ừc", "ửc", "ữc", "ực", "ưc"]},
            {key: "OAY", forms: ["oáy", "oày", "oảy", "oãy", "oạy", "oay", "oáy", "oày", "oảy", "oãy", "oạy", "oay", "oáy", "oày", "oảy", "oãy", "oạy", "oay"]},
            {key: "OC", forms: ["óc", "òc", "ỏc", "õc", "ọc", "oc", "ốc", "ồc", "ổc", "ỗc", "ộc", "ôc", "ớc", "ờc", "ởc", "ỡc", "ợc", "ơc"]},
            {key: "OE", forms: ["óe", "òe", "ỏe", "õe", "ọe", "oe", "óe", "òe", "ỏe", "õe", "ọe", "oe", "óe", "òe", "ỏe", "õe", "ọe", "oe"]},
            {key: "OI", forms: ["ói", "òi", "ỏi", "õi", "ọi", "oi", "ối", "ồi", "ổi", "ỗi", "ội", "ôi", "ới", "ời", "ởi", "ỡi", "ợi", "ơi"]},
            {key: "OM", forms: ["óm", "òm", "ỏm", "õm", "ọm", "om", "ốm", "ồm", "ổm", "ỗm", "ộm", "ôm", "ớm", "ờm", "ởm", "ỡm", "ợm", "ơm"]},
            {key: "ON", forms: ["ón", "òn", "ỏn", "õn", "ọn", "on", "ốn", "ồn", "ổn", "ỗn", "ộn", "ôn", "ớn", "ờn", "ởn", "ỡn", "ợn", "ơn"]},
            {key: "OAN", forms: ["oán", "oàn", "oản", "oãn", "oạn", "oan", "oán", "oàn", "oản", "oãn", "oạn", "oan", "oán", "oàn", "oản", "oãn", "oạn", "oan"]},
            {key: "OANG", forms: ["oáng", "oàng", "oảng", "oãng", "oạng", "oang", "oáng", "oàng", "oảng", "oãng", "oạng", "oang", "oáng", "oàng", "oảng", "oãng", "oạng", "oang"]},
            {key: "OANH", forms: ["oánh", "oành", "oảnh", "oãnh", "oạnh", "oanh", "oánh", "oành", "oảnh", "oãnh", "oạnh", "oanh", "oánh", "oành", "oảnh", "oãnh", "oạnh", "oanh"]},
            {key: "OAT", forms: ["oát", "òat", "oảt", "oãt", "oạt", "oat", "oát", "òat", "oảt", "oãt", "oạt", "oat", "oát", "òat", "oảt", "oãt", "oạt", "oat"]},
            {key: "Y", forms: ["ý", "ỳ", "ỷ", "ỹ", "ỵ", "y", "ý", "ỳ", "ỷ", "ỹ", "ỵ", "y", "ý", "ỳ", "ỷ", "ỹ", "ỵ", "y"]},
            {key: "YEN", forms: ["yen", "yèn", "yẻn", "yẽn", "yẹn", "yen", "yên", "yền", "yển", "yễn", "yện", "yên", "yen", "yèn", "yẻn", "yẽn", "yẹn", "yen"]},
            {key: "YET", forms: ["yét", "yèt", "yẻt", "yẽt", "yẹt", "yet", "yết", "yềt", "yểt", "yễt", "yệt", "yêt", "yét", "yèt", "yẻt", "yẽt", "yẹt", "yet"]},
            {key: "YEU", forms: ["yêu", "yều", "yểu", "yễu", "yệu", "yeu", "yêu", "yều", "yểu", "yễu", "yệu", "yêu", "yêu", "yều", "yểu", "yễu", "yệu", "yeu"]},
            {key: "UY", forms: ["úy", "ùy", "ủy", "ũy", "ụy", "uy", "úy", "ùy", "ủy", "ũy", "ụy", "uy", "ứy", "ừy", "ửy", "ữy", "ựy", "ưy"]},
            {key: "UYET", forms: ["uyét", "uyèt", "uyẻt", "uyẽt", "uyẹt", "uyet", "uyết", "uyềt", "uyểt", "uyễt", "uyệt", "uyêt", "uyét", "uyèt", "uyẻt", "uyẽt", "uyẹt", "uyet"]},
            {key: "AC", forms: ["ác", "àc", "ảc", "ãc", "ạc", "ac", "ấc", "ầc", "ẩc", "ẫc", "ậc", "âc", "ắc", "ằc", "ẳc", "ẵc", "ặc", "ăc"]},
            {key: "ACH", forms: ["ách", "àch", "ảch", "ãch", "ạch", "ach", "ấch", "ầch", "ẩch", "ẫch", "ậch", "âch", "ắch", "ằch", "ẳch", "ẵch", "ặch", "ăch"]},
            {key: "EC", forms: ["éc", "èc", "ẻc", "ẽc", "ẹc", "ec", "ếc", "ềc", "ểc", "ễc", "ệc", "êc", "éc", "èc", "ẻc", "ẽc", "ẹc", "ec"]},
            {key: "ECH", forms: ["éch", "èch", "ẻch", "ẽch", "ẹch", "ech", "ếch", "ềch", "ểch", "ễch", "ệch", "êch", "éch", "èch", "ẻch", "ẽch", "ẹch", "ech"]},
            {key: "ENG", forms: ["éng", "èng", "ẻng", "ẽng", "ẹng", "eng", "ếng", "ềng", "ểng", "ễng", "ệng", "êng", "éng", "èng", "ẻng", "ẽng", "ẹng", "eng"]},
            {key: "ENH", forms: ["enh", "ènh", "ẻnh", "ẽnh", "ẹnh", "enh", "ếnh", "ềnh", "ểnh", "ễnh", "ệnh", "ênh", "enh", "ènh", "ẻnh", "ẽnh", "ẹnh", "enh"]},
            {key: "EO", forms: ["éo", "èo", "ẻo", "ẽo", "ẹo", "eo", "éo", "èo", "ẻo", "ẽo", "ẹo", "eo", "éo", "èo", "ẻo", "ẽo", "ẹo", "eo"]},
            {key: "EP", forms: ["ép", "èp", "ẻp", "ẽp", "ẹp", "ep", "ếp", "ềp", "ểp", "ễp", "ệp", "êp", "ép", "èp", "ẻp", "ẽp", "ẹp", "ep"]},
            {key: "ET", forms: ["ét", "èt", "ẻt", "ẽt", "ẹt", "et", "ết", "ềt", "ểt", "ễt", "ệt", "êt", "ét", "èt", "ẻt", "ẽt", "ẹt", "et"]},
            {key: "EU", forms: ["éu", "èu", "ẻu", "ẽu", "ẹu", "eu", "ếu", "ều", "ểu", "ễu", "ệu", "êu", "éu", "èu", "ẻu", "ẽu", "ẹu", "eu"]},
            {key: "IAC", forms: ["iác", "iàc", "iảc", "iãc", "iạc", "iac", "iấc", "iầc", "iẩc", "iẫc", "iậc", "iâc", "iắc", "iằc", "iẳc", "iẵc", "iặc", "iăc"]},
            {key: "ION", forms: ["ión", "ìon", "ỉon", "ĩon", "ịon", "ion", "ión", "ìon", "ỉon", "ĩon", "ịon", "ion", "ión", "ìon", "ỉon", "ĩon", "ịon", "ion"]},
            {key: "IONG", forms: ["ióng", "ìong", "ỉong", "ĩong", "ịong", "iong", "ióng", "ìong", "ỉong", "ĩong", "ịong", "iong", "ióng", "ìong", "ỉong", "ĩong", "ịong", "iong"]},
            {key: "IOT", forms: ["iót", "ìot", "ỉot", "ĩot", "ịot", "iot", "iót", "ìot", "ỉot", "ĩot", "ịot", "iot", "iót", "ìot", "ỉot", "ĩot", "ịot", "iot"]},
            {key: "IP", forms: ["íp", "ìp", "ỉp", "ĩp", "ịp", "ip", "íp", "ìp", "ỉp", "ĩp", "ịp", "ip", "íp", "ìp", "ỉp", "ĩp", "ịp", "ip"]},
            {key: "IT", forms: ["ít", "ìt", "ỉt", "ĩt", "ịt", "it", "ít", "ìt", "ỉt", "ĩt", "ịt", "it", "ít", "ìt", "ỉt", "ĩt", "ịt", "it"]},
            {key: "IU", forms: ["iú", "ìu", "ỉu", "ĩu", "ịu", "iu", "iú", "ìu", "ỉu", "ĩu", "ịu", "iu", "iú", "ìu", "ỉu", "ĩu", "ịu", "iu"]},
            {key: "IUA", forms: ["iúa", "iùa", "iủa", "iũa", "iụa", "iua", "iúa", "iùa", "iủa", "iũa", "iụa", "iua", "iúa", "iùa", "iủa", "iũa", "iụa", "iua"]},
            {key: "IUC", forms: ["iúc", "iùc", "iủc", "iũc", "iục", "iuc", "iúc", "iùc", "iủc", "iũc", "iục", "iuc", "iúc", "iùc", "iủc", "iũc", "iục", "iuc"]},
            {key: "IUI", forms: ["íui", "ìui", "ỉui", "ĩui", "ịui", "iui", "íui", "ìui", "ỉui", "ĩui", "ịui", "iui", "íui", "ìui", "ỉui", "ĩui", "ịui", "iui"]},
            {key: "IUN", forms: ["iún", "iùn", "iủn", "iũn", "iụn", "iun", "iún", "iùn", "iủn", "iũn", "iụn", "iun", "iún", "iùn", "iủn", "iũn", "iụn", "iun"]},
            {key: "IUONG", forms: ["íuong", "ìuong", "ỉuong", "ĩuong", "ịuong", "iuong", "íuong", "ìuong", "ỉuong", "ĩuong", "ịuong", "iuong", "iướng", "iường", "iưởng", "iưỡng", "iượng", "iương"]},
            {key: "IUP", forms: ["iúp", "iùp", "iủp", "iũp", "iụp", "iup", "iúp", "iùp", "iủp", "iũp", "iụp", "iup", "íup", "ìup", "ỉup", "iũp", "iụp", "iup"]},
            {key: "O", forms: ["ó", "ò", "ỏ", "õ", "ọ", "o", "ố", "ồ", "ổ", "ỗ", "ộ", "ô", "ớ", "ờ", "ở", "ỡ", "ợ", "ơ"]},
            {key: "OA", forms: ["óa", "òa", "ỏa", "õa", "ọa", "oa", "óa", "òa", "ỏa", "õa", "ọa", "oa", "óa", "òa", "ỏa", "õa", "ọa", "oa"]},
            {key: "OAC", forms: ["oác", "oàc", "oảc", "oãc", "oạc", "oac", "oác", "oàc", "oảc", "oãc", "oạc", "oac", "oắc", "oằc", "oẳc", "oẵc", "oặc", "oăc"]},
            {key: "OACH", forms: ["oách", "oàch", "oảch", "oãch", "oạch", "oach", "oách", "oàch", "oảch", "oãch", "oạch", "oach", "oách", "oàch", "oảch", "oãch", "oạch", "oach"]},
            {key: "OAI", forms: ["oái", "oài", "oải", "oãi", "oại", "oai", "oái", "oài", "oải", "oãi", "oại", "oai", "oái", "oài", "oải", "oãi", "oại", "oai"]},
            {key: "OAM", forms: ["oám", "oàm", "oảm", "oãm", "oạm", "oam", "oám", "oàm", "oảm", "oãm", "oạm", "oam", "oám", "oàm", "oảm", "oãm", "oạm", "oam"]},
            {key: "OEN", forms: ["oén", "oèn", "oẻn", "oẽn", "oẹn", "oen", "oến", "oền", "oển", "oễn", "oện", "oên", "oén", "oèn", "oẻn", "oẽn", "oẹn", "oen"]},
            {key: "OEO", forms: ["oéo", "oèo", "oẻo", "oẽo", "oẹo", "oeo", "oếo", "oềo", "oểo", "oễo", "oệo", "oêo", "oéo", "oèo", "oẻo", "oẽo", "oẹo", "oeo"]},
            {key: "OET", forms: ["oét", "oèt", "oẻt", "oẽt", "oẹt", "oet", "oết", "oềt", "oểt", "oễt", "oệt", "oêt", "oét", "oèt", "oẻt", "oẽt", "oẹt", "oet"]},
            {key: "OOC", forms: ["oóc", "oòc", "oỏc", "oõc", "oọc", "ooc", "oóc", "oòc", "oỏc", "oõc", "oọc", "ooc", "oóc", "oòc", "oỏc", "oõc", "oọc", "ooc"]},
            {key: "OONG", forms: ["oóng", "oòng", "oỏng", "oõng", "oọng", "oong", "oóng", "oòng", "oỏng", "oõng", "oọng", "oong", "oóng", "oòng", "oỏng", "oõng", "oọng", "oong"]},
            {key: "UAC", forms: ["uác", "uàc", "uảc", "uãc", "uạc", "uac", "uấc", "uầc", "uẩc", "uẫc", "uậc", "uâc", "uắc", "uằc", "uẳc", "uẵc", "uặc", "uăc"]},
            {key: "UACH", forms: ["uách", "uàch", "uảch", "uãch", "uạch", "uach", "uấch", "uầch", "uẩch", "uẫch", "uậch", "uâch", "uắch", "uằch", "uẳch", "uẵch", "uặch", "uăch"]},
            {key: "UAI", forms: ["uái", "uài", "uải", "uãi", "uại", "uai", "uấi", "uầi", "uẩi", "uẫi", "uậi", "uâi", "uái", "uài", "uải", "uãi", "uại", "uai"]},
            {key: "UAM", forms: ["uám", "uàm", "uảm", "uãm", "uạm", "uam", "uấm", "uầm", "uẩm", "uẫm", "uậm", "uâm", "uám", "uàm", "uảm", "uãm", "uạm", "uam"]},
            {key: "UAO", forms: ["uáo", "uào", "uảo", "uão", "uạo", "uao", "uáo", "uào", "uảo", "uão", "uạo", "uao", "uáo", "uào", "uảo", "uão", "uạo", "uao"]},
            {key: "UAT", forms: ["uát", "uàt", "uảt", "uãt", "uạt", "uat", "uất", "uầt", "uẩt", "uẫt", "uật", "uât", "uắt", "uằt", "uẳt", "uẵt", "uặt", "uăt"]},
            {key: "UECH", forms: ["uéch", "uèch", "uẻch", "uẽch", "uẹch", "uech", "uếch", "uềch", "uểch", "uễch", "uệch", "uêch", "uéch", "uèch", "uẻch", "uẽch", "uẹch", "uech"]},
            {key: "UENH", forms: ["uénh", "uènh", "uẻnh", "uẽnh", "uẹnh", "uenh", "uếnh", "uềnh", "uểnh", "uễnh", "uệnh", "uênh", "uénh", "uènh", "uẻnh", "uẽnh", "uẹnh", "uenh"]},
            {key: "UEO", forms: ["uéo", "uèo", "uẻo", "uẽo", "uẹo", "ueo", "uếo", "uềo", "uểo", "uễo", "uệo", "uêo", "uéo", "uèo", "uẻo", "uẽo", "uẹo", "ueo"]},
            {key: "UET", forms: ["uét", "uèt", "uẻt", "uẽt", "uẹt", "uet", "uết", "uềt", "uểt", "uễt", "uệt", "uêt", "uét", "uèt", "uẻt", "uẽt", "uẹt", "uet"]},
            {key: "UOM", forms: ["uóm", "uòm", "uỏm", "uõm", "uọm", "uom", "uốm", "uồm", "uổm", "uỗm", "uộm", "uôm", "ướm", "ườm", "ưởm", "ưỡm", "ượm", "ươm"]},
            {key: "UOP", forms: ["uóp", "uòp", "uỏp", "uõp", "uọp", "uop", "uốp", "uồp", "uổp", "uỗp", "uộp", "uôp", "ướp", "ườp", "ưởp", "ưỡp", "ượp", "ươp"]},
            {key: "OUT", forms: ["óut", "òut", "ỏut", "õut", "ọut", "out", "óut", "òut", "ỏut", "õut", "ọut", "out", "óut", "òut", "ỏut", "õut", "ọut", "out"]},
            {key: "UOU", forms: ["uóu", "uòu", "uỏu", "uõu", "uọu", "uou", "uốu", "uồu", "uổu", "uỗu", "uộu", "uôu", "ướu", "ườu", "ưởu", "ưỡu", "ượu", "ươu"]},
            {key: "UP", forms: ["úp", "ùp", "ủp", "ũp", "ụp", "up", "úp", "ùp", "ủp", "ũp", "ụp", "up", "ứp", "ừp", "ửp", "ữp", "ựp", "ưp"]},
            {key: "UT", forms: ["út", "ùt", "ủt", "ũt", "ụt", "ut", "út", "ùt", "ủt", "ũt", "ụt", "ut", "ứt", "ừt", "ửt", "ữt", "ựt", "ưt"]},
            {key: "UU", forms: ["úu", "ùu", "ủu", "ũu", "ụu", "uu", "úu", "ùu", "ủu", "ũu", "ụu", "uu", "ứu", "ừu", "ửu", "ữu", "ựu", "ưu"]},
            {key: "UYA", forms: ["uýa", "uỳa", "uỷa", "uỹa", "uỵa", "uya", "uýa", "uỳa", "uỷa", "uỹa", "uỵa", "uya", "uýa", "uỳa", "uỷa", "uỹa", "uỵa", "uya"]},
            {key: "UYCH", forms: ["uých", "uỳch", "uỷch", "uỹch", "uỵch", "uych", "uých", "uỳch", "uỷch", "uỹch", "uỵch", "uych", "uých", "uỳch", "uỷch", "uỹch", "uỵch", "uych"]},
            {key: "UYEN", forms: ["uyén", "uyèn", "uyẻn", "uyẽn", "uyẹn", "uyen", "uyến", "uyền", "uyển", "uyễn", "uyện", "uyên", "uyén", "uyèn", "uyẻn", "uyẽn", "uyẹn", "uyen"]},
            {key: "UYET", forms: ["uyét", "uyèt", "uyẻt", "uyẽt", "uyẹt", "uyet", "uyết", "uyềt", "uyểt", "uyễt", "uyệt", "uyêt", "uyét", "uyèt", "uyẻt", "uyẽt", "uyẹt", "uyet"]},
            {key: "UYNH", forms: ["uýnh", "uỳnh", "uỷnh", "uỹnh", "uỵnh", "uynh", "uýnh", "uỳnh", "uỷnh", "uỹnh", "uỵnh", "uynh", "uýnh", "uỳnh", "uỷnh", "uỹnh", "uỵnh", "uynh"]},
            {key: "UYP", forms: ["uýp", "uỳp", "uỷp", "uỹp", "uỵp", "uyp", "uýp", "uỳp", "uỷp", "uỹp", "uỵp", "uyp", "uýp", "uỳp", "uỷp", "uỹp", "uỵp", "uyp"]},
            {key: "UYT", forms: ["uýt", "uỳt", "uỷt", "uỹt", "uỵt", "uyt", "uýt", "uỳt", "uỷt", "uỹt", "uỵt", "uyt", "uýt", "uỳt", "uỷt", "uỹt", "uỵt", "uyt"]},
            {key: "UYU", forms: ["uýu", "uỳu", "uỷu", "uỹu", "uỵu", "uyu", "uýu", "uỳu", "uỷu", "uỹu", "uỵu", "uyu", "uýu", "uỳu", "uỷu", "uỹu", "uỵu", "uyu"]},
            {key: "YEM", forms: ["yém", "yèm", "yẻm", "yẽm", "yẹm", "yem", "yếm", "yềm", "yểm", "yễm", "yệm", "yêm", "yém", "yèm", "yẻm", "yẽm", "yẹm", "yem"]},
            {key: "OAP", forms: ["oáp", "oàp", "oảp", "oãp", "oạp", "oap", "oáp", "oàp", "oảp", "oãp", "oạp", "oap", "oáp", "oàp", "oảp", "oãp", "oạp", "oap"]}
        ];

        // Global variables
        let firebaseData = null;
        let lastUpdateTime = 0;
        let autoRefresh = true;
        let autoRefreshInterval;
        let logEntries = [];
        const MAX_LOG_ENTRIES = 20;
        
        // Sentence construction variables
        let slot1 = "";
        let slot2 = "";
        let displayBuffer = "";
        let convertedCurrentWord = "";
        let sentenceWords = [];
        let fullSentence = "";
        let convertedFullSentence = "";
        
        // Flex sensor state
        let flexStates = [0, 0, 0, 0];
        let lastFlexStates = [-1, -1, -1, -1];
        let stableCount = 0;
        let lastDetectedIndex = -1;
        let holdStartMs = 0;
        let holdFired = false;
        const DEBOUNCE_COUNT = 3;
        const HOLD_MS_DEFAULT = 800;
        const POST_HOLD_COOLDOWN = 600;
        let lastActionMs = 0;
        
        // MPU state mapping
        const mpuStateMap = {
            "Up": 0,
            "Down": 1,
            "Left": 2,
            "Right": 3,
            "Forward": 4,
            "Backward": 5
        };

        // Phrase Suggestions Database
        const phraseDatabase = {
            // Greetings
            "xin": ["xin chào", "xin lỗi", "xin vui lòng", "xin cảm ơn", "xin mời"],
            "chào": ["chào buổi sáng", "chào mừng", "chào tạm biệt", "chào hỏi"],
            "cảm": ["cảm ơn", "cảm giác", "cảm động", "cảm nhận"],
            "ơn": ["cảm ơn", "ơn trời", "ơn giời", "ơn ích"],
            
            // Questions
            "bạn": ["bạn khỏe không", "bạn tên là gì", "bạn bao nhiêu tuổi", "bạn đến từ đâu"],
            "tôi": ["tôi muốn", "tôi cần", "tôi đói", "tôi khát", "tôi mệt", "tôi hiểu"],
            "bao": ["bao nhiêu tiền", "bao lâu", "bao giờ", "bao nhiêu"],
            "nhiêu": ["bao nhiêu", "nhiêu tiền", "nhiêu đó", "nhiêu đây"],
            
            // Locations
            "đường": ["đường này", "đường nào", "đường đến", "chỉ đường", "lối đi"],
            "đến": ["đến đây", "đến đó", "đến khi", "đến nơi", "đến từ"],
            "nhà": ["nhà tôi", "nhà bạn", "nhà vệ sinh", "nhà hàng", "nhà ở"],
            
            // Time
            "ngày": ["ngày mai", "ngày hôm nay", "ngày mấy", "chúc ngày tốt"],
            "giờ": ["mấy giờ", "bây giờ", "giờ đây", "giờ học", "giờ làm"],
            
            // Emotions
            "vui": ["rất vui", "vui lòng", "vui vẻ", "vui tính", "vui mừng"],
            "buồn": ["rất buồn", "buồn bã", "buồn ngủ", "buồn chán"],
            "yêu": ["yêu bạn", "yêu thương", "tình yêu", "yêu quý"],
            
            // Basic needs
            "đói": ["tôi đói", "đói bụng", "đói quá", "đói khát"],
            "khát": ["tôi khát", "khát nước", "khát quá", "khát khao"],
            "mệt": ["tôi mệt", "mệt mỏi", "mệt quá", "mệt nhọc"],
            
            // Shopping
            "tiền": ["bao nhiêu tiền", "tiền đây", "trả tiền", "thiếu tiền"],
            "mua": ["muốn mua", "mua đồ", "mua sắm", "mua hàng"],
            "giá": ["giá bao nhiêu", "giá cả", "giá rẻ", "giá thành"],
            
            // Understanding
            "hiểu": ["tôi hiểu", "không hiểu", "hiểu biết", "hiểu lầm"],
            "biết": ["tôi biết", "không biết", "biết rồi", "biết ơn"],
            
            // Common phrases for quick access
            "common": [
                "Xin chào, rất vui được gặp bạn",
                "Bạn khỏe không?",
                "Cảm ơn bạn rất nhiều",
                "Làm ơn cho tôi hỏi đường",
                "Chúc một ngày tốt lành",
                "Tôi yêu ngôn ngữ này",
                "Hẹn gặp lại sau",
                "Tôi đói bụng",
                "Bao nhiêu tiền?",
                "Tôi không hiểu",
                "Bạn tên là gì?",
                "Tôi đến từ Việt Nam",
                "Rất vui được làm quen",
                "Xin lỗi, tôi không biết",
                "Tạm biệt, hẹn gặp lại",
                "Bạn có thể giúp tôi không?",
                "Tôi cần sự trợ giúp",
                "Đây là đâu vậy?",
                "Thời tiết hôm nay thế nào?",
                "Bạn ăn cơm chưa?"
            ]
        };

        // Speech synthesis variables
        let isSpeaking = false;
        let isConnecting = false;
        let currentAudio = null;
        let audioCache = {};
        let selectedVoice = "Aoede"; // Default to female voice
        let audioVisualizerInterval = null;

        // Helper to convert PCM16 (L16) data to a playable WAV Blob
        const pcmToWav = (base64PCM, sampleRate = 24000) => {
            const binaryString = atob(base64PCM);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);

            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(view, 0, "RIFF");
            view.setUint32(4, 36 + len, true);
            writeString(view, 8, "WAVE");
            writeString(view, 12, "fmt ");
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, "data");
            view.setUint32(40, len, true);

            return new Blob([view, bytes], { type: "audio/wav" });
        };

        // Voice map for different languages
        const voiceMap = {
            "vi-VN": "Aoede",
            "en-GB": "Kore",
            "ja-JP": "Aoede",
            "ko-KR": "Kore",
            "zh-CN": "Zubenelgenubi"
        };

        // Helper Functions
        function log(source, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, source, message };
            
            logEntries.unshift(logEntry);
            if (logEntries.length > MAX_LOG_ENTRIES) {
                logEntries.pop();
            }
            
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = logEntries.map(entry => 
                `<div class="log-entry">
                    <span style="color: #4A00E0; font-weight: 600;">[${entry.timestamp}] ${entry.source}:</span>
                    <span> ${entry.message}</span>
                </div>`
            ).join('');
        }

        function clearLog() {
            logEntries = [
                { timestamp: new Date().toLocaleTimeString(), source: "System", message: "Log cleared. System ready." }
            ];
            updateLogDisplay();
        }

        function exportLog() {
            const logText = logEntries.map(entry => `[${entry.timestamp}] ${entry.source}: ${entry.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `esp32-log-${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('SYSTEM', 'Log exported successfully');
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const connectionStatusText = document.getElementById('connectionStatusText');
            
            if (connected) {
                indicator.className = 'indicator online';
                statusText.textContent = 'Connected to Firebase';
                connectionStatusText.textContent = 'Connected';
                connectionStatusText.style.color = '#4CAF50';
                document.getElementById('firebaseStatus').innerHTML = '<i class="fas fa-wifi"></i> Connected to Firebase';
            } else {
                indicator.className = 'indicator';
                statusText.textContent = 'Disconnected from Firebase';
                connectionStatusText.textContent = 'Disconnected';
                connectionStatusText.style.color = '#F44336';
                document.getElementById('firebaseStatus').innerHTML = '<i class="fas fa-wifi-slash"></i> Disconnected from Firebase';
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // Vietnamese Conversion Functions
        function convertVietnameseWord(encodedWord) {
            if (!encodedWord || encodedWord.length === 0) return "";
            
            const firstUnderscore = encodedWord.indexOf('_');
            if (firstUnderscore === -1) return encodedWord;
            
            const secondUnderscore = encodedWord.indexOf('_', firstUnderscore + 1);
            if (secondUnderscore === -1) return encodedWord;
            
            // Extract parts
            const consonant = encodedWord.substring(0, firstUnderscore);
            const middle = encodedWord.substring(firstUnderscore + 1, secondUnderscore);
            const vowelTypeStr = encodedWord.substring(secondUnderscore + 1);
            
            if (middle.length < 2) return encodedWord;
            
            const toneChar = middle[0];
            if (toneChar < '1' || toneChar > '6') return encodedWord;
            
            const tone = parseInt(toneChar);
            const vowelKey = middle.substring(1);
            
            // Convert vowelType
            let vowelType = 0;
            if (vowelTypeStr === "b") {
                vowelType = 1;
            } else if (vowelTypeStr === "p") {
                vowelType = 2;
            } else if (vowelTypeStr !== "s") {
                return encodedWord;
            }
            
            const tableIndex = (tone - 1) + (vowelType * 6);
            
            if (tableIndex < 0 || tableIndex >= 18) {
                return encodedWord;
            }
            
            const vowelKeyUpper = vowelKey.toUpperCase();
            
            for (let i = 0; i < vietnameseTable.length; i++) {
                if (vowelKeyUpper === vietnameseTable[i].key) {
                    const convertedVowel = vietnameseTable[i].forms[tableIndex];
                    return consonant + convertedVowel;
                }
            }
            
            return encodedWord;
        }

        function convertVietnameseText(encodedText) {
            if (!encodedText || encodedText.length === 0) return "";
            
            let result = "";
            let start = 0;
            let end = 0;
            
            while (end < encodedText.length) {
                end = encodedText.indexOf(' ', start);
                if (end === -1) {
                    end = encodedText.length;
                }
                
                const word = encodedText.substring(start, end);
                const convertedWord = convertVietnameseWord(word);
                
                if (result.length > 0) {
                    result += " ";
                }
                result += convertedWord;
                
                start = end + 1;
                if (start > encodedText.length) {
                    break;
                }
            }
            
            return result;
        }

        function updateConversions() {
            // Update current word conversion
            if (displayBuffer.length > 0) {
                convertedCurrentWord = convertVietnameseWord(displayBuffer);
            } else {
                convertedCurrentWord = "";
            }
            
            // Update full sentence conversion
            if (fullSentence.length > 0) {
                convertedFullSentence = convertVietnameseText(fullSentence);
            } else {
                convertedFullSentence = "";
            }
        }

        // Phrase Suggestion Functions
        function updatePhraseSuggestions() {
            const phrasePills = document.getElementById('phrasePills');
            
            let suggestions = new Set();
            
            // Get the last word in the sentence
            const lastWord = sentenceWords[sentenceWords.length - 1];
            
            if (lastWord) {
                const convertedLastWord = convertVietnameseWord(lastWord);
                if (convertedLastWord && convertedLastWord !== lastWord) {
                    // Try to find suggestions based on the converted word
                    const words = convertedLastWord.toLowerCase().split(' ');
                    words.forEach(word => {
                        if (phraseDatabase[word]) {
                            phraseDatabase[word].forEach(phrase => suggestions.add(phrase));
                        }
                    });
                }
            }
            
            // Also get suggestions from the entire converted sentence
            if (convertedFullSentence) {
                const words = convertedFullSentence.toLowerCase().split(' ');
                words.forEach(word => {
                    // Clean the word (remove punctuation)
                    const cleanWord = word.replace(/[.,!?;:]/g, '');
                    if (phraseDatabase[cleanWord]) {
                        phraseDatabase[cleanWord].forEach(phrase => suggestions.add(phrase));
                    }
                });
            }
            
            // Add some common phrases if we don't have enough suggestions
            if (suggestions.size < 3) {
                phraseDatabase.common.slice(0, 5).forEach(phrase => suggestions.add(phrase));
            }
            
            // Convert Set to Array and limit to 6 suggestions
            const suggestionArray = Array.from(suggestions).slice(0, 6);
            
            phrasePills.innerHTML = '';
            
            if (suggestionArray.length === 0) {
                // Add default suggestions
                phraseDatabase.common.slice(0, 4).forEach((phrase, index) => {
                    const pill = document.createElement('button');
                    pill.className = index % 3 === 0 ? 'phrase-pill' : (index % 3 === 1 ? 'phrase-pill blue' : 'phrase-pill purple');
                    pill.innerHTML = `<i class="fas fa-comment-alt"></i> ${phrase}`;
                    pill.onclick = () => usePhraseSuggestion(phrase);
                    phrasePills.appendChild(pill);
                });
                return;
            }
            
            // Create pills for each suggestion
            suggestionArray.forEach((phrase, index) => {
                const pill = document.createElement('button');
                pill.className = index % 3 === 0 ? 'phrase-pill' : (index % 3 === 1 ? 'phrase-pill blue' : 'phrase-pill purple');
                pill.innerHTML = `<i class="fas fa-comment-alt"></i> ${phrase}`;
                pill.onclick = () => usePhraseSuggestion(phrase);
                phrasePills.appendChild(pill);
            });
            
            log('PHRASE', `Updated suggestions: ${suggestionArray.length} phrases`);
        }

        function usePhraseSuggestion(phrase) {
            // Set the phrase in translation input
            document.getElementById('translationInput').value = phrase;
            
            // Auto-translate
            translatePhrase(phrase);
            
            // Log the action
            log('PHRASE', `Selected phrase: "${phrase}"`);
            
            // Highlight the selected pill briefly
            event.target.style.transform = 'scale(0.95)';
            event.target.style.boxShadow = '0 1px 5px rgba(0,0,0,0.2)';
            setTimeout(() => {
                event.target.style.transform = '';
                event.target.style.boxShadow = '';
            }, 200);
        }

        function translatePhrase(phrase) {
            const textarea = document.getElementById('translationInput');
            const outputDiv = document.getElementById('translationOutput');
            
            textarea.value = phrase;
            translateSentence();
        }

        // Speech Synthesis Functions with Gemini TTS
        async function speakWithRetry(text, langCode, retries = 3) {
            const voiceName = selectedVoice;
            const apiKey = "AIzaSyBShPKBG5MkEnw3HdsDGs4S9n1N4VUzpxY"; // Replace with your actual API key
            
            for (let i = 0; i < retries; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            signal: controller.signal,
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: text }] }],
                                generationConfig: {
                                    responseModalities: ["AUDIO"],
                                    speechConfig: {
                                        voiceConfig: { prebuiltVoiceConfig: { voiceName } },
                                    },
                                },
                            }),
                        }
                    );

                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`API_ERROR_${response.status}: ${errorData?.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    const inlineData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                    
                    if (!inlineData || !inlineData.data) {
                        throw new Error("NO_DATA");
                    }

                    return inlineData.data;
                } catch (err) {
                    if (i === retries - 1) throw err;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }

        async function speakText(text, langCode) {
            if (!text || isSpeaking) return;
            
            // Stop any ongoing speech
            stopAllSpeech();
            
            // Set speaking state
            isSpeaking = true;
            isConnecting = true;
            updateUI();
            startAudioVisualizer();
            
            const cacheKey = `${langCode}:${selectedVoice}:${text}`;
            
            try {
                let audioUrl;
                
                // Check cache first
                if (audioCache[cacheKey]) {
                    audioUrl = audioCache[cacheKey];
                } else {
                    // Generate new speech
                    const audioDataBase64 = await speakWithRetry(text, langCode);
                    const wavBlob = pcmToWav(audioDataBase64, 24000);
                    audioUrl = URL.createObjectURL(wavBlob);
                    
                    // Cache the URL
                    audioCache[cacheKey] = audioUrl;
                }
                
                isConnecting = false;
                
                // Play the audio
                currentAudio = new Audio(audioUrl);
                currentAudio.onended = () => {
                    isSpeaking = false;
                    stopAudioVisualizer();
                    updateUI();
                    log('SPEECH', 'Finished speaking');
                };
                
                currentAudio.onerror = (e) => {
                    console.error("Audio playback error:", e);
                    isSpeaking = false;
                    isConnecting = false;
                    stopAudioVisualizer();
                    updateUI();
                    log('SPEECH', 'Speech error');
                };
                
                await currentAudio.play();
                log('SPEECH', `Started speaking: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);
                
            } catch (err) {
                console.error("TTS Failed:", err);
                isSpeaking = false;
                isConnecting = false;
                stopAudioVisualizer();
                updateUI();
                
                // Fallback to Web Speech API if Gemini TTS fails
                log('SPEECH', 'Falling back to Web Speech API');
                speakWithWebSpeechAPI(text, langCode);
            }
        }

        function speakWithWebSpeechAPI(text, langCode) {
            if (!('speechSynthesis' in window)) {
                log('SPEECH', 'Speech synthesis not supported in this browser');
                return;
            }
            
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langCode;
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            utterance.onstart = function() {
                isSpeaking = true;
                updateUI();
                startAudioVisualizer();
            };
            
            utterance.onend = function() {
                isSpeaking = false;
                stopAudioVisualizer();
                updateUI();
                log('SPEECH', 'Finished speaking (Web Speech API)');
            };
            
            utterance.onerror = function(event) {
                isSpeaking = false;
                stopAudioVisualizer();
                updateUI();
                log('SPEECH', `Speech error: ${event.error}`);
            };
            
            window.speechSynthesis.speak(utterance);
        }

        function speakVietnameseSentence() {
            const text = convertedFullSentence || document.getElementById('convertedSentenceDisplay').textContent;
            if (!text || text === '---') {
                log('SPEECH', 'No Vietnamese text to speak');
                return;
            }
            
            speakText(text, 'vi-VN');
        }

        function speakTranslation() {
            const text = document.getElementById('translationOutput').textContent;
            if (!text || text.includes('Waiting for translation') || text.includes('Please enter')) {
                log('SPEECH', 'No translation text to speak');
                return;
            }
            
            const lang = document.getElementById('voiceLanguage').value;
            speakText(text, lang);
        }

        function stopAllSpeech() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            
            isSpeaking = false;
            isConnecting = false;
            stopAudioVisualizer();
            updateUI();
            log('SPEECH', 'Speech stopped');
        }

        function startAudioVisualizer() {
            stopAudioVisualizer();
            
            const visualizer = document.getElementById('audioVisualizer');
            visualizer.innerHTML = '';
            
            // Create 20 audio bars
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = `${10 + Math.random() * 40}px`;
                visualizer.appendChild(bar);
            }
            
            const bars = visualizer.querySelectorAll('.audio-bar');
            audioVisualizerInterval = setInterval(() => {
                bars.forEach(bar => {
                    const height = 10 + Math.random() * 40;
                    bar.style.height = `${height}px`;
                    const hue = 180 + Math.random() * 60;
                    bar.style.background = `linear-gradient(to top, hsl(${hue}, 80%, 50%), hsl(${hue + 30}, 80%, 50%))`;
                });
            }, 100);
        }

        function stopAudioVisualizer() {
            if (audioVisualizerInterval) {
                clearInterval(audioVisualizerInterval);
                audioVisualizerInterval = null;
            }
            
            const visualizer = document.getElementById('audioVisualizer');
            visualizer.innerHTML = '';
            
            // Create static bars when not speaking
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.height = '10px';
                bar.style.background = 'linear-gradient(to top, #4CAF50, #2196F3)';
                bar.style.opacity = '0.3';
                visualizer.appendChild(bar);
            }
        }

        // Voice Selection Functions
        function setupVoiceSelection() {
            const voiceOptions = document.querySelectorAll('.voice-option');
            voiceOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    voiceOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    
                    // Update selected voice
                    selectedVoice = option.dataset.voice;
                    const gender = option.dataset.gender;
                    
                    log('SPEECH', `Selected ${gender} voice: ${selectedVoice}`);
                    
                    // Clear audio cache when voice changes
                    audioCache = {};
                });
            });
        }

        // Firebase Data Functions
        async function fetchFirebaseData() {
            try {
                const response = await fetch(FIREBASE_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                firebaseData = data;
                lastUpdateTime = Date.now();
                
                updateConnectionStatus(true);
                updateDisplay(data);
                log('Firebase', 'Data updated successfully');
                
                return data;
            } catch (error) {
                console.error('Error fetching Firebase data:', error);
                updateConnectionStatus(false);
                log('Firebase', `Error: ${error.message}`);
                return null;
            }
        }

        function calculateFlexState(rawValue, sensorIndex) {
            const STRAIGHT_THRESHOLD = 150;
            const bentThresholds = [300, 450, 350, 300];
            
            if (rawValue <= STRAIGHT_THRESHOLD) {
                return 0;
            } else if (rawValue <= bentThresholds[sensorIndex]) {
                return 1;
            } else {
                return 2;
            }
        }

        function getMPUState(orientation, shakeState) {
            let state = -1;
            
            if (shakeState === "Shake Left") {
                return 6;
            } else if (shakeState === "Shake Right") {
                return 7;
            }
            
            switch(orientation) {
                case "Up": return 0;
                case "Down": return 1;
                case "Left": return 2;
                case "Right": return 3;
                case "Forward": return 4;
                case "Backward": return 5;
                default: return -1;
            }
        }

        function getMappingForIndices(mpuState, a0, a1, a2, a3) {
            if (mpuState < 0 || mpuState > 7) return null;
            
            if (a3 === 2) {
                if (a0 < 3 && a1 < 3 && a2 < 3) {
                    return tableC[a0][a1][a2];
                }
                return null;
            }
            
            const a3bin = a3 === 1 ? 1 : 0;
            if (a1 < 0 || a1 >= 3 || a2 < 0 || a2 >= 3) return null;
            
            const flatIndex = a1 * 3 + a2;
            
            if (flatIndex >= 0 && flatIndex < 9) {
                return a3bin === 0 ? tableA[mpuState][flatIndex] : tableB[mpuState][flatIndex];
            }
            
            return null;
        }

        function flexModeCharFromA0(a0) {
            switch(a0) {
                case 0: return 's';
                case 1: return 'b';
                case 2: return 'p';
                default: return 'x';
            }
        }

        function updateDisplay(data) {
            if (!data) return;
            
            // Update sensor displays
            document.getElementById('mpuOrientation').textContent = data.o || 'Unknown';
            document.getElementById('mpuShakeState').textContent = data.d || 'None';
            
            const isShaking = document.getElementById('isShaking');
            if (data.sf === "YES") {
                isShaking.textContent = "YES";
                isShaking.style.color = "#4CAF50";
                isShaking.classList.add('shake-active');
            } else {
                isShaking.textContent = "NO";
                isShaking.style.color = "#F44336";
                isShaking.classList.remove('shake-active');
            }
            
            // Update flex sensors
            const flexValues = [data.f0 || 0, data.f1 || 0, data.f2 || 0, data.f3 || 0];
            
            // Calculate flex states using raw values f0-f3
            for (let i = 0; i < 4; i++) {
                flexStates[i] = calculateFlexState(flexValues[i], i);
            }
            
            // Update flex boxes
            for (let i = 0; i < 4; i++) {
                const box = document.getElementById(`flex${i}-box`);
                box.textContent = flexStates[i];
                box.className = `flex-box active-${flexStates[i]}`;
            }
            
            document.getElementById('rawValues').textContent = flexValues.join(', ');
            document.getElementById('flexFormat').textContent = flexStates.join('');
            
            // Update last update time
            const updateTime = document.getElementById('lastUpdate');
            updateTime.textContent = `Last Firebase update: ${formatTime(Date.now())}`;
            document.getElementById('lastUpdateTime').textContent = formatTime(Date.now());
            
            // Process word construction based on sensor data
            processWordConstruction(data);
            
            // Update UI
            updateUI();
        }

        function processWordConstruction(data) {
            const mpuState = getMPUState(data.o || "Unknown", data.d || "None");
            const a0 = flexStates[0];
            const a1 = flexStates[1];
            const a2 = flexStates[2];
            const a3 = flexStates[3];
            
            // Update stable count
            if (mpuState === lastDetectedIndex && 
                a0 === lastFlexStates[0] && 
                a1 === lastFlexStates[1] && 
                a2 === lastFlexStates[2] && 
                a3 === lastFlexStates[3]) {
                stableCount++;
            } else {
                stableCount = 1;
                lastDetectedIndex = mpuState;
                lastFlexStates = [...flexStates];
                holdStartMs = Date.now();
                holdFired = false;
            }
            
            // Check for action
            if (stableCount >= DEBOUNCE_COUNT) {
                const held = Date.now() - holdStartMs;
                if (!holdFired && (Date.now() - lastActionMs) > POST_HOLD_COOLDOWN && held >= HOLD_MS_DEFAULT) {
                    performActionSlotLogic(mpuState, a0, a1, a2, a3);
                    holdFired = true;
                    lastActionMs = Date.now();
                }
            }
        }

        function performActionSlotLogic(mpu, a0, a1, a2, a3) {
            const mapping = getMappingForIndices(mpu, a0, a1, a2, a3);
            if (!mapping || mapping === "nullptr") return false;
            
            if (mapping === "_") {
                addWordToSentence();
                return true;
            }
            
            if (mapping === "COMMIT") {
                commitSentence();
                return true;
            }
            
            if (mapping === "<") {
                backspaceBuffer();
                updateDisplayBufferFromSlots();
                return true;
            }
            
            const isSlot1 = (a3 === 2);
            const held = Date.now() - holdStartMs;
            
            if (isSlot1 && stableCount >= DEBOUNCE_COUNT && held < HOLD_MS_DEFAULT) {
                const mode = flexModeCharFromA0(a0);
                slot2 = `${mapping}_${mode}`;
            } else if (isSlot1) {
                slot1 = `${mapping}_${mpu}`;
            } else {
                const mode = flexModeCharFromA0(a0);
                slot2 = `${mapping}_${mode}`;
            }
            
            updateDisplayBufferFromSlots();
            log('WORD', `Action performed: ${displayBuffer}`);
            return true;
        }

        function updateDisplayBufferFromSlots() {
            const oldBuffer = displayBuffer;
            displayBuffer = '';
            
            if (slot1) {
                displayBuffer += slot1.toLowerCase();
            }
            
            if (slot2) {
                displayBuffer += slot2.toLowerCase();
            }
            
            if (oldBuffer !== displayBuffer) {
                updateConversions();
                log('WORD', `Word updated: ${displayBuffer}`);
            }
            
            updateUI();
        }

        function updateUI() {
            document.getElementById('slot1').textContent = slot1 || '---';
            document.getElementById('slot2').textContent = slot2 || '---';
            document.getElementById('displayBuffer').textContent = displayBuffer || '---';
            document.getElementById('convertedCurrentWord').textContent = convertedCurrentWord || '---';
            document.getElementById('sentenceDisplay').textContent = fullSentence || '---';
            document.getElementById('convertedSentenceDisplay').textContent = convertedFullSentence || '---';
            document.getElementById('wordCount').textContent = sentenceWords.length;
            
            // Update word list
            const wordListDiv = document.getElementById('wordList');
            if (sentenceWords.length > 0) {
                wordListDiv.innerHTML = sentenceWords.map((word, index) => {
                    const convertedWord = convertVietnameseWord(word);
                    return `<div class="word-item word-added">${convertedWord || word} <span style="font-size: 0.8rem; opacity: 0.7;">(${word})</span></div>`;
                }).join('');
            } else {
                wordListDiv.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;"><i class="fas fa-inbox"></i> No words yet. Start constructing!</div>';
            }
            
            // Update translation textarea
            document.getElementById('translationInput').value = convertedFullSentence || '';
            
            // Update speech buttons state
            const speakVnBtn = document.getElementById('speakVnBtn');
            const speakTransBtn = document.getElementById('speakTransBtn');
            const stopSpeechBtn = document.getElementById('stopSpeechBtn');
            
            speakVnBtn.disabled = !convertedFullSentence || isSpeaking;
            speakTransBtn.disabled = !document.getElementById('translationOutput').textContent || isSpeaking;
            stopSpeechBtn.disabled = !isSpeaking;
            
            if (isSpeaking) {
                speakVnBtn.classList.add('speaking');
                speakVnBtn.innerHTML = isConnecting ? '<i class="fas fa-spinner fa-spin"></i> Connecting...' : '<i class="fas fa-volume-up"></i> Speaking...';
            } else {
                speakVnBtn.classList.remove('speaking');
                speakVnBtn.innerHTML = '<i class="fas fa-volume-up"></i> Speak Vietnamese';
            }
        }

        // Sentence Functions
        function addWordToSentence() {
            if (!displayBuffer) return;
            
            if (sentenceWords.length < 10) {
                sentenceWords.push(displayBuffer);
                updateFullSentence();
                log('SENTENCE', `Added word: '${displayBuffer}'`);
                
                // Clear current word
                slot1 = '';
                slot2 = '';
                displayBuffer = '';
                convertedCurrentWord = '';
                
                updateUI();
                
                // Update phrase suggestions when a word is added
                updatePhraseSuggestions();
                
            } else {
                log('SENTENCE', 'Sentence full! Max 10 words reached.');
            }
        }

        function updateFullSentence() {
            fullSentence = sentenceWords.join(' ');
            convertedFullSentence = convertVietnameseText(fullSentence);
        }

        function commitSentence() {
            if (sentenceWords.length === 0) {
                log('SENTENCE', 'No words to commit!');
                return;
            }
            
            if (displayBuffer) {
                addWordToSentence();
            }
            
            log('SENTENCE', '=== COMMIT SENTENCE ===');
            log('SENTENCE', `Full sentence: ${fullSentence}`);
            log('CONVERSION', `Converted sentence: ${convertedFullSentence}`);
            
            sentenceWords.forEach((word, i) => {
                const convertedWord = convertVietnameseWord(word);
                log('SENTENCE', `Word ${i + 1}: ${word} -> ${convertedWord}`);
            });
            
            // Reset sentence
            resetSentence();
        }

        function resetSentence() {
            sentenceWords = [];
            fullSentence = '';
            convertedFullSentence = '';
            slot1 = '';
            slot2 = '';
            displayBuffer = '';
            convertedCurrentWord = '';
            
            log('SENTENCE', 'Sentence reset - ready for new input');
            updateUI();
            
            // Update phrase suggestions when sentence is reset
            updatePhraseSuggestions();
        }

        function clearCurrentWord()
