"use client"

import { useState, useEffect, useRef } from "react"

// H√†m h·ªó tr·ª£ chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu PCM16 (L16) sang file WAV cho tr√¨nh duy·ªát ph√°t l·∫°i
const pcmToWav = (base64PCM, sampleRate = 24000) => {
  if (!base64PCM) return null;
  try {
    const normalizedBase64 = base64PCM.trim().replace(/\s/g, '');
    const binaryString = atob(normalizedBase64)
    const len = binaryString.length
    const bytes = new Uint8Array(len)
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i)
    }
    const wavHeader = new ArrayBuffer(44)
    const view = new DataView(wavHeader)
    const writeString = (view, offset, string) => {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i))
      }
    }
    writeString(view, 0, "RIFF")
    view.setUint32(4, 36 + len, true)
    writeString(view, 8, "WAVE")
    writeString(view, 12, "fmt ")
    view.setUint32(16, 16, true)
    view.setUint16(20, 1, true)
    view.setUint16(22, 1, true)
    view.setUint32(24, sampleRate, true)
    view.setUint32(28, sampleRate * 2, true)
    view.setUint16(32, 2, true)
    view.setUint16(34, 16, true)
    writeString(view, 36, "data")
    view.setUint32(40, len, true)
    return new Blob([view, bytes], { type: "audio/wav" })
  } catch (e) {
    console.error("PCM to WAV conversion failed", e)
    return null
  }
}

export default function Home() {
  const [inputText, setInputText] = useState("")
  const [outputText, setOutputText] = useState("")
  const [sourceLang, setSourceLang] = useState("vi-VN")
  const [targetLang, setTargetLang] = useState("en-GB")
  const [gender, setGender] = useState("female")
  const [isLoading, setIsLoading] = useState(false)
  const [isSpeaking, setIsSpeaking] = useState(false)
  const [isConnecting, setIsConnecting] = useState(false)
  const [errorMsg, setErrorMsg] = useState("")
  const [suggestions, setSuggestions] = useState([])
  const [showSuggestions, setShowSuggestions] = useState(false)
  
  const currentAudioRef = useRef(null)
  const suggestionBoxRef = useRef(null)

  const languages = {
    "vi-VN": { name: "Ti·∫øng Vi·ªát", code: "Vietnamese" },
    "en-GB": { name: "Ti·∫øng Anh", code: "English" },
    "ja-JP": { name: "Ti·∫øng Nh·∫≠t", code: "Japanese" },
    "ko-KR": { name: "Ti·∫øng H√†n", code: "Korean" },
    "zh-CN": { name: "Ti·∫øng Trung", code: "Chinese (Simplified)" },
  }

  const phraseLibrary = {
    "vi-VN": [
      "Xin ch√†o, r·∫•t vui ƒë∆∞·ª£c g·∫∑p b·∫°n.",
      "Ch√†o bu·ªïi s√°ng.",
      "B·∫°n t√™n l√† g√¨?",
      "T√¥i c√≥ th·ªÉ gi√∫p g√¨ kh√¥ng?",
      "Vui l√≤ng ki·ªÉm tra l·∫°i b√°o c√°o.",
      "H·∫°n ch√≥t l√† th·ª© S√°u.",
      "T√¥i ho√†n to√†n ƒë·ªìng √Ω.",
      "L√†m ∆°n cho t√¥i xem th·ª±c ƒë∆°n.",
      "L√†m ∆°n cho t√¥i xin h√≥a ƒë∆°n.",
      "M√≥n n√†y c√≥ cay kh√¥ng?",
      "ƒê∆∞·ªùng ƒë·∫øn b·∫£o t√†ng ƒëi th·∫ø n√†o?",
      "Ga t√†u c√°ch ƒë√¢y bao xa?",
      "C√°i n√†y gi√° bao nhi√™u?",
      "T√¥i c·∫ßn g·∫∑p b√°c sƒ©.",
      "L√†m ∆°n g·ªçi xe c·∫•p c·ª©u.",
      "B·∫°n c√≥ th·ªÉ h∆∞·ªõng d·∫´n t√¥i kh√¥ng?",
    ],
    "en-GB": [
      "Hello, nice to meet you.",
      "Good morning.",
      "What is your name?",
      "May I help you?",
      "Please double-check the report.",
      "The deadline is Friday.",
      "I completely agree.",
      "Please let me see the menu.",
      "Could I have the bill, please?",
      "Is this dish spicy?",
      "How do I get to the museum?",
      "How far is the train station?",
      "How much does this cost?",
      "I need to see a doctor.",
      "Please call an ambulance.",
      "Could you guide me?",
    ],
  }

  const voiceConfigs = {
    female: { "vi-VN": "Aoede", "en-GB": "Kore", "ja-JP": "Leda", "ko-KR": "Kore", "zh-CN": "Aoede" },
    male: { "vi-VN": "Charon", "en-GB": "Puck", "ja-JP": "Fenrir", "ko-KR": "Puck", "zh-CN": "Zubenelgenubi" }
  }

  const handleInputChange = (e) => {
    const value = e.target.value
    setInputText(value)

    if (value.trim().length > 0) {
      const currentLibrary = phraseLibrary[sourceLang] || []
      const filtered = currentLibrary.filter((p) => p.toLowerCase().includes(value.toLowerCase()) && p !== value)
      setSuggestions(filtered.slice(0, 5))
      setShowSuggestions(true)
    } else {
      setOutputText("")
      setShowSuggestions(false)
    }
  }

  // Click outside ƒë·ªÉ ƒë√≥ng g·ª£i √Ω
  useEffect(() => {
    const close = (e) => {
      if (suggestionBoxRef.current && !suggestionBoxRef.current.contains(e.target)) {
        setShowSuggestions(false)
      }
    }
    document.addEventListener("mousedown", close)
    return () => document.removeEventListener("mousedown", close)
  }, [])

  // H√†m d·ªãch thu·∫≠t s·ª≠ d·ª•ng Gemini
  const translateWithAI = async (text, sLang, tLang) => {
    const apiKey = "";
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
    
    try {
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: `Translate from ${languages[sLang].name} to ${languages[tLang].name}. 
              Maintain natural and formal tone. Output ONLY the translated text, no quotes, no extra notes.
              Text: "${text}"`
            }]
          }]
        })
      });

      if (!response.ok) throw new Error("Translation failed");
      const data = await response.json();
      let translated = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "";
      return translated.replace(/^["']|["']$/g, ''); 
    } catch (err) {
      console.error("AI Translation Error:", err);
      throw err;
    }
  };

  useEffect(() => {
    const timer = setTimeout(async () => {
      if (inputText.trim()) {
        setIsLoading(true);
        setErrorMsg("");
        try {
          const result = await translateWithAI(inputText, sourceLang, targetLang);
          setOutputText(result);
        } catch (err) {
          setErrorMsg("D·ªãch thu·∫≠t AI t·∫°m th·ªùi gi√°n ƒëo·∫°n.");
        } finally {
          setIsLoading(false);
        }
      } else {
        setOutputText("");
      }
    }, 1000);
    return () => clearTimeout(timer);
  }, [inputText, sourceLang, targetLang]);

  // H√†m ph√°t √¢m thanh s·ª≠ d·ª•ng Gemini TTS
  const speakWithRetry = async (text, langCode) => {
    const voiceName = voiceConfigs[gender][langCode] || "Kore"
    const apiKey = "" 
    const maxRetries = 5;
    const delays = [1000, 2000, 4000, 8000, 16000];

    const cleanText = text.replace(/[*_#]/g, '').trim();

    for (let i = 0; i < maxRetries; i++) {
      try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
        
        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ 
                role: "user",
                parts: [{ text: `Say this naturally in a clear voice: ${cleanText}` }] 
              }],
              generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                  voiceConfig: { 
                    prebuiltVoiceConfig: { 
                      voiceName: voiceName 
                    } 
                  }
                }
              }
            }),
          }
        )
        
        if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            throw new Error(errData.error?.message || `HTTP ${response.status}`);
        }
        
        const data = await response.json();
        const candidate = data.candidates?.[0];
        if (!candidate) throw new Error("No candidates found in response");
        
        const part = candidate.content?.parts?.find(p => p.inlineData && p.inlineData.data);
        const audioData = part?.inlineData?.data;
        
        if (audioData) return audioData;
        throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu √¢m thanh t·ª´ AI.");
      } catch (err) {
        if (i === maxRetries - 1) throw err;
        await new Promise(r => setTimeout(r, delays[i]));
      }
    }
  }

  const speakText = async (text, langCode) => {
    if (!text || isSpeaking) return
    if (currentAudioRef.current) {
      currentAudioRef.current.pause();
      currentAudioRef.current = null;
    }

    setIsSpeaking(true)
    setIsConnecting(true)
    setErrorMsg("");

    try {
      const audioDataBase64 = await speakWithRetry(text, langCode)
      const wavBlob = pcmToWav(audioDataBase64)
      if (!wavBlob) throw new Error("Audio generation failed");

      const audioUrl = URL.createObjectURL(wavBlob)
      const audio = new Audio(audioUrl)
      currentAudioRef.current = audio
      
      audio.onplay = () => setIsConnecting(false);
      audio.onended = () => {
        setIsSpeaking(false);
        URL.revokeObjectURL(audioUrl);
      };
      audio.onerror = () => {
        setIsSpeaking(false);
        setIsConnecting(false);
        setErrorMsg("L·ªói ph√°t √¢m thanh.");
      };
      
      await audio.play();
    } catch (err) {
      console.error("TTS Error:", err);
      setIsConnecting(false);
      setIsSpeaking(false);
      setErrorMsg(`L·ªói gi·ªçng n√≥i: ${err.message}`);
    }
  }

  return (
    <div className="p-6 max-w-5xl mx-auto font-sans bg-slate-50 min-h-screen">
      <header className="mb-10 text-center">
        <h1 className="text-4xl font-extrabold text-indigo-700 mb-2">AI Multi-Translator Pro</h1>
        <p className="text-slate-500">D·ªãch thu·∫≠t & Ph√°t √¢m chu·∫©n x√°c b·∫±ng Gemini 2.5 Flash</p>
      </header>

      <div className="bg-white p-6 rounded-3xl shadow-xl mb-8 border border-slate-100">
        <div className="flex flex-wrap items-center justify-between gap-4">
          <div className="flex items-center gap-3">
            <select
              value={sourceLang}
              className="px-4 py-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-semibold focus:border-indigo-400 outline-none transition-all cursor-pointer"
              onChange={(e) => { setSourceLang(e.target.value); setInputText(""); setOutputText(""); }}
            >
              {Object.entries(languages).map(([c, obj]) => (
                <option key={c} value={c}>{obj.name}</option>
              ))}
            </select>
            <button
              title="ƒê·ªïi chi·ªÅu"
              className="w-10 h-10 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-transform active:scale-90"
              onClick={() => {
                const s = sourceLang; setSourceLang(targetLang); setTargetLang(s);
                const i = inputText; setInputText(outputText); setOutputText(i);
              }}
            >
              ‚áÑ
            </button>
            <select
              value={targetLang}
              className="px-4 py-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-semibold focus:border-indigo-400 outline-none transition-all cursor-pointer"
              onChange={(e) => { setTargetLang(e.target.value); setOutputText(""); }}
            >
              {Object.entries(languages).map(([c, obj]) => (
                <option key={c} value={c}>{obj.name}</option>
              ))}
            </select>
          </div>

          <div className="flex bg-slate-100 p-1 rounded-xl">
            <button onClick={() => setGender("female")} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${gender === "female" ? "bg-white text-indigo-600 shadow-md" : "text-slate-500"}`}>üë© N·ªØ</button>
            <button onClick={() => setGender("male")} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${gender === "male" ? "bg-white text-indigo-600 shadow-md" : "text-slate-500"}`}>üë® Nam</button>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-8 relative">
        <div className="relative group flex flex-col" ref={suggestionBoxRef}>
          <div className="absolute -top-3 left-6 px-2 bg-white text-xs font-bold text-slate-400 z-10 uppercase tracking-widest">VƒÉn b·∫£n g·ªëc</div>
          <textarea
            className="w-full h-80 p-6 text-xl border-2 border-slate-100 rounded-3xl focus:border-indigo-500 outline-none shadow-inner bg-white transition-all resize-none"
            value={inputText}
            onChange={handleInputChange}
            onFocus={() => inputText.trim() && setSuggestions((phraseLibrary[sourceLang] || []).filter(p => p.toLowerCase().includes(inputText.toLowerCase()) && p !== inputText).slice(0,5))}
            placeholder="Nh·∫≠p n·ªôi dung c·∫ßn d·ªãch..."
          />
          
          {/* Suggestions Dropdown */}
          {showSuggestions && suggestions.length > 0 && (
            <div className="absolute top-full left-0 right-0 mt-2 bg-white border border-slate-200 rounded-2xl shadow-2xl z-50 overflow-hidden animate-in fade-in slide-in-from-top-2">
              {suggestions.map((s, i) => (
                <button
                  key={i}
                  className="w-full text-left px-6 py-3 hover:bg-indigo-50 text-slate-700 transition-colors border-b border-slate-50 last:border-0"
                  onClick={() => {
                    setInputText(s);
                    setShowSuggestions(false);
                  }}
                >
                  {s}
                </button>
              ))}
            </div>
          )}

          <button
            onClick={() => speakText(inputText, sourceLang)}
            className={`mt-4 w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 ${isSpeaking ? 'bg-indigo-600 text-white shadow-indigo-200' : 'bg-white border-2 border-slate-100 text-slate-600 hover:border-indigo-200 shadow-sm'}`}
            disabled={!inputText || isConnecting}
          >
            üîä Nghe b·∫£n g·ªëc
          </button>
        </div>

        <div className="relative flex flex-col">
          <div className="absolute -top-3 left-6 px-2 bg-white text-xs font-bold text-slate-400 z-10 uppercase tracking-widest">B·∫£n d·ªãch AI</div>
          <div className="w-full h-80 p-6 text-xl border-2 border-slate-100 rounded-3xl bg-slate-50/50 overflow-y-auto shadow-inner relative">
            {isLoading ? (
              <div className="flex flex-col items-center justify-center h-full gap-4">
                <div className="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                <span className="text-indigo-600 font-medium animate-pulse">ƒêang d·ªãch thu·∫≠t...</span>
              </div>
            ) : (
              <div className="text-slate-800 leading-relaxed font-medium whitespace-pre-wrap">
                {outputText || <span className="text-slate-300 italic">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</span>}
              </div>
            )}
          </div>
          <button
            onClick={() => speakText(outputText, targetLang)}
            className={`mt-4 w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 ${isSpeaking ? 'bg-indigo-600 text-white' : 'bg-white border-2 border-slate-100 text-slate-600 hover:border-indigo-200 shadow-sm'}`}
            disabled={!outputText || isConnecting}
          >
            {isConnecting ? "ƒêang chu·∫©n b·ªã gi·ªçng ƒë·ªçc..." : "üîä Nghe b·∫£n d·ªãch"}
          </button>
        </div>
      </div>

      {errorMsg && (
        <div className="mt-10 p-4 bg-red-50 border border-red-200 rounded-2xl text-red-700 flex items-center justify-center gap-3 shadow-sm">
          <span>‚ö†Ô∏è</span> {errorMsg}
        </div>
      )}
    </div>
  )
}
