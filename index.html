<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Multi-Translator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">AI Multi-Translator Pro</h1>
            <p class="text-slate-500">D·ªãch thu·∫≠t & Ph√°t √¢m chu·∫©n x√°c b·∫±ng Gemini AI</p>
        </header>

        <!-- API Key Warning (Ch·ªâ hi·ªÉn th·ªã khi thi·∫øu Key) -->
        <div id="apiKeyWarning" class="hidden mb-6 p-4 bg-amber-50 border-l-4 border-amber-400 text-amber-800 rounded-r-xl shadow-sm">
            <p class="font-bold">‚ö†Ô∏è Thi·∫øu API Key!</p>
            <p class="text-sm">B·∫°n c·∫ßn d√°n API Key t·ª´ Google AI Studio v√†o bi·∫øn <code class="bg-amber-100 px-1 rounded">apiKey</code> trong m√£ ngu·ªìn ƒë·ªÉ ·ª©ng d·ª•ng ho·∫°t ƒë·ªông tr√™n Netlify.</p>
        </div>

        <!-- Control Bar -->
        <div class="bg-white p-6 rounded-3xl shadow-xl mb-8 border border-slate-100">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <select id="sourceLang" class="px-4 py-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-semibold focus:border-indigo-400 outline-none transition-all cursor-pointer">
                        <!-- Options populated via JS -->
                    </select>
                    
                    <button id="swapBtn" title="ƒê·ªïi chi·ªÅu" class="w-10 h-10 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-transform active:scale-90">
                        ‚áÑ
                    </button>

                    <select id="targetLang" class="px-4 py-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-semibold focus:border-indigo-400 outline-none transition-all cursor-pointer">
                        <!-- Options populated via JS -->
                    </select>
                </div>

                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button id="genderFemale" class="px-4 py-2 rounded-lg text-sm font-bold transition-all bg-white text-indigo-600 shadow-md">üë© N·ªØ</button>
                    <button id="genderMale" class="px-4 py-2 rounded-lg text-sm font-bold transition-all text-slate-500">üë® Nam</button>
                </div>
            </div>
        </div>

        <!-- Main Areas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative">
            
            <!-- Input Section -->
            <div class="relative flex flex-col" id="inputContainer">
                <div class="absolute -top-3 left-6 px-2 bg-white text-xs font-bold text-slate-400 z-10 uppercase tracking-widest">VƒÉn b·∫£n g·ªëc</div>
                <textarea id="inputText" class="w-full h-80 p-6 text-xl border-2 border-slate-100 rounded-3xl focus:border-indigo-500 outline-none shadow-inner bg-white transition-all resize-none" placeholder="Nh·∫≠p n·ªôi dung c·∫ßn d·ªãch..."></textarea>
                
                <!-- Suggestions Dropdown -->
                <div id="suggestionBox" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border border-slate-200 rounded-2xl shadow-2xl z-50 overflow-hidden animate-fade-in">
                    <!-- Suggestions items via JS -->
                </div>

                <button id="speakSource" class="mt-4 w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 bg-white border-2 border-slate-100 text-slate-600 hover:border-indigo-200 shadow-sm disabled:opacity-50">
                    <span id="sourceIcon">üîä</span> <span id="sourceBtnText">Nghe b·∫£n g·ªëc</span>
                </button>
            </div>

            <!-- Output Section -->
            <div class="relative flex flex-col">
                <div class="absolute -top-3 left-6 px-2 bg-white text-xs font-bold text-slate-400 z-10 uppercase tracking-widest">B·∫£n d·ªãch AI</div>
                <div class="w-full h-80 p-6 text-xl border-2 border-slate-100 rounded-3xl bg-slate-50/50 overflow-y-auto shadow-inner relative custom-scrollbar">
                    <div id="loader" class="hidden flex flex-col items-center justify-center h-full gap-4">
                        <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-indigo-600 font-medium animate-pulse">ƒêang d·ªãch thu·∫≠t...</span>
                    </div>
                    <div id="outputText" class="text-slate-800 leading-relaxed font-medium whitespace-pre-wrap">
                        <span class="text-slate-300 italic">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</span>
                    </div>
                </div>
                <button id="speakTarget" class="mt-4 w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 bg-white border-2 border-slate-100 text-slate-600 hover:border-indigo-200 shadow-sm disabled:opacity-50">
                    <span id="targetIcon">üîä</span> <span id="targetBtnText">Nghe b·∫£n d·ªãch</span>
                </button>
            </div>
        </div>

        <!-- Error Toast -->
        <div id="errorMsg" class="hidden mt-10 p-4 bg-red-50 border border-red-200 rounded-2xl text-red-700 flex items-center justify-center gap-3 shadow-sm animate-fade-in">
            <span>‚ö†Ô∏è</span> <span id="errorText">L·ªói k·∫øt n·ªëi</span>
        </div>
    </div>

    <script>
        /**
         * QUAN TR·ªåNG: ƒê·ªÉ ch·∫°y tr√™n Netlify, b·∫°n ph·∫£i ƒëi·ªÅn API Key c·ªßa m√¨nh v√†o ƒë√¢y.
         * L·∫•y Key mi·ªÖn ph√≠ t·∫°i: https://aistudio.google.com/app/apikey
         */
        const apiKey = ""; 

        const languages = {
            "vi-VN": { name: "Ti·∫øng Vi·ªát", code: "Vietnamese" },
            "en-GB": { name: "Ti·∫øng Anh", code: "English" },
            "ja-JP": { name: "Ti·∫øng Nh·∫≠t", code: "Japanese" },
            "ko-KR": { name: "Ti·∫øng H√†n", code: "Korean" },
            "zh-CN": { name: "Ti·∫øng Trung", code: "Chinese (Simplified)" },
        };

        const phraseLibrary = {
            "vi-VN": ["Xin ch√†o, r·∫•t vui ƒë∆∞·ª£c g·∫∑p b·∫°n.", "Ch√†o bu·ªïi s√°ng.", "B·∫°n t√™n l√† g√¨?", "T√¥i c√≥ th·ªÉ gi√∫p g√¨ kh√¥ng?", "Vui l√≤ng ki·ªÉm tra l·∫°i b√°o c√°o.", "H·∫°n ch√≥t l√† th·ª© S√°u.", "T√¥i ho√†n to√†n ƒë·ªìng √Ω.", "L√†m ∆°n cho t√¥i xem th·ª±c ƒë∆°n.", "L√†m ∆°n cho t√¥i xin h√≥a ƒë∆°n.", "M√≥n n√†y c√≥ cay kh√¥ng?", "ƒê∆∞·ªùng ƒë·∫øn b·∫£o t√†ng ƒëi th·∫ø n√†o?", "Ga t√†u c√°ch ƒë√¢y bao xa?", "C√°i n√†y gi√° bao nhi√™u?", "T√¥i c·∫ßn g·∫∑p b√°c sƒ©.", "L√†m ∆°n g·ªçi xe c·∫•p c·ª©u."],
            "en-GB": ["Hello, nice to meet you.", "Good morning.", "What is your name?", "May I help you?", "Please double-check the report.", "The deadline is Friday.", "I completely agree.", "Please let me see the menu.", "Could I have the bill, please?", "Is this dish spicy?", "How do I get to the museum?", "How far is the train station?", "How much does this cost?", "I need to see a doctor.", "Please call an ambulance."]
        };

        const voiceConfigs = {
            female: { "vi-VN": "Aoede", "en-GB": "Kore", "ja-JP": "Leda", "ko-KR": "Kore", "zh-CN": "Aoede" },
            male: { "vi-VN": "Charon", "en-GB": "Puck", "ja-JP": "Fenrir", "ko-KR": "Puck", "zh-CN": "Zubenelgenubi" }
        };

        // --- Tr·∫°ng th√°i ---
        let currentGender = 'female';
        let isSpeaking = false;
        let translationTimeout;
        let currentAudio = null;

        // --- Elements ---
        const els = {
            sourceLang: document.getElementById('sourceLang'),
            targetLang: document.getElementById('targetLang'),
            swapBtn: document.getElementById('swapBtn'),
            genderFemale: document.getElementById('genderFemale'),
            genderMale: document.getElementById('genderMale'),
            inputText: document.getElementById('inputText'),
            outputText: document.getElementById('outputText'),
            loader: document.getElementById('loader'),
            suggestionBox: document.getElementById('suggestionBox'),
            speakSource: document.getElementById('speakSource'),
            speakTarget: document.getElementById('speakTarget'),
            errorMsg: document.getElementById('errorMsg'),
            errorText: document.getElementById('errorText'),
            apiKeyWarning: document.getElementById('apiKeyWarning')
        };

        // --- Kh·ªüi t·∫°o ---
        function init() {
            // Ki·ªÉm tra API Key
            if (!apiKey) {
                els.apiKeyWarning.classList.remove('hidden');
            }

            Object.entries(languages).forEach(([code, obj]) => {
                const opt1 = new Option(obj.name, code);
                const opt2 = new Option(obj.name, code);
                els.sourceLang.add(opt1);
                els.targetLang.add(opt2);
            });
            els.sourceLang.value = "vi-VN";
            els.targetLang.value = "en-GB";
            setupEventListeners();
        }

        // --- X·ª≠ l√Ω s·ª± ki·ªán ---
        function setupEventListeners() {
            els.inputText.addEventListener('input', () => {
                handleInput();
                clearTimeout(translationTimeout);
                translationTimeout = setTimeout(translate, 1000);
            });

            els.swapBtn.addEventListener('click', swapLanguages);
            
            els.genderFemale.addEventListener('click', () => setGender('female'));
            els.genderMale.addEventListener('click', () => setGender('male'));

            els.speakSource.addEventListener('click', () => speak(els.inputText.value, els.sourceLang.value, 'source'));
            els.speakTarget.addEventListener('click', () => speak(els.outputText.innerText, els.targetLang.value, 'target'));

            document.addEventListener('mousedown', (e) => {
                if (!els.suggestionBox.contains(e.target) && e.target !== els.inputText) {
                    els.suggestionBox.classList.add('hidden');
                }
            });
        }

        function setGender(g) {
            currentGender = g;
            els.genderFemale.className = g === 'female' ? "px-4 py-2 rounded-lg text-sm font-bold transition-all bg-white text-indigo-600 shadow-md" : "px-4 py-2 rounded-lg text-sm font-bold transition-all text-slate-500";
            els.genderMale.className = g === 'male' ? "px-4 py-2 rounded-lg text-sm font-bold transition-all bg-white text-indigo-600 shadow-md" : "px-4 py-2 rounded-lg text-sm font-bold transition-all text-slate-500";
        }

        function swapLanguages() {
            const s = els.sourceLang.value;
            const t = els.targetLang.value;
            els.sourceLang.value = t;
            els.targetLang.value = s;
            
            const i = els.inputText.value;
            const o = els.outputText.innerText;
            els.inputText.value = (o === "K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...") ? "" : o;
            translate();
        }

        function handleInput() {
            const val = els.inputText.value.trim().toLowerCase();
            const library = phraseLibrary[els.sourceLang.value] || [];
            
            if (val.length > 0) {
                const matches = library.filter(p => p.toLowerCase().includes(val) && p.toLowerCase() !== val).slice(0, 5);
                if (matches.length > 0) {
                    els.suggestionBox.innerHTML = matches.map(m => `
                        <button class="w-full text-left px-6 py-3 hover:bg-indigo-50 text-slate-700 transition-colors border-b border-slate-50 last:border-0" onclick="applySuggestion('${m.replace(/'/g, "\\'")}')">
                            ${m}
                        </button>
                    `).join('');
                    els.suggestionBox.classList.remove('hidden');
                } else {
                    els.suggestionBox.classList.add('hidden');
                }
            } else {
                els.suggestionBox.classList.add('hidden');
                els.outputText.innerHTML = '<span class="text-slate-300 italic">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</span>';
            }
        }

        window.applySuggestion = (text) => {
            els.inputText.value = text;
            els.suggestionBox.classList.add('hidden');
            translate();
        };

        // --- API Logic ---
        async function translate() {
            if (!apiKey) {
                showError("Vui l√≤ng c·∫•u h√¨nh API Key ƒë·ªÉ s·ª≠ d·ª•ng.");
                return;
            }

            const text = els.inputText.value.trim();
            if (!text) return;

            els.loader.classList.remove('hidden');
            els.outputText.classList.add('hidden');
            els.errorMsg.classList.add('hidden');

            try {
                const sLang = languages[els.sourceLang.value].name;
                const tLang = languages[els.targetLang.value].name;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Translate from ${sLang} to ${tLang}. Maintain natural tone. Output ONLY the translated text. Text: "${text}"`
                            }]
                        }]
                    })
                });

                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                let result = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "L·ªói d·ªãch thu·∫≠t";
                els.outputText.innerText = result.replace(/^["']|["']$/g, '');
            } catch (err) {
                showError("L·ªói k·∫øt n·ªëi API. H√£y ki·ªÉm tra API Key c·ªßa b·∫°n.");
            } finally {
                els.loader.classList.add('hidden');
                els.outputText.classList.remove('hidden');
            }
        }

        async function speak(text, langCode, type) {
            if (!apiKey) {
                showError("Vui l√≤ng c·∫•u h√¨nh API Key ƒë·ªÉ s·ª≠ d·ª•ng.");
                return;
            }
            if (!text || isSpeaking) return;
            if (currentAudio) currentAudio.pause();

            setSpeakingUI(type, true);
            isSpeaking = true;

            try {
                const voiceName = voiceConfigs[currentGender][langCode] || "Kore";
                const cleanText = text.replace(/[*_#]/g, '').trim();

                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say this naturally: ${cleanText}` }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName } } }
                        }
                    })
                });

                if (!response.ok) throw new Error("TTS API Error");

                const data = await response.json();
                const base64Audio = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                
                if (!base64Audio) throw new Error("Audio failed");

                const blob = pcmToWav(base64Audio);
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                currentAudio = audio;

                audio.onended = () => {
                    setSpeakingUI(type, false);
                    isSpeaking = false;
                    URL.revokeObjectURL(url);
                };
                
                await audio.play();
            } catch (err) {
                showError("L·ªói √¢m thanh AI. Ki·ªÉm tra API Key ho·∫∑c k·∫øt n·ªëi m·∫°ng.");
                setSpeakingUI(type, false);
                isSpeaking = false;
            }
        }

        // --- Helpers ---
        function setSpeakingUI(type, active) {
            const btn = type === 'source' ? els.speakSource : els.speakTarget;
            const icon = type === 'source' ? document.getElementById('sourceIcon') : document.getElementById('targetIcon');
            const text = type === 'source' ? document.getElementById('sourceBtnText') : document.getElementById('targetBtnText');
            
            if (active) {
                btn.classList.add('bg-indigo-600', 'text-white');
                btn.classList.remove('bg-white', 'text-slate-600');
                icon.innerText = "‚è≥";
                text.innerText = "ƒêang ph√°t...";
            } else {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-white', 'text-slate-600');
                icon.innerText = "üîä";
                text.innerText = type === 'source' ? "Nghe b·∫£n g·ªëc" : "Nghe b·∫£n d·ªãch";
            }
        }

        function showError(msg) {
            els.errorText.innerText = msg;
            els.errorMsg.classList.remove('hidden');
            setTimeout(() => els.errorMsg.classList.add('hidden'), 5000);
        }

        async function fetchWithRetry(url, opts) {
            let delays = [1000, 2000, 4000];
            for (let i = 0; i < delays.length; i++) {
                try {
                    let res = await fetch(url, opts);
                    if (res.ok) return res;
                } catch (e) {}
                await new Promise(r => setTimeout(r, delays[i]));
            }
            return fetch(url, opts);
        }

        function pcmToWav(base64, sampleRate = 24000) {
            const binary = atob(base64.trim().replace(/\s/g, ''));
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
            
            const buffer = new ArrayBuffer(44 + len);
            const view = new DataView(buffer);
            const writeStr = (off, s) => { for(let i=0; i<s.length; i++) view.setUint8(off+i, s.charCodeAt(i)); };
            
            writeStr(0, "RIFF");
            view.setUint32(4, 36 + len, true);
            writeStr(8, "WAVE");
            writeStr(12, "fmt ");
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeStr(36, "data");
            view.setUint32(40, len, true);
            
            new Uint8Array(buffer, 44).set(bytes);
            return new Blob([buffer], { type: "audio/wav" });
        }

        init();
    </script>
</body>
</html>
