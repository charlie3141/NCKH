<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Multi-Translator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">AI Multi-Translator Pro</h1>
            <p class="text-slate-500">D·ªãch thu·∫≠t & Ph√°t √¢m chu·∫©n b·∫£n ng·ªØ b·∫±ng Gemini AI</p>
        </header>

        <!-- API Key Setup Section -->
        <div id="apiSetup" class="mb-8 bg-white p-6 rounded-3xl shadow-xl border border-slate-100 animate-fade-in">
            <div class="flex flex-col md:flex-row items-center gap-4">
                <div class="flex-1 w-full">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">C·∫•u h√¨nh Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-indigo-400 outline-none transition-all" placeholder="D√°n API Key c·ªßa b·∫°n v√†o ƒë√¢y...">
                </div>
                <button id="saveKeyBtn" class="w-full md:w-auto mt-6 md:mt-0 px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-all active:scale-95">L∆∞u Key</button>
            </div>
            <p class="mt-3 text-xs text-slate-400 italic">Key ƒë∆∞·ª£c l∆∞u t·∫°i tr√¨nh duy·ªát. L·∫•y Key t·∫°i <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-500 underline">Google AI Studio</a>.</p>
        </div>

        <!-- Control Bar -->
        <div class="bg-white p-6 rounded-3xl shadow-xl mb-8 border border-slate-100">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <select id="sourceLang" class="px-4 py-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-semibold focus:border-indigo-400 outline-none transition-all cursor-pointer">
                    </select>
                    
                    <button id="swapBtn" title="ƒê·ªïi chi·ªÅu" class="w-10 h-10 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-transform active:scale-90">
                        ‚áÑ
                    </button>

                    <select id="targetLang" class="px-4 py-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-semibold focus:border-indigo-400 outline-none transition-all cursor-pointer">
                    </select>
                </div>

                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button id="genderFemale" class="px-4 py-2 rounded-lg text-sm font-bold transition-all bg-white text-indigo-600 shadow-md">üë© N·ªØ</button>
                    <button id="genderMale" class="px-4 py-2 rounded-lg text-sm font-bold transition-all text-slate-500">üë® Nam</button>
                </div>
            </div>
        </div>

        <!-- Main Areas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative">
            
            <!-- Input Section -->
            <div class="relative flex flex-col" id="inputContainer">
                <div class="absolute -top-3 left-6 px-2 bg-white text-xs font-bold text-slate-400 z-10 uppercase tracking-widest">VƒÉn b·∫£n g·ªëc</div>
                <textarea id="inputText" class="w-full h-80 p-6 text-xl border-2 border-slate-100 rounded-3xl focus:border-indigo-500 outline-none shadow-inner bg-white transition-all resize-none" placeholder="Nh·∫≠p n·ªôi dung c·∫ßn d·ªãch..."></textarea>
                
                <button id="speakSource" class="mt-4 w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 bg-white border-2 border-slate-100 text-slate-600 hover:border-indigo-200 shadow-sm disabled:opacity-50">
                    <span id="sourceIcon">üîä</span> <span id="sourceBtnText">Nghe b·∫£n g·ªëc</span>
                </button>
            </div>

            <!-- Output Section -->
            <div class="relative flex flex-col">
                <div class="absolute -top-3 left-6 px-2 bg-white text-xs font-bold text-slate-400 z-10 uppercase tracking-widest">B·∫£n d·ªãch AI</div>
                <div class="w-full h-80 p-6 text-xl border-2 border-slate-100 rounded-3xl bg-slate-50/50 overflow-y-auto shadow-inner relative custom-scrollbar">
                    <div id="loader" class="hidden flex flex-col items-center justify-center h-full gap-4">
                        <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-indigo-600 font-medium animate-pulse text-sm">AI ƒëang x·ª≠ l√Ω nhanh...</span>
                    </div>
                    <div id="outputText" class="text-slate-800 leading-relaxed font-medium whitespace-pre-wrap">
                        <span class="text-slate-300 italic">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</span>
                    </div>
                </div>
                <button id="speakTarget" class="mt-4 w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 bg-white border-2 border-slate-100 text-slate-600 hover:border-indigo-200 shadow-sm disabled:opacity-50">
                    <span id="targetIcon">üîä</span> <span id="targetBtnText">Nghe b·∫£n d·ªãch</span>
                </button>
            </div>
        </div>

        <!-- Error Toast -->
        <div id="errorMsg" class="hidden mt-10 p-4 rounded-2xl flex items-center justify-center gap-3 shadow-sm animate-fade-in">
            <span id="errorEmoji">‚ö†Ô∏è</span> <span id="errorText">L·ªói k·∫øt n·ªëi</span>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('GEMINI_API_KEY') || "";

        const languages = {
            "vi-VN": { name: "Ti·∫øng Vi·ªát", code: "Vietnamese" },
            "en-GB": { name: "Ti·∫øng Anh", code: "English" },
            "ja-JP": { name: "Ti·∫øng Nh·∫≠t", code: "Japanese" },
            "ko-KR": { name: "Ti·∫øng H√†n", code: "Korean" },
            "zh-CN": { name: "Ti·∫øng Trung", code: "Chinese (Simplified)" },
        };

        const voiceConfigs = {
            female: { 
                "vi-VN": "Aoede", 
                "en-GB": "Kore", 
                "ja-JP": "Leda", 
                "ko-KR": "Chione", 
                "zh-CN": "Algieba" 
            },
            male: { 
                "vi-VN": "Charon", 
                "en-GB": "Puck", 
                "ja-JP": "Fenrir", 
                "ko-KR": "Iapetus", 
                "zh-CN": "Zubenelgenubi" 
            }
        };

        let currentGender = 'female';
        let isSpeaking = false;
        let translationTimeout;
        let currentAudio = null;
        let abortController = null;
        let currentAudioURL = null; // Theo d√µi URL ƒë·ªÉ gi·∫£i ph√≥ng b·ªô nh·ªõ

        async function fetchWithRetry(url, options, maxRetries = 3) {
            let retries = 0;
            const delays = [800, 1500, 3000];

            while (retries < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    const data = await response.json();
                    
                    if (!response.ok || data.error) {
                        throw new Error(data.error?.message || `L·ªói HTTP: ${response.status}`);
                    }
                    
                    return data;
                } catch (err) {
                    if (err.name === 'AbortError') throw err;
                    
                    retries++;
                    if (retries >= maxRetries) throw err;
                    await new Promise(res => setTimeout(res, delays[retries - 1]));
                }
            }
        }

        function init() {
            if (apiKey) {
                els.apiKeyInput.value = apiKey;
                els.apiSetup.classList.add('opacity-50');
            }

            Object.entries(languages).forEach(([code, obj]) => {
                els.sourceLang.add(new Option(obj.name, code));
                els.targetLang.add(new Option(obj.name, code));
            });
            els.sourceLang.value = "vi-VN";
            els.targetLang.value = "en-GB";
            setupEventListeners();
        }

        function setupEventListeners() {
            els.saveKeyBtn.addEventListener('click', () => {
                const newKey = els.apiKeyInput.value.trim();
                if (newKey && newKey.startsWith('AIza')) {
                    localStorage.setItem('GEMINI_API_KEY', newKey);
                    apiKey = newKey;
                    showStatus("ƒê√£ l∆∞u API Key th√†nh c√¥ng!", "success");
                    els.apiSetup.classList.add('opacity-50');
                } else {
                    showStatus("API Key kh√¥ng h·ª£p l·ªá.", "error");
                }
            });

            els.inputText.addEventListener('input', () => {
                clearTimeout(translationTimeout);
                translationTimeout = setTimeout(translate, 600);
            });

            els.swapBtn.addEventListener('click', () => {
                const s = els.sourceLang.value;
                els.sourceLang.value = els.targetLang.value;
                els.targetLang.value = s;
                const o = els.outputText.innerText;
                if(o && !o.includes("K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã")) {
                    els.inputText.value = o;
                }
                translate();
            });
            
            els.genderFemale.addEventListener('click', () => setGender('female'));
            els.genderMale.addEventListener('click', () => setGender('male'));

            els.speakSource.addEventListener('click', () => speak(els.inputText.value, els.sourceLang.value, 'source'));
            els.speakTarget.addEventListener('click', () => speak(els.outputText.innerText, els.targetLang.value, 'target'));
        }

        function setGender(g) {
            currentGender = g;
            els.genderFemale.className = g === 'female' ? "px-4 py-2 rounded-lg text-sm font-bold transition-all bg-white text-indigo-600 shadow-md" : "px-4 py-2 rounded-lg text-sm font-bold transition-all text-slate-500";
            els.genderMale.className = g === 'male' ? "px-4 py-2 rounded-lg text-sm font-bold transition-all bg-white text-indigo-600 shadow-md" : "px-4 py-2 rounded-lg text-sm font-bold transition-all text-slate-500";
        }

        async function translate() {
            const text = els.inputText.value.trim();
            if (!text) {
                els.outputText.innerHTML = '<span class="text-slate-300 italic">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</span>';
                return;
            }
            if (!apiKey) return;

            if (abortController) abortController.abort();
            abortController = new AbortController();

            els.loader.classList.remove('hidden');
            els.outputText.classList.add('opacity-40');

            try {
                const data = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        signal: abortController.signal,
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Translate precisely to ${languages[els.targetLang.value].name}: "${text}". Only return translated text.` }] }]
                        })
                    }
                );

                const result = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "";
                els.outputText.innerText = result;
            } catch (err) {
                if (err.name === 'AbortError') return;
                showStatus("D·ªãch thu·∫≠t g·∫∑p s·ª± c·ªë ho·∫∑c qu√° t·∫£i.", "error");
            } finally {
                els.loader.classList.add('hidden');
                els.outputText.classList.remove('opacity-40', 'hidden');
            }
        }

        async function speak(text, langCode, type) {
            if (!text || !apiKey || text.includes("K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã")) return;
            
            // N·∫øu ƒëang n√≥i, h√£y d·ª´ng √¢m thanh hi·ªán t·∫°i tr∆∞·ªõc
            if (isSpeaking && currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                stopSpeakingUI();
            }

            setSpeakingUI(type, true);
            isSpeaking = true;

            try {
                const voiceName = voiceConfigs[currentGender][langCode] || "Kore";
                const cleanText = text.replace(/[*_#`~]/g, '').trim();

                const data = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: cleanText }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { 
                                    voiceConfig: { 
                                        prebuiltVoiceConfig: { voiceName } 
                                    } 
                                }
                            }
                        })
                    }
                );

                const audioPart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                
                if (audioPart && audioPart.inlineData?.data) {
                    const mimeType = audioPart.inlineData.mimeType || "";
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1]) : 24000;

                    const blob = pcmToWav(audioPart.inlineData.data, sampleRate);
                    
                    // Gi·∫£i ph√≥ng URL c≈© n·∫øu c√≥
                    if (currentAudioURL) URL.revokeObjectURL(currentAudioURL);
                    currentAudioURL = URL.createObjectURL(blob);
                    
                    currentAudio = new Audio(currentAudioURL);
                    currentAudio.onended = () => {
                        setSpeakingUI(type, false);
                        isSpeaking = false;
                        URL.revokeObjectURL(currentAudioURL);
                        currentAudioURL = null;
                        currentAudio = null;
                    };
                    
                    currentAudio.onerror = () => {
                        console.error("Audio playback error");
                        handleSpeakError(text, langCode, type);
                    };

                    await currentAudio.play();
                } else {
                    throw new Error("No audio data");
                }
            } catch (err) {
                console.error("TTS Error:", err);
                handleSpeakError(text, langCode, type);
            }
        }

        function handleSpeakError(text, langCode, type) {
            showStatus("ƒêang d√πng gi·ªçng ƒë·ªçc d·ª± ph√≤ng...", "info");
            speakFallback(text, langCode, type);
        }

        function speakFallback(text, langCode, type) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langCode;
            utterance.onend = () => {
                setSpeakingUI(type, false);
                isSpeaking = false;
            };
            utterance.onerror = () => {
                setSpeakingUI(type, false);
                isSpeaking = false;
            };
            window.speechSynthesis.speak(utterance);
        }

        function stopSpeakingUI() {
            setSpeakingUI('source', false);
            setSpeakingUI('target', false);
        }

        function setSpeakingUI(type, active) {
            const btn = type === 'source' ? els.speakSource : els.speakTarget;
            const icon = type === 'source' ? document.getElementById('sourceIcon') : document.getElementById('targetIcon');
            const txt = type === 'source' ? document.getElementById('sourceBtnText') : document.getElementById('targetBtnText');
            if (active) {
                btn.classList.add('bg-indigo-600', 'text-white');
                icon.innerText = "‚è≥"; txt.innerText = "ƒêang ph√°t...";
            } else {
                btn.classList.remove('bg-indigo-600', 'text-white');
                icon.innerText = "üîä"; txt.innerText = type === 'source' ? "Nghe b·∫£n g·ªëc" : "Nghe b·∫£n d·ªãch";
            }
        }

        function showStatus(msg, type) {
            els.errorText.innerText = msg;
            els.errorEmoji.innerText = type === "success" ? "‚úÖ" : (type === "info" ? "‚ÑπÔ∏è" : "‚ö†Ô∏è");
            els.errorMsg.className = `mt-10 p-4 rounded-2xl flex items-center justify-center gap-3 shadow-sm animate-fade-in ${
                type === 'success' ? 'bg-green-50 text-green-700' : 
                (type === 'info' ? 'bg-blue-50 text-blue-700' : 'bg-red-50 text-red-700')
            }`;
            els.errorMsg.classList.remove('hidden');
            setTimeout(() => els.errorMsg.classList.add('hidden'), 4000);
        }

        function pcmToWav(base64, sampleRate) {
            const binary = atob(base64.replace(/\s/g, ''));
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);

            const buffer = new ArrayBuffer(44 + len);
            const view = new DataView(buffer);

            const writeString = (off, s) => { for(let i=0; i<s.length; i++) view.setUint8(off+i, s.charCodeAt(i)); };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + len, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // Byte rate
            view.setUint16(32, 2, true); // Block align
            view.setUint16(34, 16, true); // Bits per sample
            writeString(36, 'data');
            view.setUint32(40, len, true);

            new Uint8Array(buffer, 44).set(bytes);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        init();
    </script>
</body>
</html>
