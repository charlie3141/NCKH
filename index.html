<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Multi-Translator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">AI Multi-Translator Pro</h1>
            <p class="text-slate-500">D·ªãch thu·∫≠t & Ph√°t √¢m chu·∫©n b·∫£n ng·ªØ b·∫±ng Gemini AI</p>
        </header>

        <!-- API Key Setup Section -->
        <div id="apiSetup" class="mb-8 bg-white p-6 rounded-3xl shadow-xl border border-slate-100 animate-fade-in">
            <div class="flex flex-col md:flex-row items-center gap-4">
                <div class="flex-1 w-full">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">C·∫•u h√¨nh Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl focus:border-indigo-400 outline-none transition-all" placeholder="D√°n API Key c·ªßa b·∫°n v√†o ƒë√¢y...">
                </div>
                <button id="saveKeyBtn" class="w-full md:w-auto mt-6 md:mt-0 px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition-all active:scale-95">L∆∞u Key</button>
            </div>
            <p class="mt-3 text-xs text-slate-400 italic">Key ƒë∆∞·ª£c l∆∞u t·∫°i tr√¨nh duy·ªát. L·∫•y Key t·∫°i <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-500 underline">Google AI Studio</a>.</p>
        </div>

        <!-- Control Bar -->
        <div class="bg-white p-6 rounded-3xl shadow-xl mb-8 border border-slate-100">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <select id="sourceLang" class="px-4 py-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-semibold focus:border-indigo-400 outline-none transition-all cursor-pointer">
                    </select>
                    
                    <button id="swapBtn" title="ƒê·ªïi chi·ªÅu" class="w-10 h-10 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-transform active:scale-90">
                        ‚áÑ
                    </button>

                    <select id="targetLang" class="px-4 py-2 border-2 border-slate-100 rounded-xl bg-slate-50 font-semibold focus:border-indigo-400 outline-none transition-all cursor-pointer">
                    </select>
                </div>

                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button id="genderFemale" class="px-4 py-2 rounded-lg text-sm font-bold transition-all bg-white text-indigo-600 shadow-md">üë© N·ªØ</button>
                    <button id="genderMale" class="px-4 py-2 rounded-lg text-sm font-bold transition-all text-slate-500">üë® Nam</button>
                </div>
            </div>
        </div>

        <!-- Main Areas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative">
            
            <!-- Input Section -->
            <div class="relative flex flex-col" id="inputContainer">
                <div class="absolute -top-3 left-6 px-2 bg-white text-xs font-bold text-slate-400 z-10 uppercase tracking-widest">VƒÉn b·∫£n g·ªëc</div>
                <textarea id="inputText" class="w-full h-80 p-6 text-xl border-2 border-slate-100 rounded-3xl focus:border-indigo-500 outline-none shadow-inner bg-white transition-all resize-none" placeholder="Nh·∫≠p n·ªôi dung c·∫ßn d·ªãch..."></textarea>
                
                <button id="speakSource" class="mt-4 w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 bg-white border-2 border-slate-100 text-slate-600 hover:border-indigo-200 shadow-sm disabled:opacity-50">
                    <span id="sourceIcon">üîä</span> <span id="sourceBtnText">Nghe b·∫£n g·ªëc</span>
                </button>
            </div>

            <!-- Output Section -->
            <div class="relative flex flex-col">
                <div class="absolute -top-3 left-6 px-2 bg-white text-xs font-bold text-slate-400 z-10 uppercase tracking-widest">B·∫£n d·ªãch AI</div>
                <div class="w-full h-80 p-6 text-xl border-2 border-slate-100 rounded-3xl bg-slate-50/50 overflow-y-auto shadow-inner relative custom-scrollbar">
                    <div id="loader" class="hidden flex flex-col items-center justify-center h-full gap-4">
                        <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-indigo-600 font-medium animate-pulse text-sm">AI ƒëang x·ª≠ l√Ω nhanh...</span>
                    </div>
                    <div id="outputText" class="text-slate-800 leading-relaxed font-medium whitespace-pre-wrap">
                        <span class="text-slate-300 italic">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</span>
                    </div>
                </div>
                <button id="speakTarget" class="mt-4 w-full py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 bg-white border-2 border-slate-100 text-slate-600 hover:border-indigo-200 shadow-sm disabled:opacity-50">
                    <span id="targetIcon">üîä</span> <span id="targetBtnText">Nghe b·∫£n d·ªãch</span>
                </button>
            </div>
        </div>

        <!-- Error Toast -->
        <div id="errorMsg" class="hidden mt-10 p-4 rounded-2xl flex items-center justify-center gap-3 shadow-sm animate-fade-in">
            <span id="errorEmoji">‚ö†Ô∏è</span> <span id="errorText">L·ªói k·∫øt n·ªëi</span>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('GEMINI_API_KEY') || "";
        let els = {};
        let currentGender = 'female';
        let isSpeaking = false;
        let translationTimeout;
        let abortController = null;
        let audioContext = null;

        const languages = {
            "vi-VN": { name: "Ti·∫øng Vi·ªát", code: "Vietnamese" },
            "en-GB": { name: "Ti·∫øng Anh", code: "English" },
            "ja-JP": { name: "Ti·∫øng Nh·∫≠t", code: "Japanese" },
            "ko-KR": { name: "Ti·∫øng H√†n", code: "Korean" },
            "zh-CN": { name: "Ti·∫øng Trung", code: "Chinese (Simplified)" },
        };

        // B·∫£ng √°nh x·∫° gi·ªçng ƒë·ªçc c·ªë ƒë·ªãnh cho Gemini TTS
        const voiceConfigs = {
            female: { 
                "vi-VN": "Aoede", 
                "en-GB": "Kore", 
                "ja-JP": "Leda", 
                "ko-KR": "Aoede", 
                "zh-CN": "Aoede" 
            },
            male: { 
                "vi-VN": "Charon", 
                "en-GB": "Puck", 
                "ja-JP": "Fenrir", 
                "ko-KR": "Puck", 
                "zh-CN": "Zubenelgenubi" 
            }
        };

        async function fetchWithRetry(url, options, maxRetries = 3) {
            let retries = 0;
            while (retries < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || "L·ªói m·∫°ng");
                    return data;
                } catch (err) {
                    if (err.name === 'AbortError') throw err;
                    retries++;
                    if (retries >= maxRetries) throw err;
                    await new Promise(r => setTimeout(r, 1000 * retries));
                }
            }
        }

        function init() {
            els = {
                sourceLang: document.getElementById('sourceLang'),
                targetLang: document.getElementById('targetLang'),
                swapBtn: document.getElementById('swapBtn'),
                genderFemale: document.getElementById('genderFemale'),
                genderMale: document.getElementById('genderMale'),
                inputText: document.getElementById('inputText'),
                outputText: document.getElementById('outputText'),
                loader: document.getElementById('loader'),
                speakSource: document.getElementById('speakSource'),
                speakTarget: document.getElementById('speakTarget'),
                errorMsg: document.getElementById('errorMsg'),
                errorText: document.getElementById('errorText'),
                errorEmoji: document.getElementById('errorEmoji'),
                apiKeyInput: document.getElementById('apiKeyInput'),
                saveKeyBtn: document.getElementById('saveKeyBtn'),
                apiSetup: document.getElementById('apiSetup'),
                sourceIcon: document.getElementById('sourceIcon'),
                targetIcon: document.getElementById('targetIcon'),
                sourceBtnText: document.getElementById('sourceBtnText'),
                targetBtnText: document.getElementById('targetBtnText')
            };

            if (apiKey) {
                els.apiKeyInput.value = apiKey;
                els.apiSetup.classList.add('opacity-50');
            }

            Object.entries(languages).forEach(([code, obj]) => {
                els.sourceLang.add(new Option(obj.name, code));
                els.targetLang.add(new Option(obj.name, code));
            });
            els.sourceLang.value = "vi-VN";
            els.targetLang.value = "en-GB";

            setupEventListeners();
        }

        function setupEventListeners() {
            els.saveKeyBtn.addEventListener('click', () => {
                const newKey = els.apiKeyInput.value.trim();
                if (newKey) {
                    localStorage.setItem('GEMINI_API_KEY', newKey);
                    apiKey = newKey;
                    showStatus("ƒê√£ l∆∞u API Key!", "success");
                }
            });

            els.inputText.addEventListener('input', () => {
                clearTimeout(translationTimeout);
                translationTimeout = setTimeout(translate, 600);
            });

            els.swapBtn.addEventListener('click', () => {
                const s = els.sourceLang.value;
                els.sourceLang.value = els.targetLang.value;
                els.targetLang.value = s;
                translate();
            });

            els.genderFemale.addEventListener('click', () => setGender('female'));
            els.genderMale.addEventListener('click', () => setGender('male'));

            els.speakSource.addEventListener('click', () => speak(els.inputText.value, els.sourceLang.value, 'source'));
            els.speakTarget.addEventListener('click', () => speak(els.outputText.innerText, els.targetLang.value, 'target'));
        }

        function setGender(g) {
            currentGender = g;
            els.genderFemale.classList.toggle('bg-white', g === 'female');
            els.genderFemale.classList.toggle('text-indigo-600', g === 'female');
            els.genderMale.classList.toggle('bg-white', g === 'male');
            els.genderMale.classList.toggle('text-indigo-600', g === 'male');
        }

        async function translate() {
            const text = els.inputText.value.trim();
            if (!text || !apiKey) return;

            if (abortController) abortController.abort();
            abortController = new AbortController();

            els.loader.classList.remove('hidden');
            els.outputText.classList.add('opacity-40');

            try {
                const data = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        signal: abortController.signal,
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `D·ªãch sang ${languages[els.targetLang.value].name}: "${text}". Ch·ªâ tr·∫£ v·ªÅ k·∫øt qu·∫£.` }] }]
                        })
                    }
                );
                els.outputText.innerText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "";
            } catch (err) {
                if (err.name !== 'AbortError') showStatus("L·ªói d·ªãch thu·∫≠t", "error");
            } finally {
                els.loader.classList.add('hidden');
                els.outputText.classList.remove('opacity-40');
            }
        }

        async function speak(text, langCode, type) {
            if (!text || !apiKey || isSpeaking) return;

            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();

            setSpeakingUI(type, true);
            isSpeaking = true;

            try {
                // Ch·ªçn ch√≠nh x√°c t√™n gi·ªçng ƒë·ªçc d·ª±a tr√™n b·∫£ng c·∫•u h√¨nh
                const voiceName = voiceConfigs[currentGender][langCode] || (currentGender === 'female' ? "Aoede" : "Charon");
                
                // Prompt c·ª±c k·ª≥ c·ª• th·ªÉ ƒë·ªÉ Gemini kh√¥ng d√πng gi·ªçng m·∫∑c ƒë·ªãnh ti·∫øng Anh
                const promptText = `Voice setting: ${currentGender}, Language: ${languages[langCode].code}. 
                Action: Speak the following text naturally in ${languages[langCode].name}.
                Text: "${text.substring(0, 500)}"`;

                const response = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptText }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { 
                                    voiceConfig: { 
                                        prebuiltVoiceConfig: { 
                                            voiceName: voiceName 
                                        } 
                                    } 
                                }
                            }
                        })
                    }
                );

                const base64Data = response.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (!base64Data) throw new Error("No audio data");

                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);

                const audioBuffer = await audioContext.decodeAudioData(bytes.buffer);
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                
                source.onended = () => {
                    setSpeakingUI(type, false);
                    isSpeaking = false;
                };
                
                source.start(0);
            } catch (err) {
                console.error("TTS Error:", err);
                showStatus("L·ªói ph√°t √¢m thanh. Vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi.", "error");
                setSpeakingUI(type, false);
                isSpeaking = false;
            }
        }

        function setSpeakingUI(type, active) {
            const btn = type === 'source' ? els.speakSource : els.speakTarget;
            const icon = type === 'source' ? els.sourceIcon : els.targetIcon;
            const txt = type === 'source' ? els.sourceBtnText : els.targetBtnText;
            btn.classList.toggle('bg-indigo-600', active);
            btn.classList.toggle('text-white', active);
            icon.innerText = active ? "‚è≥" : "üîä";
            txt.innerText = active ? "ƒêang ph√°t..." : (type === 'source' ? "Nghe b·∫£n g·ªëc" : "Nghe b·∫£n d·ªãch");
        }

        function showStatus(msg, type) {
            els.errorText.innerText = msg;
            els.errorMsg.classList.remove('hidden');
            setTimeout(() => els.errorMsg.classList.add('hidden'), 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
